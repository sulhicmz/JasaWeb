---
import Layout from '../../layouts/Layout.astro';
import ProjectHeader from '../../components/projects/ProjectHeader.astro';
import MilestoneTimeline from '../../components/projects/MilestoneTimeline.astro';
import ProjectFiles from '../../components/projects/ProjectFiles.astro';
import ProjectTickets from '../../components/projects/ProjectTickets.astro';
import ProjectActivity from '../../components/projects/ProjectActivity.astro';
import ProjectMetrics from '../../components/projects/ProjectMetrics.astro';

export interface Props {
  projectId: string;
}

const { projectId } = Astro.props;
---

<Layout title={`Project Details - ${projectId}`}>
  <div class="min-h-screen bg-slate-950">
    <!-- Project Header -->
    <section class="border-b border-slate-800 bg-slate-900/50 backdrop-blur-sm sticky top-0 z-40">
      <ProjectHeader client:load projectId={projectId} />
    </section>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-8">
      <!-- Project Metrics Overview -->
      <section class="mb-8">
        <ProjectMetrics client:load projectId={projectId} />
      </section>

      <!-- Milestone Timeline -->
      <section class="mb-8">
        <div class="glass-panel p-6 rounded-xl">
          <div class="flex items-center justify-between mb-6">
            <h2 class="text-2xl font-bold text-white">Milestone Timeline</h2>
            <button class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors duration-200 flex items-center space-x-2">
              <i class="fas fa-plus"></i>
              <span>Add Milestone</span>
            </button>
          </div>
          <MilestoneTimeline client:load projectId={projectId} />
        </div>
      </section>

      <!-- Grid Layout for Files, Tickets, and Activity -->
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Project Files (2/3 width on large screens) -->
        <section class="lg:col-span-2">
          <div class="glass-panel p-6 rounded-xl">
            <div class="flex items-center justify-between mb-6">
              <h2 class="text-xl font-bold text-white">Project Files</h2>
              <button class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg transition-colors duration-200 flex items-center space-x-2">
                <i class="fas fa-upload"></i>
                <span>Upload File</span>
              </button>
            </div>
            <ProjectFiles client:load projectId={projectId} />
          </div>
        </section>

        <!-- Project Tickets (1/3 width on large screens) -->
        <section>
          <div class="glass-panel p-6 rounded-xl">
            <div class="flex items-center justify-between mb-6">
              <h2 class="text-xl font-bold text-white">Active Tickets</h2>
              <button class="px-4 py-2 bg-yellow-600 hover:bg-yellow-700 text-white rounded-lg transition-colors duration-200 flex items-center space-x-2">
                <i class="fas fa-plus"></i>
                <span>New</span>
              </button>
            </div>
            <ProjectTickets client:load projectId={projectId} />
          </div>
        </section>
      </div>

      <!-- Project Activity Feed -->
      <section class="mt-8">
        <div class="glass-panel p-6 rounded-xl">
          <div class="flex items-center justify-between mb-6">
            <h2 class="text-xl font-bold text-white">Recent Activity</h2>
            <div class="flex items-center space-x-2">
              <button class="px-3 py-1 bg-slate-700 hover:bg-slate-600 text-gray-300 rounded-lg transition-colors duration-200 text-sm">
                <i class="fas fa-filter mr-2"></i>
                Filter
              </button>
              <button class="px-3 py-1 bg-slate-700 hover:bg-slate-600 text-gray-300 rounded-lg transition-colors duration-200 text-sm">
                <i class="fas fa-download mr-2"></i>
                Export
              </button>
            </div>
          </div>
          <ProjectActivity client:load projectId={projectId} />
        </div>
      </section>
    </main>

    <!-- Floating Action Buttons -->
    <div class="fixed bottom-8 right-8 flex flex-col space-y-3">
      <button class="w-14 h-14 bg-blue-600 hover:bg-blue-700 text-white rounded-full shadow-lg hover:shadow-blue-500/50 transition-all duration-300 flex items-center justify-center group">
        <i class="fas fa-comment-dots text-xl"></i>
        <span class="absolute right-full mr-3 px-3 py-1 bg-gray-800 text-white text-sm rounded-lg opacity-0 group-hover:opacity-100 transition-opacity duration-200 whitespace-nowrap">
          Start Discussion
        </span>
      </button>
      <button class="w-14 h-14 bg-green-600 hover:bg-green-700 text-white rounded-full shadow-lg hover:shadow-green-500/50 transition-all duration-300 flex items-center justify-center group">
        <i class="fas fa-video text-xl"></i>
        <span class="absolute right-full mr-3 px-3 py-1 bg-gray-800 text-white text-sm rounded-lg opacity-0 group-hover:opacity-100 transition-opacity duration-200 whitespace-nowrap">
          Schedule Meeting
        </span>
      </button>
      <button class="w-14 h-14 bg-purple-600 hover:bg-purple-700 text-white rounded-full shadow-lg hover:shadow-purple-500/50 transition-all duration-300 flex items-center justify-center group">
        <i class="fas fa-download text-xl"></i>
        <span class="absolute right-full mr-3 px-3 py-1 bg-gray-800 text-white text-sm rounded-lg opacity-0 group-hover:opacity-100 transition-opacity duration-200 whitespace-nowrap">
          Download Report
        </span>
      </button>
    </div>
  </div>

  <script>
    // Enhanced project management functionality
    let projectId = '{{projectId}}';
    let refreshInterval;
    let realTimeUpdates = true;

    // Initialize project management features
    document.addEventListener('DOMContentLoaded', () => {
      initializeProjectManagement();
      startAutoRefresh();
      setupRealTimeUpdates();
      setupKeyboardShortcuts();
    });

    function initializeProjectManagement() {
      // Set up project navigation
      setupProjectNavigation();
      
      // Initialize milestone drag-and-drop
      initializeMilestoneDragDrop();
      
      // Set up file upload
      initializeFileUpload();
      
      // Initialize ticket management
      initializeTicketManagement();
    }

    function setupProjectNavigation() {
      // Add breadcrumb navigation
      const breadcrumbs = [
        { label: 'Dashboard', href: '/dashboard' },
        { label: 'Projects', href: '/projects' },
        { label: projectId, href: `/projects/${projectId}`, active: true }
      ];

      // Update navigation if breadcrumb component exists
      const breadcrumbEl = document.querySelector('[data-breadcrumb]');
      if (breadcrumbEl) {
        breadcrumbEl.innerHTML = breadcrumbs.map(crumb => 
          crumb.active 
            ? `<span class="text-blue-400">${crumb.label}</span>`
            : `<a href="${crumb.href}" class="text-gray-400 hover:text-white transition-colors">${crumb.label}</a>`
        ).join(' <span class="text-gray-600">/</span> ');
      }
    }

    function initializeMilestoneDragDrop() {
      const milestones = document.querySelectorAll('[data-milestone]');
      const timeline = document.querySelector('[data-milestone-timeline]');

      if (!milestones.length || !timeline) return;

      milestones.forEach(milestone => {
        milestone.draggable = true;
        
        milestone.addEventListener('dragstart', (e) => {
          e.dataTransfer.setData('text/plain', milestone.dataset.milestone);
          milestone.classList.add('opacity-50');
        });

        milestone.addEventListener('dragend', (e) => {
          milestone.classList.remove('opacity-50');
        });

        milestone.addEventListener('dragover', (e) => {
          e.preventDefault();
          milestone.classList.add('border-blue-500');
        });

        milestone.addEventListener('dragleave', (e) => {
          milestone.classList.remove('border-blue-500');
        });

        milestone.addEventListener('drop', (e) => {
          e.preventDefault();
          const draggedId = e.dataTransfer.getData('text/plain');
          const targetId = milestone.dataset.milestone;
          
          if (draggedId !== targetId) {
            // Reorder milestones
            reorderMilestones(draggedId, targetId);
          }
          
          milestone.classList.remove('border-blue-500');
        });
      });
    }

    function initializeFileUpload() {
      const uploadArea = document.querySelector('[data-file-upload]');
      const fileInput = document.querySelector('[data-file-input]');

      if (!uploadArea || !fileInput) return;

      // Drag and drop for files
      uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.classList.add('border-blue-500', 'bg-blue-500/10');
      });

      uploadArea.addEventListener('dragleave', (e) => {
        e.preventDefault();
        uploadArea.classList.remove('border-blue-500', 'bg-blue-500/10');
      });

      uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.classList.remove('border-blue-500', 'bg-blue-500/10');
        
        const files = Array.from(e.dataTransfer.files);
        handleFileUpload(files);
      });

      // Click to upload
      uploadArea.addEventListener('click', () => {
        fileInput.click();
      });

      fileInput.addEventListener('change', (e) => {
        const files = Array.from(e.target.files);
        handleFileUpload(files);
      });
    }

    function handleFileUpload(files) {
      if (files.length === 0) return;

      // Show upload progress
      showUploadProgress(files);

      // Simulate file upload (replace with actual API call)
      files.forEach((file, index) => {
        setTimeout(() => {
          updateUploadProgress(file.name, 100);
          addFileToList(file);
        }, (index + 1) * 1000);
      });
    }

    function showUploadProgress(files) {
      const progressContainer = document.querySelector('[data-upload-progress]');
      if (!progressContainer) return;

      progressContainer.innerHTML = files.map(file => `
        <div class="flex items-center justify-between p-3 bg-slate-800 rounded-lg mb-2" data-progress="${file.name}">
          <div class="flex items-center space-x-3">
            <i class="fas fa-file text-blue-400"></i>
            <span class="text-white text-sm">${file.name}</span>
          </div>
          <div class="flex items-center space-x-3">
            <div class="w-32 bg-slate-700 rounded-full h-2">
              <div class="bg-blue-500 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
            </div>
            <span class="text-gray-400 text-xs">0%</span>
          </div>
        </div>
      `).join('');
    }

    function updateUploadProgress(filename, progress) {
      const progressEl = document.querySelector(`[data-progress="${filename}"]`);
      if (!progressEl) return;

      const progressBar = progressEl.querySelector('.bg-blue-500');
      const progressText = progressEl.querySelector('.text-gray-400');
      
      progressBar.style.width = `${progress}%`;
      progressText.textContent = `${progress}%`;

      if (progress === 100) {
        setTimeout(() => {
          progressEl.remove();
        }, 2000);
      }
    }

    function addFileToList(file) {
      const fileList = document.querySelector('[data-file-list]');
      if (!fileList) return;

      const fileItem = document.createElement('div');
      fileItem.className = 'flex items-center justify-between p-3 bg-slate-800 rounded-lg hover:bg-slate-700 transition-colors';
      fileItem.innerHTML = `
        <div class="flex items-center space-x-3">
          <i class="fas fa-file text-blue-400"></i>
          <div>
            <p class="text-white text-sm font-medium">${file.name}</p>
            <p class="text-gray-400 text-xs">${formatFileSize(file.size)}</p>
          </div>
        </div>
        <div class="flex items-center space-x-2">
          <button class="p-2 text-gray-400 hover:text-white transition-colors">
            <i class="fas fa-download"></i>
          </button>
          <button class="p-2 text-gray-400 hover:text-red-400 transition-colors">
            <i class="fas fa-trash"></i>
          </button>
        </div>
      `;

      fileList.insertBefore(fileItem, fileList.firstChild);
    }

    function formatFileSize(bytes) {
      if (bytes === 0) return '0 Bytes';
      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    function initializeTicketManagement() {
      const ticketForm = document.querySelector('[data-ticket-form]');
      const ticketList = document.querySelector('[data-ticket-list]');

      if (ticketForm) {
        ticketForm.addEventListener('submit', (e) => {
          e.preventDefault();
          createNewTicket(ticketForm);
        });
      }

      // Set up ticket status updates
      document.addEventListener('click', (e) => {
        if (e.target.matches('[data-ticket-status]')) {
          updateTicketStatus(e.target.dataset.ticketStatus, e.target.dataset.newStatus);
        }
      });
    }

    function createNewTicket(form) {
      const formData = new FormData(form);
      const ticketData = Object.fromEntries(formData.entries());

      // Show loading state
      const submitBtn = form.querySelector('button[type="submit"]');
      const originalText = submitBtn.innerHTML;
      submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Creating...';
      submitBtn.disabled = true;

      // Simulate API call (replace with actual API call)
      setTimeout(() => {
        addTicketToList(ticketData);
        form.reset();
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
        
        // Show success notification
        showNotification('Ticket created successfully', 'success');
      }, 1500);
    }

    function addTicketToList(ticketData) {
      const ticketList = document.querySelector('[data-ticket-list]');
      if (!ticketList) return;

      const ticketItem = document.createElement('div');
      ticketItem.className = 'p-4 bg-slate-800 rounded-lg border-l-4 border-yellow-500';
      ticketItem.innerHTML = `
        <div class="flex items-start justify-between">
          <div class="flex-1">
            <h4 class="text-white font-medium">${ticketData.title}</h4>
            <p class="text-gray-400 text-sm mt-1">${ticketData.description}</p>
            <div class="flex items-center space-x-4 mt-3">
              <span class="px-2 py-1 bg-yellow-500/20 text-yellow-300 text-xs rounded-full">
                ${ticketData.priority}
              </span>
              <span class="text-gray-500 text-xs">
                <i class="fas fa-clock mr-1"></i>
                Just now
              </span>
            </div>
          </div>
          <button class="ml-4 p-2 text-gray-400 hover:text-white transition-colors">
            <i class="fas fa-ellipsis-v"></i>
          </button>
        </div>
      `;

      ticketList.insertBefore(ticketItem, ticketList.firstChild);
    }

    function updateTicketStatus(ticketId, newStatus) {
      // Update ticket status (replace with actual API call)
      console.log(`Updating ticket ${ticketId} to ${newStatus}`);
      showNotification('Ticket status updated', 'success');
    }

    function startAutoRefresh() {
      refreshInterval = setInterval(() => {
        if (!realTimeUpdates) {
          refreshProjectData();
        }
      }, 30000); // Refresh every 30 seconds
    }

    function setupRealTimeUpdates() {
      // Listen for real-time updates
      window.addEventListener('project-update', (e) => {
        if (e.detail.projectId === projectId) {
          updateProjectData(e.detail.data);
        }
      });

      window.addEventListener('milestone-update', (e) => {
        if (e.detail.projectId === projectId) {
          updateMilestoneData(e.detail.data);
        }
      });

      window.addEventListener('ticket-update', (e) => {
        if (e.detail.projectId === projectId) {
          updateTicketData(e.detail.data);
        }
      });
    }

    function refreshProjectData() {
      // Refresh project data (replace with actual API call)
      console.log('Refreshing project data...');
    }

    function updateProjectData(data) {
      // Update project metrics and UI
      console.log('Updating project data:', data);
    }

    function updateMilestoneData(data) {
      // Update milestone timeline
      console.log('Updating milestone data:', data);
    }

    function updateTicketData(data) {
      // Update ticket list
      console.log('Updating ticket data:', data);
    }

    function setupKeyboardShortcuts() {
      document.addEventListener('keydown', (e) => {
        // Ctrl/Cmd + K: Quick search
        if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
          e.preventDefault();
          openQuickSearch();
        }

        // Ctrl/Cmd + N: New item
        if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
          e.preventDefault();
          openNewItemModal();
        }

        // Escape: Close modals
        if (e.key === 'Escape') {
          closeAllModals();
        }
      });
    }

    function openQuickSearch() {
      // Implement quick search functionality
      console.log('Opening quick search...');
    }

    function openNewItemModal() {
      // Implement new item modal
      console.log('Opening new item modal...');
    }

    function closeAllModals() {
      // Close all open modals
      document.querySelectorAll('.modal').forEach(modal => {
        modal.remove();
      });
    }

    function showNotification(message, type = 'info') {
      // Create notification element
      const notification = document.createElement('div');
      notification.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg transform transition-all duration-300 translate-x-full`;
      
      const colors = {
        success: 'bg-green-500',
        error: 'bg-red-500',
        warning: 'bg-yellow-500',
        info: 'bg-blue-500'
      };

      notification.classList.add(colors[type] || colors.info);
      notification.innerHTML = `
        <div class="flex items-center space-x-3 text-white">
          <i class="fas fa-${type === 'success' ? 'check' : type === 'error' ? 'exclamation' : 'info'}-circle"></i>
          <span>${message}</span>
          <button class="ml-4 text-white hover:text-gray-200" onclick="this.parentElement.parentElement.remove()">
            <i class="fas fa-times"></i>
          </button>
        </div>
      `;

      document.body.appendChild(notification);

      // Animate in
      setTimeout(() => {
        notification.classList.remove('translate-x-full');
        notification.classList.add('translate-x-0');
      }, 100);

      // Auto remove after 5 seconds
      setTimeout(() => {
        if (notification.parentElement) {
          notification.classList.add('translate-x-full');
          setTimeout(() => notification.remove(), 300);
        }
      }, 5000);
    }

    function reorderMilestones(draggedId, targetId) {
      // Reorder milestones (replace with actual API call)
      console.log(`Reordering milestone ${draggedId} to position of ${targetId}`);
      showNotification('Milestone order updated', 'success');
    }

    // Cleanup on page unload
    window.addEventListener('beforeunload', () => {
      if (refreshInterval) {
        clearInterval(refreshInterval);
      }
    });
  </script>
</Layout>