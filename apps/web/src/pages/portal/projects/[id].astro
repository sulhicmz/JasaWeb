---
// src/pages/portal/projects/[id].astro
import Layout from '../../../layouts/Layout.astro';
import DashboardHeader from '../../../components/portal/DashboardHeader.astro';

export interface Props {
  title?: string;
}

const { title } = Astro.props;
---

<Layout title="Project Details - Client Portal">
  <div class="min-h-screen bg-gray-50">
    <DashboardHeader />
    
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
      <!-- Page Header -->
      <div class="mb-8 flex justify-between items-center">
        <div class="flex items-center space-x-4">
          <button onclick="window.location.href='/portal/projects'" class="text-indigo-600 hover:text-indigo-800 font-medium">
            ‚Üê Back to Projects
          </button>
          <div class="h-6 w-px bg-gray-300"></div>
          <div>
            <h1 id="project-title" class="text-3xl font-bold text-gray-900">Loading Project...</h1>
            <p id="project-description" class="mt-1 text-gray-600">Loading project details...</p>
          </div>
        </div>
        <div class="flex space-x-3">
          <button id="edit-project-btn" onclick="editProject()" class="px-4 py-2 border border-gray-300 rounded-md hover:bg-gray-50 text-sm font-medium text-gray-700">
            Edit Project
          </button>
          <button id="add-milestone-btn" onclick="openMilestoneModal()" class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700 text-sm font-medium">
            Add Milestone
          </button>
        </div>
      </div>

      <!-- Project Status and Progress -->
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
        <!-- Project Status Card -->
        <div class="bg-white rounded-lg shadow p-6">
          <h3 class="text-lg font-medium text-gray-900 mb-4">Project Status</h3>
          <div class="space-y-4">
            <div>
              <label class="text-sm font-medium text-gray-500">Current Status</label>
              <div class="mt-1">
                <span id="project-status" class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-gray-100 text-gray-800">
                  Loading...
                </span>
              </div>
            </div>
            <div>
              <label class="text-sm font-medium text-gray-500">Progress</label>
              <div class="mt-2">
                <div class="flex justify-between text-sm text-gray-600 mb-1">
                  <span>Overall Progress</span>
                  <span id="progress-percentage">0%</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2">
                  <div id="progress-bar" class="bg-indigo-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Timeline Card -->
        <div class="bg-white rounded-lg shadow p-6">
          <h3 class="text-lg font-medium text-gray-900 mb-4">Timeline</h3>
          <div class="space-y-3">
            <div>
              <label class="text-sm font-medium text-gray-500">Start Date</label>
              <p id="project-start-date" class="mt-1 text-sm text-gray-900">Not set</p>
            </div>
            <div>
              <label class="text-sm font-medium text-gray-500">Due Date</label>
              <p id="project-due-date" class="mt-1 text-sm text-gray-900">Not set</p>
            </div>
            <div>
              <label class="text-sm font-medium text-gray-500">Last Updated</label>
              <p id="project-updated-date" class="mt-1 text-sm text-gray-900">Loading...</p>
            </div>
          </div>
        </div>

        <!-- Quick Stats Card -->
        <div class="bg-white rounded-lg shadow p-6">
          <h3 class="text-lg font-medium text-gray-900 mb-4">Quick Stats</h3>
          <div class="grid grid-cols-2 gap-4">
            <div class="text-center">
              <div id="total-milestones" class="text-2xl font-bold text-indigo-600">0</div>
              <div class="text-sm text-gray-500">Milestones</div>
            </div>
            <div class="text-center">
              <div id="completed-milestones" class="text-2xl font-bold text-green-600">0</div>
              <div class="text-sm text-gray-500">Completed</div>
            </div>
            <div class="text-center">
              <div id="total-tasks" class="text-2xl font-bold text-blue-600">0</div>
              <div class="text-sm text-gray-500">Tasks</div>
            </div>
            <div class="text-center">
              <div id="pending-approvals" class="text-2xl font-bold text-yellow-600">0</div>
              <div class="text-sm text-gray-500">Pending</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Milestones Section -->
      <div class="bg-white rounded-lg shadow mb-8">
        <div class="px-6 py-4 border-b border-gray-200">
          <div class="flex justify-between items-center">
            <h2 class="text-lg font-medium text-gray-900">Milestones</h2>
            <button onclick="openMilestoneModal()" class="text-indigo-600 hover:text-indigo-800 text-sm font-medium">
              + Add Milestone
            </button>
          </div>
        </div>
        <div class="p-6">
          <!-- Loading State -->
          <div id="milestones-loading" class="text-center py-8">
            <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600"></div>
            <p class="mt-2 text-gray-500">Loading milestones...</p>
          </div>

          <!-- Milestones List -->
          <div id="milestones-list" class="space-y-4 hidden">
            <!-- Milestones will be dynamically inserted here -->
          </div>

          <!-- Empty State -->
          <div id="milestones-empty" class="text-center py-8 hidden">
            <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
            </svg>
            <p class="mt-2 text-gray-500">No milestones yet</p>
            <button onclick="openMilestoneModal()" class="mt-4 bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700">
              Create First Milestone
            </button>
          </div>
        </div>
      </div>

      <!-- Tasks Section -->
      <div class="bg-white rounded-lg shadow mb-8">
        <div class="px-6 py-4 border-b border-gray-200">
          <div class="flex justify-between items-center">
            <h2 class="text-lg font-medium text-gray-900">Tasks</h2>
            <button onclick="openTaskModal()" class="text-indigo-600 hover:text-indigo-800 text-sm font-medium">
              + Add Task
            </button>
          </div>
        </div>
        <div class="p-6">
          <!-- Loading State -->
          <div id="tasks-loading" class="text-center py-8">
            <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600"></div>
            <p class="mt-2 text-gray-500">Loading tasks...</p>
          </div>

          <!-- Tasks Kanban Board -->
          <div id="tasks-board" class="grid grid-cols-1 md:grid-cols-3 gap-6 hidden">
            <!-- Todo Column -->
            <div class="bg-gray-50 rounded-lg p-4">
              <h3 class="font-medium text-gray-900 mb-3">To Do</h3>
              <div id="todo-tasks" class="space-y-2">
                <!-- Tasks will be dynamically inserted here -->
              </div>
            </div>

            <!-- In Progress Column -->
            <div class="bg-blue-50 rounded-lg p-4">
              <h3 class="font-medium text-blue-900 mb-3">In Progress</h3>
              <div id="inprogress-tasks" class="space-y-2">
                <!-- Tasks will be dynamically inserted here -->
              </div>
            </div>

            <!-- Completed Column -->
            <div class="bg-green-50 rounded-lg p-4">
              <h3 class="font-medium text-green-900 mb-3">Completed</h3>
              <div id="completed-tasks" class="space-y-2">
                <!-- Tasks will be dynamically inserted here -->
              </div>
            </div>
          </div>

          <!-- Empty State -->
          <div id="tasks-empty" class="text-center py-8 hidden">
            <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" />
            </svg>
            <p class="mt-2 text-gray-500">No tasks yet</p>
            <button onclick="openTaskModal()" class="mt-4 bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700">
              Create First Task
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Milestone Modal -->
  <div id="milestone-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
      <div class="mt-3">
        <h3 class="text-lg font-medium text-gray-900 mb-4">Add Milestone</h3>
        <form id="milestone-form">
          <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-2">Title</label>
            <input type="text" id="milestone-title" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
          </div>
          <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-2">Due Date</label>
            <input type="date" id="milestone-due-date" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
          </div>
          <div class="flex justify-end space-x-3">
            <button type="button" onclick="closeMilestoneModal()" class="px-4 py-2 border border-gray-300 rounded-md hover:bg-gray-50 text-sm font-medium text-gray-700">
              Cancel
            </button>
            <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700 text-sm font-medium">
              Add Milestone
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Task Modal -->
  <div id="task-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
      <div class="mt-3">
        <h3 class="text-lg font-medium text-gray-900 mb-4">Add Task</h3>
        <form id="task-form">
          <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-2">Title</label>
            <input type="text" id="task-title" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
          </div>
          <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
            <textarea id="task-description" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"></textarea>
          </div>
          <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
            <select id="task-status" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
              <option value="todo">To Do</option>
              <option value="in-progress">In Progress</option>
              <option value="completed">Completed</option>
            </select>
          </div>
          <div class="flex justify-end space-x-3">
            <button type="button" onclick="closeTaskModal()" class="px-4 py-2 border border-gray-300 rounded-md hover:bg-gray-50 text-sm font-medium text-gray-700">
              Cancel
            </button>
            <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700 text-sm font-medium">
              Add Task
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script client:load>
    // API configuration
    const API_BASE_URL = 'http://localhost:3001';
    
    // Get project ID from URL
    const projectId = window.location.pathname.split('/').pop();

    // Check authentication
    const isAuthenticated = localStorage.getItem('authToken');
    if (!isAuthenticated) {
      window.location.href = '/login?redirect=' + encodeURIComponent(window.location.pathname);
    }

    // State management
    let currentProject = null;
    let milestones = [];
    let tasks = [];

    // Load project data
    async function loadProject() {
      try {
        const token = localStorage.getItem('authToken');
        const response = await fetch(`${API_BASE_URL}/projects/${projectId}`, {
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });

        if (!response.ok) {
          throw new Error('Failed to fetch project');
        }

        currentProject = await response.json();
        updateProjectUI();
        loadMilestones();
        loadTasks();

      } catch (error) {
        console.error('Error loading project:', error);
        showError('Failed to load project details');
      }
    }

    // Update project UI
    function updateProjectUI() {
      document.getElementById('project-title').textContent = currentProject.name;
      document.getElementById('project-description').textContent = currentProject.description || 'No description';
      
      // Update status
      const statusEl = document.getElementById('project-status');
      statusEl.textContent = currentProject.status || 'Active';
      statusEl.className = `inline-flex items-center px-3 py-1 rounded-full text-sm font-medium ${getStatusColor(currentProject.status)}`;
      
      // Update dates
      document.getElementById('project-start-date').textContent = formatDate(currentProject.startAt) || 'Not set';
      document.getElementById('project-due-date').textContent = formatDate(currentProject.dueAt) || 'Not set';
      document.getElementById('project-updated-date').textContent = formatDate(currentProject.updatedAt);
      
      // Update stats
      updateProjectStats();
    }

    // Update project statistics
    async function updateProjectStats() {
      try {
        const token = localStorage.getItem('authToken');
        const response = await fetch(`${API_BASE_URL}/projects/${projectId}/stats`, {
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });

        if (response.ok) {
          const stats = await response.json();
          
          document.getElementById('total-milestones').textContent = stats.milestoneCount || 0;
          document.getElementById('completed-milestones').textContent = stats.completedMilestones || 0;
          document.getElementById('total-tasks').textContent = stats.taskCount || 0;
          document.getElementById('pending-approvals').textContent = stats.pendingApprovals || 0;
          
          // Update progress
          const progress = stats.progress || 0;
          document.getElementById('progress-percentage').textContent = `${progress}%`;
          document.getElementById('progress-bar').style.width = `${progress}%`;
        }
      } catch (error) {
        console.error('Error loading project stats:', error);
      }
    }

    // Load milestones
    async function loadMilestones() {
      const loadingEl = document.getElementById('milestones-loading');
      const listEl = document.getElementById('milestones-list');
      const emptyEl = document.getElementById('milestones-empty');

      try {
        loadingEl.classList.remove('hidden');
        listEl.classList.add('hidden');
        emptyEl.classList.add('hidden');

        // Milestones are already loaded with project data
        milestones = currentProject.milestones || [];
        
        if (milestones.length === 0) {
          emptyEl.classList.remove('hidden');
        } else {
          listEl.innerHTML = milestones.map(milestone => createMilestoneCard(milestone)).join('');
          listEl.classList.remove('hidden');
        }

      } catch (error) {
        console.error('Error loading milestones:', error);
      } finally {
        loadingEl.classList.add('hidden');
      }
    }

    // Load tasks
    async function loadTasks() {
      const loadingEl = document.getElementById('tasks-loading');
      const boardEl = document.getElementById('tasks-board');
      const emptyEl = document.getElementById('tasks-empty');

      try {
        loadingEl.classList.remove('hidden');
        boardEl.classList.add('hidden');
        emptyEl.classList.add('hidden');

        // Tasks are already loaded with project data
        tasks = currentProject.tasks || [];
        
        if (tasks.length === 0) {
          emptyEl.classList.remove('hidden');
        } else {
          renderTasksBoard();
          boardEl.classList.remove('hidden');
        }

      } catch (error) {
        console.error('Error loading tasks:', error);
      } finally {
        loadingEl.classList.add('hidden');
      }
    }

    // Render tasks board
    function renderTasksBoard() {
      const todoEl = document.getElementById('todo-tasks');
      const inProgressEl = document.getElementById('inprogress-tasks');
      const completedEl = document.getElementById('completed-tasks');

      todoEl.innerHTML = '';
      inProgressEl.innerHTML = '';
      completedEl.innerHTML = '';

      tasks.forEach(task => {
        const taskCard = createTaskCard(task);
        switch (task.status) {
          case 'todo':
            todoEl.innerHTML += taskCard;
            break;
          case 'in-progress':
            inProgressEl.innerHTML += taskCard;
            break;
          case 'completed':
            completedEl.innerHTML += taskCard;
            break;
        }
      });
    }

    // Create milestone card
    function createMilestoneCard(milestone) {
      const statusColor = getMilestoneStatusColor(milestone.status);
      const isOverdue = milestone.dueAt && new Date(milestone.dueAt) < new Date() && milestone.status !== 'completed';
      
      return `
        <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
          <div class="flex justify-between items-start mb-2">
            <h4 class="font-medium text-gray-900">${milestone.title}</h4>
            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${statusColor}">
              ${milestone.status}
            </span>
          </div>
          <div class="flex justify-between items-center text-sm text-gray-500">
            <span>Due: ${formatDate(milestone.dueAt) || 'No due date'}</span>
            ${isOverdue ? '<span class="text-red-600 font-medium">Overdue</span>' : ''}
          </div>
        </div>
      `;
    }

    // Create task card
    function createTaskCard(task) {
      return `
        <div class="bg-white border border-gray-200 rounded-lg p-3 hover:shadow-sm transition-shadow cursor-move">
          <h5 class="font-medium text-gray-900 text-sm mb-1">${task.title}</h5>
          ${task.description ? `<p class="text-xs text-gray-600 mb-2">${task.description}</p>` : ''}
          <div class="flex justify-between items-center">
            <span class="text-xs text-gray-500">${formatDate(task.createdAt)}</span>
            <button onclick="editTask('${task.id}')" class="text-indigo-600 hover:text-indigo-800 text-xs">
              Edit
            </button>
          </div>
        </div>
      `;
    }

    // Get status color
    function getStatusColor(status) {
      switch (status?.toLowerCase()) {
        case 'completed':
          return 'bg-green-100 text-green-800';
        case 'progress':
        case 'in-progress':
          return 'bg-blue-100 text-blue-800';
        case 'review':
          return 'bg-yellow-100 text-yellow-800';
        case 'paused':
        case 'on-hold':
          return 'bg-orange-100 text-orange-800';
        case 'cancelled':
          return 'bg-red-100 text-red-800';
        case 'draft':
          return 'bg-gray-100 text-gray-800';
        default:
          return 'bg-gray-100 text-gray-800';
      }
    }

    // Get milestone status color
    function getMilestoneStatusColor(status) {
      switch (status?.toLowerCase()) {
        case 'completed':
          return 'bg-green-100 text-green-800';
        case 'in-progress':
          return 'bg-blue-100 text-blue-800';
        case 'overdue':
          return 'bg-red-100 text-red-800';
        case 'todo':
          return 'bg-gray-100 text-gray-800';
        default:
          return 'bg-gray-100 text-gray-800';
      }
    }

    // Format date
    function formatDate(dateString) {
      if (!dateString) return null;
      const date = new Date(dateString);
      return date.toLocaleDateString('en-US', { 
        year: 'numeric', 
        month: 'short', 
        day: 'numeric' 
      });
    }

    // Modal functions
    function openMilestoneModal() {
      document.getElementById('milestone-modal').classList.remove('hidden');
    }

    function closeMilestoneModal() {
      document.getElementById('milestone-modal').classList.add('hidden');
      document.getElementById('milestone-form').reset();
    }

    function openTaskModal() {
      document.getElementById('task-modal').classList.remove('hidden');
    }

    function closeTaskModal() {
      document.getElementById('task-modal').classList.add('hidden');
      document.getElementById('task-form').reset();
    }

    // Form submissions
    document.getElementById('milestone-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const title = document.getElementById('milestone-title').value;
      const dueDate = document.getElementById('milestone-due-date').value;
      
      try {
        const token = localStorage.getItem('authToken');
        const response = await fetch(`${API_BASE_URL}/milestones`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            title,
            dueAt: dueDate ? new Date(dueDate).toISOString() : null,
            projectId
          })
        });

        if (response.ok) {
          closeMilestoneModal();
          loadProject(); // Reload project to get updated milestones
        } else {
          throw new Error('Failed to create milestone');
        }
      } catch (error) {
        console.error('Error creating milestone:', error);
        alert('Failed to create milestone');
      }
    });

    document.getElementById('task-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const title = document.getElementById('task-title').value;
      const description = document.getElementById('task-description').value;
      const status = document.getElementById('task-status').value;
      
      try {
        const token = localStorage.getItem('authToken');
        const response = await fetch(`${API_BASE_URL}/tasks`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            title,
            description,
            status,
            projectId
          })
        });

        if (response.ok) {
          closeTaskModal();
          loadProject(); // Reload project to get updated tasks
        } else {
          throw new Error('Failed to create task');
        }
      } catch (error) {
        console.error('Error creating task:', error);
        alert('Failed to create task');
      }
    });

    // Edit project
    function editProject() {
      alert('Edit project functionality coming soon!');
    }

    // Edit task
    function editTask(taskId) {
      alert(`Edit task ${taskId} functionality coming soon!`);
    }

    // Show error
    function showError(message) {
      // Simple error display - could be enhanced with a toast notification
      alert(message);
    }

    // Load project on page load
    document.addEventListener('DOMContentLoaded', loadProject);
  </script>
</Layout>