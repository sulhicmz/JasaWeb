---
interface AnalyticsData {
  trends: {
    projects: any;
    tickets: any;
    milestones: any;
    invoices: any;
  };
  performance: {
    projectPerformance: any;
    ticketResolution: any;
    milestoneCompletion: any;
    invoiceMetrics: any;
  };
  forecast: {
    projectForecast: any;
    milestoneForecast: any;
    invoiceForecast: any;
    resourceForecast: any;
  };
}

interface ChartData {
  labels: string[];
  datasets: {
    label: string;
    data: number[];
    borderColor?: string;
    backgroundColor?: string;
    tension?: number;
    fill?: boolean;
  }[];
}
---

<div class="glass-panel p-6 rounded-xl mb-8">
  <div class="flex items-center justify-between mb-6">
    <h2 class="text-xl font-bold text-white">Advanced Analytics</h2>
    <div class="flex items-center space-x-4">
      <!-- Period Selector -->
      <select id="analyticsPeriod" class="bg-slate-800 text-white px-3 py-2 rounded-lg border border-slate-700 focus:border-blue-500 focus:outline-none">
        <option value="7d">Last 7 days</option>
        <option value="30d" selected>Last 30 days</option>
        <option value="90d">Last 90 days</option>
        <option value="180d">Last 6 months</option>
      </select>
      
      <!-- Metrics Toggle -->
      <div class="flex items-center space-x-2">
        <label class="text-sm text-gray-400">Metrics:</label>
        <div class="flex space-x-2">
          <button class="metric-toggle px-3 py-1 bg-blue-600 text-white rounded-lg text-sm" data-metric="projects">Projects</button>
          <button class="metric-toggle px-3 py-1 bg-slate-700 text-gray-300 rounded-lg text-sm" data-metric="tickets">Tickets</button>
          <button class="metric-toggle px-3 py-1 bg-slate-700 text-gray-300 rounded-lg text-sm" data-metric="milestones">Milestones</button>
          <button class="metric-toggle px-3 py-1 bg-slate-700 text-gray-300 rounded-lg text-sm" data-metric="invoices">Invoices</button>
        </div>
      </div>
      
      <!-- Export Button -->
      <button id="exportAnalytics" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg transition-colors duration-200 flex items-center space-x-2">
        <i class="fas fa-download"></i>
        <span>Export</span>
      </button>
    </div>
  </div>

  <!-- Loading State -->
  <div id="analyticsLoading" class="hidden">
    <div class="flex items-center justify-center py-12">
      <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500"></div>
    </div>
  </div>

  <!-- Analytics Content -->
  <div id="analyticsContent">
    <!-- Trends Section -->
    <section class="mb-8">
      <h3 class="text-lg font-semibold text-white mb-4">Trend Analysis</h3>
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Volume Trends Chart -->
        <div class="bg-slate-800/50 p-4 rounded-lg">
          <h4 class="text-white font-medium mb-3">Volume Trends</h4>
          <canvas id="volumeTrendsChart" width="400" height="200"></canvas>
        </div>
        
        <!-- Cumulative Trends Chart -->
        <div class="bg-slate-800/50 p-4 rounded-lg">
          <h4 class="text-white font-medium mb-3">Cumulative Growth</h4>
          <canvas id="cumulativeTrendsChart" width="400" height="200"></canvas>
        </div>
      </div>
    </section>

    <!-- Performance Metrics Section -->
    <section class="mb-8">
      <h3 class="text-lg font-semibold text-white mb-4">Performance Metrics</h3>
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
        <!-- Project Performance Card -->
        <div class="bg-gradient-to-br from-blue-600/20 to-blue-800/20 p-4 rounded-lg border border-blue-500/30">
          <div class="flex items-center justify-between mb-2">
            <h4 class="text-blue-300 font-medium">Projects</h4>
            <i class="fas fa-project-diagram text-blue-400"></i>
          </div>
          <div class="space-y-2">
            <div class="flex justify-between items-center">
              <span class="text-gray-400 text-sm">On-Time Rate</span>
              <span id="projectOnTimeRate" class="text-white font-semibold">--%</span>
            </div>
            <div class="flex justify-between items-center">
              <span class="text-gray-400 text-sm">Avg Duration</span>
              <span id="projectAvgDuration" class="text-white font-semibold">-- days</span>
            </div>
            <div class="w-full bg-slate-700 rounded-full h-2">
              <div id="projectProgressBar" class="bg-blue-500 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
            </div>
          </div>
        </div>

        <!-- Ticket Performance Card -->
        <div class="bg-gradient-to-br from-green-600/20 to-green-800/20 p-4 rounded-lg border border-green-500/30">
          <div class="flex items-center justify-between mb-2">
            <h4 class="text-green-300 font-medium">Tickets</h4>
            <i class="fas fa-ticket-alt text-green-400"></i>
          </div>
          <div class="space-y-2">
            <div class="flex justify-between items-center">
              <span class="text-gray-400 text-sm">Resolution Rate</span>
              <span id="ticketResolutionRate" class="text-white font-semibold">--%</span>
            </div>
            <div class="flex justify-between items-center">
              <span class="text-gray-400 text-sm">Avg Resolution</span>
              <span id="ticketAvgResolution" class="text-white font-semibold">-- hours</span>
            </div>
            <div class="w-full bg-slate-700 rounded-full h-2">
              <div id="ticketProgressBar" class="bg-green-500 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
            </div>
          </div>
        </div>

        <!-- Milestone Performance Card -->
        <div class="bg-gradient-to-br from-purple-600/20 to-purple-800/20 p-4 rounded-lg border border-purple-500/30">
          <div class="flex items-center justify-between mb-2">
            <h4 class="text-purple-300 font-medium">Milestones</h4>
            <i class="fas fa-flag text-purple-400"></i>
          </div>
          <div class="space-y-2">
            <div class="flex justify-between items-center">
              <span class="text-gray-400 text-sm">Completion Rate</span>
              <span id="milestoneCompletionRate" class="text-white font-semibold">--%</span>
            </div>
            <div class="flex justify-between items-center">
              <span class="text-gray-400 text-sm">On-Time Delivery</span>
              <span id="milestoneOnTimeRate" class="text-white font-semibold">--%</span>
            </div>
            <div class="w-full bg-slate-700 rounded-full h-2">
              <div id="milestoneProgressBar" class="bg-purple-500 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
            </div>
          </div>
        </div>

        <!-- Invoice Performance Card -->
        <div class="bg-gradient-to-br from-yellow-600/20 to-yellow-800/20 p-4 rounded-lg border border-yellow-500/30">
          <div class="flex items-center justify-between mb-2">
            <h4 class="text-yellow-300 font-medium">Invoices</h4>
            <i class="fas fa-file-invoice-dollar text-yellow-400"></i>
          </div>
          <div class="space-y-2">
            <div class="flex justify-between items-center">
              <span class="text-gray-400 text-sm">Paid Rate</span>
              <span id="invoicePaidRate" class="text-white font-semibold">--%</span>
            </div>
            <div class="flex justify-between items-center">
              <span class="text-gray-400 text-sm">Avg Payment</span>
              <span id="invoiceAvgPayment" class="text-white font-semibold">-- days</span>
            </div>
            <div class="w-full bg-slate-700 rounded-full h-2">
              <div id="invoiceProgressBar" class="bg-yellow-500 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Forecast Section -->
    <section class="mb-8">
      <h3 class="text-lg font-semibold text-white mb-4">Forecast Analytics</h3>
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Project Forecast -->
        <div class="bg-slate-800/50 p-4 rounded-lg">
          <h4 class="text-white font-medium mb-3">Project Forecast</h4>
          <div class="space-y-3">
            <div class="flex justify-between items-center">
              <span class="text-gray-400 text-sm">Active Projects</span>
              <span id="forecastActiveProjects" class="text-white font-semibold">--</span>
            </div>
            <div class="flex justify-between items-center">
              <span class="text-gray-400 text-sm">Completing Soon</span>
              <span id="forecastCompletingSoon" class="text-white font-semibold">--</span>
            </div>
            <div class="flex justify-between items-center">
              <span class="text-gray-400 text-sm">Risk Level</span>
              <span id="forecastRiskLevel" class="px-2 py-1 rounded text-xs font-medium">--</span>
            </div>
          </div>
        </div>

        <!-- Milestone Forecast -->
        <div class="bg-slate-800/50 p-4 rounded-lg">
          <h4 class="text-white font-medium mb-3">Milestone Forecast</h4>
          <div class="space-y-3">
            <div class="flex justify-between items-center">
              <span class="text-gray-400 text-sm">Pending</span>
              <span id="forecastPendingMilestones" class="text-white font-semibold">--</span>
            </div>
            <div class="flex justify-between items-center">
              <span class="text-gray-400 text-sm">Overdue</span>
              <span id="forecastOverdueMilestones" class="text-white font-semibold">--</span>
            </div>
            <div class="flex justify-between items-center">
              <span class="text-gray-400 text-sm">Due This Week</span>
              <span id="forecastDueThisWeek" class="text-white font-semibold">--</span>
            </div>
          </div>
        </div>

        <!-- Invoice Forecast -->
        <div class="bg-slate-800/50 p-4 rounded-lg">
          <h4 class="text-white font-medium mb-3">Invoice Forecast</h4>
          <div class="space-y-3">
            <div class="flex justify-between items-center">
              <span class="text-gray-400 text-sm">Pending Amount</span>
              <span id="forecastPendingAmount" class="text-white font-semibold">--</span>
            </div>
            <div class="flex justify-between items-center">
              <span class="text-gray-400 text-sm">Overdue Amount</span>
              <span id="forecastOverdueAmount" class="text-white font-semibold">--</span>
            </div>
            <div class="flex justify-between items-center">
              <span class="text-gray-400 text-sm">Due This Month</span>
              <span id="forecastDueThisMonth" class="text-white font-semibold">--</span>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Resource Utilization -->
    <section>
      <h3 class="text-lg font-semibold text-white mb-4">Resource Utilization</h3>
      <div class="bg-slate-800/50 p-4 rounded-lg">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <div>
            <h4 class="text-white font-medium mb-3">Current Workload</h4>
            <div class="space-y-3">
              <div class="flex justify-between items-center">
                <span class="text-gray-400 text-sm">Total Workload</span>
                <span id="resourceTotalWorkload" class="text-white font-semibold">-- hours</span>
              </div>
              <div class="flex justify-between items-center">
                <span class="text-gray-400 text-sm">Average per Project</span>
                <span id="resourceAvgWorkload" class="text-white font-semibold">-- hours</span>
              </div>
              <div class="flex justify-between items-center">
                <span class="text-gray-400 text-sm">Utilization Rate</span>
                <span id="resourceUtilization" class="text-white font-semibold">--%</span>
              </div>
              <div class="w-full bg-slate-700 rounded-full h-3">
                <div id="resourceUtilizationBar" class="bg-gradient-to-r from-green-500 to-yellow-500 h-3 rounded-full transition-all duration-300" style="width: 0%"></div>
              </div>
            </div>
          </div>
          <div>
            <h4 class="text-white font-medium mb-3">Recommendations</h4>
            <div id="resourceRecommendations" class="space-y-2">
              <div class="p-3 bg-slate-700/50 rounded-lg">
                <p class="text-gray-300 text-sm">Loading recommendations...</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>
  </div>
</div>

<script>
  // Advanced Analytics functionality
  let analyticsData: AnalyticsData | null = null;
  let selectedMetrics = ['projects'];
  let charts: any[] = [];

  // Initialize analytics
  document.addEventListener('DOMContentLoaded', () => {
    initializeAnalytics();
    setupEventListeners();
    loadAnalyticsData();
  });

  function initializeAnalytics() {
    // Load Chart.js if not already loaded
    if (typeof Chart === 'undefined') {
      const script = document.createElement('script');
      script.src = 'https://cdn.jsdelivr.net/npm/chart.js';
      script.onload = () => {
        console.log('Chart.js loaded for analytics');
      };
      document.head.appendChild(script);
    }
  }

  function setupEventListeners() {
    // Period selector
    document.getElementById('analyticsPeriod')?.addEventListener('change', (e) => {
      loadAnalyticsData();
    });

    // Metric toggles
    document.querySelectorAll('.metric-toggle').forEach(button => {
      button.addEventListener('click', (e) => {
        const metric = (e.target as HTMLElement).dataset.metric;
        toggleMetric(metric);
      });
    });

    // Export button
    document.getElementById('exportAnalytics')?.addEventListener('click', exportAnalytics);
  }

  function toggleMetric(metric: string) {
    const button = document.querySelector(`[data-metric="${metric}"]`) as HTMLElement;
    
    if (selectedMetrics.includes(metric)) {
      selectedMetrics = selectedMetrics.filter(m => m !== metric);
      button.classList.remove('bg-blue-600', 'text-white');
      button.classList.add('bg-slate-700', 'text-gray-300');
    } else {
      selectedMetrics.push(metric);
      button.classList.remove('bg-slate-700', 'text-gray-300');
      button.classList.add('bg-blue-600', 'text-white');
    }

    updateCharts();
  }

  async function loadAnalyticsData() {
    const loadingEl = document.getElementById('analyticsLoading');
    const contentEl = document.getElementById('analyticsContent');
    
    loadingEl?.classList.remove('hidden');
    contentEl?.classList.add('hidden');

    try {
      const period = (document.getElementById('analyticsPeriod') as HTMLSelectElement)?.value || '30d';
      const metrics = selectedMetrics.join(',');
      
      const [trendsResponse, performanceResponse, forecastResponse] = await Promise.all([
        fetch(`/api/dashboard/analytics/trends?period=${period}&metrics=${metrics}`, {
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('auth_token')}`
          }
        }),
        fetch(`/api/dashboard/analytics/performance?period=${period}`, {
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('auth_token')}`
          }
        }),
        fetch(`/api/dashboard/analytics/forecast?horizon=30d`, {
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('auth_token')}`
          }
        })
      ]);

      if (!trendsResponse.ok || !performanceResponse.ok || !forecastResponse.ok) {
        throw new Error('Failed to load analytics data');
      }

      const trends = await trendsResponse.json();
      const performance = await performanceResponse.json();
      const forecast = await forecastResponse.json();

      analyticsData = { trends, performance, forecast };
      
      updateAnalyticsDisplay();
      contentEl?.classList.remove('hidden');
    } catch (error) {
      console.error('Error loading analytics:', error);
      showError('Failed to load analytics data');
    } finally {
      loadingEl?.classList.add('hidden');
    }
  }

  function updateAnalyticsDisplay() {
    if (!analyticsData) return;

    updatePerformanceMetrics();
    updateForecastDisplay();
    updateResourceUtilization();
    updateCharts();
  }

  function updatePerformanceMetrics() {
    const { performance } = analyticsData!;

    // Project metrics
    document.getElementById('projectOnTimeRate')!.textContent = `${performance.projectPerformance.onTimeCompletionRate}%`;
    document.getElementById('projectAvgDuration')!.textContent = `${performance.projectPerformance.averageMilestonesPerProject || 0} days`;
    document.getElementById('projectProgressBar')!.style.width = `${performance.projectPerformance.onTimeCompletionRate}%`;

    // Ticket metrics
    document.getElementById('ticketResolutionRate')!.textContent = `${performance.ticketResolution.resolutionRate}%`;
    document.getElementById('ticketAvgResolution')!.textContent = `${performance.ticketResolution.averageResolutionTime} hours`;
    document.getElementById('ticketProgressBar')!.style.width = `${performance.ticketResolution.resolutionRate}%`;

    // Milestone metrics
    document.getElementById('milestoneCompletionRate')!.textContent = `${performance.milestoneCompletion.completedMilestones}%`;
    document.getElementById('milestoneOnTimeRate')!.textContent = `${performance.milestoneCompletion.onTimeDeliveryRate}%`;
    document.getElementById('milestoneProgressBar')!.style.width = `${performance.milestoneCompletion.completedMilestones}%`;

    // Invoice metrics
    document.getElementById('invoicePaidRate')!.textContent = `${performance.invoiceMetrics.paidRate}%`;
    document.getElementById('invoiceAvgPayment')!.textContent = `${performance.invoiceMetrics.averagePaymentTime} days`;
    document.getElementById('invoiceProgressBar')!.style.width = `${performance.invoiceMetrics.paidRate}%`;
  }

  function updateForecastDisplay() {
    const { forecast } = analyticsData!;

    // Project forecast
    document.getElementById('forecastActiveProjects')!.textContent = forecast.projectForecast.activeProjects;
    document.getElementById('forecastCompletingSoon')!.textContent = forecast.projectForecast.projectsCompletingSoon;
    
    const riskEl = document.getElementById('forecastRiskLevel')!;
    riskEl.textContent = forecast.projectForecast.riskLevel;
    riskEl.className = `px-2 py-1 rounded text-xs font-medium ${getRiskLevelClass(forecast.projectForecast.riskLevel)}`;

    // Milestone forecast
    document.getElementById('forecastPendingMilestones')!.textContent = forecast.milestoneForecast.pendingMilestones;
    document.getElementById('forecastOverdueMilestones')!.textContent = forecast.milestoneForecast.overdueMilestones;
    document.getElementById('forecastDueThisWeek')!.textContent = forecast.milestoneForecast.dueThisWeek;

    // Invoice forecast
    document.getElementById('forecastPendingAmount')!.textContent = formatCurrency(forecast.invoiceForecast.totalPendingAmount);
    document.getElementById('forecastOverdueAmount')!.textContent = formatCurrency(forecast.invoiceForecast.overdueAmount);
    document.getElementById('forecastDueThisMonth')!.textContent = formatCurrency(forecast.invoiceForecast.dueThisMonth);
  }

  function updateResourceUtilization() {
    const { forecast } = analyticsData!;
    const resourceData = forecast.resourceForecast;

    document.getElementById('resourceTotalWorkload')!.textContent = `${resourceData.totalWorkload} hours`;
    document.getElementById('resourceAvgWorkload')!.textContent = `${resourceData.averageWorkloadPerProject} hours`;
    document.getElementById('resourceUtilization')!.textContent = `${resourceData.resourceUtilization}%`;
    document.getElementById('resourceUtilizationBar')!.style.width = `${resourceData.resourceUtilization}%`;

    // Update recommendations
    const recommendationsEl = document.getElementById('resourceRecommendations')!;
    recommendationsEl.innerHTML = getRecommendationHTML(resourceData.recommendation);
  }

  function updateCharts() {
    if (!analyticsData || typeof Chart === 'undefined') return;

    // Destroy existing charts
    charts.forEach(chart => chart.destroy());
    charts = [];

    // Create volume trends chart
    const volumeCtx = document.getElementById('volumeTrendsChart') as HTMLCanvasElement;
    if (volumeCtx && selectedMetrics.length > 0) {
      const volumeData = prepareVolumeChartData();
      charts.push(new Chart(volumeCtx, {
        type: 'line',
        data: volumeData,
        options: getChartOptions('Volume Trends')
      }));
    }

    // Create cumulative trends chart
    const cumulativeCtx = document.getElementById('cumulativeTrendsChart') as HTMLCanvasElement;
    if (cumulativeCtx && selectedMetrics.length > 0) {
      const cumulativeData = prepareCumulativeChartData();
      charts.push(new Chart(cumulativeCtx, {
        type: 'line',
        data: cumulativeData,
        options: getChartOptions('Cumulative Growth')
      }));
    }
  }

  function prepareVolumeChartData(): ChartData {
    const { trends } = analyticsData!;
    const colors = {
      projects: { border: 'rgb(59, 130, 246)', bg: 'rgba(59, 130, 246, 0.1)' },
      tickets: { border: 'rgb(34, 197, 94)', bg: 'rgba(34, 197, 94, 0.1)' },
      milestones: { border: 'rgb(168, 85, 247)', bg: 'rgba(168, 85, 247, 0.1)' },
      invoices: { border: 'rgb(250, 204, 21)', bg: 'rgba(250, 204, 21, 0.1)' }
    };

    const datasets = selectedMetrics.map(metric => ({
      label: metric.charAt(0).toUpperCase() + metric.slice(1),
      data: trends[metric]?.daily?.map((d: any) => d.count) || [],
      borderColor: colors[metric as keyof typeof colors].border,
      backgroundColor: colors[metric as keyof typeof colors].bg,
      tension: 0.4,
      fill: true
    }));

    const labels = trends[selectedMetrics[0]]?.daily?.map((d: any) => d.date) || [];

    return { labels, datasets };
  }

  function prepareCumulativeChartData(): ChartData {
    const { trends } = analyticsData!;
    const colors = {
      projects: { border: 'rgb(59, 130, 246)', bg: 'rgba(59, 130, 246, 0.1)' },
      tickets: { border: 'rgb(34, 197, 94)', bg: 'rgba(34, 197, 94, 0.1)' },
      milestones: { border: 'rgb(168, 85, 247)', bg: 'rgba(168, 85, 247, 0.1)' },
      invoices: { border: 'rgb(250, 204, 21)', bg: 'rgba(250, 204, 21, 0.1)' }
    };

    const datasets = selectedMetrics.map(metric => {
      const dailyData = trends[metric]?.daily?.map((d: any) => d.count) || [];
      const cumulativeData = dailyData.reduce((acc: number[], val: number, index: number) => {
        acc.push(index === 0 ? val : acc[index - 1] + val);
        return acc;
      }, []);

      return {
        label: `Cumulative ${metric.charAt(0).toUpperCase() + metric.slice(1)}`,
        data: cumulativeData,
        borderColor: colors[metric as keyof typeof colors].border,
        backgroundColor: colors[metric as keyof typeof colors].bg,
        tension: 0.4,
        fill: false
      };
    });

    const labels = trends[selectedMetrics[0]]?.daily?.map((d: any) => d.date) || [];

    return { labels, datasets };
  }

  function getChartOptions(title: string) {
    return {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          labels: { color: '#fff' }
        },
        title: {
          display: false
        }
      },
      scales: {
        x: {
          ticks: { color: '#9ca3af' },
          grid: { color: 'rgba(75, 85, 99, 0.3)' }
        },
        y: {
          ticks: { color: '#9ca3af' },
          grid: { color: 'rgba(75, 85, 99, 0.3)' }
        }
      }
    };
  }

  function getRiskLevelClass(riskLevel: string) {
    switch (riskLevel) {
      case 'high': return 'bg-red-500/20 text-red-300 border border-red-500/30';
      case 'medium': return 'bg-yellow-500/20 text-yellow-300 border border-yellow-500/30';
      case 'low': return 'bg-green-500/20 text-green-300 border border-green-500/30';
      default: return 'bg-gray-500/20 text-gray-300 border border-gray-500/30';
    }
  }

  function getRecommendationHTML(recommendation: string) {
    const recommendations = {
      'high-priority-hiring-needed': `
        <div class="p-3 bg-red-500/20 border border-red-500/30 rounded-lg">
          <div class="flex items-center space-x-2 mb-1">
            <i class="fas fa-exclamation-triangle text-red-400"></i>
            <span class="text-red-300 font-medium">High Priority - Hiring Needed</span>
          </div>
          <p class="text-gray-300 text-sm">Workload exceeds capacity. Consider hiring additional resources or redistributing projects.</p>
        </div>
      `,
      'consider-resource-allocation': `
        <div class="p-3 bg-yellow-500/20 border border-yellow-500/30 rounded-lg">
          <div class="flex items-center space-x-2 mb-1">
            <i class="fas fa-exclamation-circle text-yellow-400"></i>
            <span class="text-yellow-300 font-medium">Consider Resource Allocation</span>
          </div>
          <p class="text-gray-300 text-sm">Workload is approaching capacity. Monitor project timelines closely.</p>
        </div>
      `,
      'underutilized-capacity': `
        <div class="p-3 bg-blue-500/20 border border-blue-500/30 rounded-lg">
          <div class="flex items-center space-x-2 mb-1">
            <i class="fas fa-info-circle text-blue-400"></i>
            <span class="text-blue-300 font-medium">Underutilized Capacity</span>
          </div>
          <p class="text-gray-300 text-sm">Resources are underutilized. Consider taking on new projects or optimizing current workflows.</p>
        </div>
      `,
      'optimal-resource-utilization': `
        <div class="p-3 bg-green-500/20 border border-green-500/30 rounded-lg">
          <div class="flex items-center space-x-2 mb-1">
            <i class="fas fa-check-circle text-green-400"></i>
            <span class="text-green-300 font-medium">Optimal Resource Utilization</span>
          </div>
          <p class="text-gray-300 text-sm">Resources are well-balanced. Current workload is sustainable.</p>
        </div>
      `
    };

    return recommendations[recommendation as keyof typeof recommendations] || recommendations['optimal-resource-utilization'];
  }

  function formatCurrency(amount: number) {
    return new Intl.NumberFormat('en-US', {
      style: 'currency',
      currency: 'USD'
    }).format(amount);
  }

  function exportAnalytics() {
    if (!analyticsData) {
      showError('No data available to export');
      return;
    }

    const exportData = {
      generatedAt: new Date().toISOString(),
      period: (document.getElementById('analyticsPeriod') as HTMLSelectElement)?.value,
      metrics: selectedMetrics,
      data: analyticsData
    };

    const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `analytics-export-${new Date().toISOString().split('T')[0]}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  function showError(message: string) {
    // Show error notification
    const notification = document.createElement('div');
    notification.className = 'fixed top-4 right-4 z-50 p-4 bg-red-500 text-white rounded-lg shadow-lg';
    notification.innerHTML = `
      <div class="flex items-center space-x-3">
        <i class="fas fa-exclamation-circle"></i>
        <span>${message}</span>
        <button onclick="this.parentElement.parentElement.remove()" class="ml-4">
          <i class="fas fa-times"></i>
        </button>
      </div>
    `;
    document.body.appendChild(notification);
    
    setTimeout(() => notification.remove(), 5000);
  }

  // Listen for real-time updates
  window.addEventListener('dashboard-update', (e: any) => {
    if (e.detail.type === 'stats') {
      loadAnalyticsData();
    }
  });
</script>