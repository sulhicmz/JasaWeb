---
// NotificationPreferences.astro - Notification settings component
---

<div class="glass-panel p-6 rounded-xl">
  <div class="flex items-center justify-between mb-6">
    <h2 class="text-xl font-bold text-white">Notification Preferences</h2>
    <button id="savePreferencesBtn" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm transition-colors duration-200">
      <i class="fas fa-save mr-2"></i>Save Preferences
    </button>
  </div>

  <form id="notificationPreferencesForm" class="space-y-6">
    <!-- Email Notifications -->
    <div class="border-b border-slate-700 pb-6">
      <h3 class="text-lg font-medium text-white mb-4 flex items-center">
        <i class="fas fa-envelope text-blue-400 mr-2"></i>
        Email Notifications
      </h3>
      
      <div class="space-y-3">
        <label class="flex items-center justify-between p-3 bg-slate-800/50 rounded-lg hover:bg-slate-800/70 transition-colors cursor-pointer">
          <div class="flex items-center space-x-3">
            <input type="checkbox" name="email_project_updates" checked class="w-4 h-4 text-blue-600 bg-slate-700 border-slate-600 rounded focus:ring-blue-500 focus:ring-2">
            <div>
              <span class="text-white font-medium">Project Updates</span>
              <p class="text-gray-400 text-sm">Get notified about project status changes</p>
            </div>
          </div>
        </label>

        <label class="flex items-center justify-between p-3 bg-slate-800/50 rounded-lg hover:bg-slate-800/70 transition-colors cursor-pointer">
          <div class="flex items-center space-x-3">
            <input type="checkbox" name="email_ticket_updates" checked class="w-4 h-4 text-blue-600 bg-slate-700 border-slate-600 rounded focus:ring-blue-500 focus:ring-2">
            <div>
              <span class="text-white font-medium">Ticket Updates</span>
              <p class="text-gray-400 text-sm">Receive notifications for ticket status changes</p>
            </div>
          </div>
        </label>

        <label class="flex items-center justify-between p-3 bg-slate-800/50 rounded-lg hover:bg-slate-800/70 transition-colors cursor-pointer">
          <div class="flex items-center space-x-3">
            <input type="checkbox" name="email_invoice_reminders" checked class="w-4 h-4 text-blue-600 bg-slate-700 border-slate-600 rounded focus:ring-blue-500 focus:ring-2">
            <div>
              <span class="text-white font-medium">Invoice Reminders</span>
              <p class="text-gray-400 text-sm">Get reminded about upcoming and overdue invoices</p>
            </div>
          </div>
        </label>

        <label class="flex items-center justify-between p-3 bg-slate-800/50 rounded-lg hover:bg-slate-800/70 transition-colors cursor-pointer">
          <div class="flex items-center space-x-3">
            <input type="checkbox" name="email_milestone_deadlines" checked class="w-4 h-4 text-blue-600 bg-slate-700 border-slate-600 rounded focus:ring-blue-500 focus:ring-2">
            <div>
              <span class="text-white font-medium">Milestone Deadlines</span>
              <p class="text-gray-400 text-sm">Notifications for approaching milestone deadlines</p>
            </div>
          </div>
        </label>
      </div>
    </div>

    <!-- In-App Notifications -->
    <div class="border-b border-slate-700 pb-6">
      <h3 class="text-lg font-medium text-white mb-4 flex items-center">
        <i class="fas fa-bell text-purple-400 mr-2"></i>
        In-App Notifications
      </h3>
      
      <div class="space-y-3">
        <label class="flex items-center justify-between p-3 bg-slate-800/50 rounded-lg hover:bg-slate-800/70 transition-colors cursor-pointer">
          <div class="flex items-center space-x-3">
            <input type="checkbox" name="app_realtime_updates" checked class="w-4 h-4 text-purple-600 bg-slate-700 border-slate-600 rounded focus:ring-purple-500 focus:ring-2">
            <div>
              <span class="text-white font-medium">Real-time Updates</span>
              <p class="text-gray-400 text-sm">Show real-time notifications in the dashboard</p>
            </div>
          </div>
        </label>

        <label class="flex items-center justify-between p-3 bg-slate-800/50 rounded-lg hover:bg-slate-800/70 transition-colors cursor-pointer">
          <div class="flex items-center space-x-3">
            <input type="checkbox" name="app_sound_notifications" class="w-4 h-4 text-purple-600 bg-slate-700 border-slate-600 rounded focus:ring-purple-500 focus:ring-2">
            <div>
              <span class="text-white font-medium">Sound Notifications</span>
              <p class="text-gray-400 text-sm">Play sound for incoming notifications</p>
            </div>
          </div>
        </label>

        <label class="flex items-center justify-between p-3 bg-slate-800/50 rounded-lg hover:bg-slate-800/70 transition-colors cursor-pointer">
          <div class="flex items-center space-x-3">
            <input type="checkbox" name="app_desktop_notifications" class="w-4 h-4 text-purple-600 bg-slate-700 border-slate-600 rounded focus:ring-purple-500 focus:ring-2">
            <div>
              <span class="text-white font-medium">Desktop Notifications</span>
              <p class="text-gray-400 text-sm">Show browser desktop notifications</p>
            </div>
          </div>
        </label>
      </div>
    </div>

    <!-- Notification Frequency -->
    <div>
      <h3 class="text-lg font-medium text-white mb-4 flex items-center">
        <i class="fas fa-clock text-green-400 mr-2"></i>
        Digest Frequency
      </h3>
      
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-medium text-gray-300 mb-2">Email Digest</label>
          <select name="email_digest_frequency" class="w-full px-3 py-2 bg-slate-700 text-white rounded-lg border border-slate-600 focus:border-blue-500 focus:outline-none">
            <option value="never">Never</option>
            <option value="daily" selected>Daily</option>
            <option value="weekly">Weekly</option>
            <option value="monthly">Monthly</option>
          </select>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-300 mb-2">Priority Level</label>
          <select name="notification_priority" class="w-full px-3 py-2 bg-slate-700 text-white rounded-lg border border-slate-600 focus:border-blue-500 focus:outline-none">
            <option value="all">All Notifications</option>
            <option value="important" selected>Important Only</option>
            <option value="critical">Critical Only</option>
          </select>
        </div>
      </div>
    </div>

    <!-- Quiet Hours -->
    <div>
      <h3 class="text-lg font-medium text-white mb-4 flex items-center">
        <i class="fas fa-moon text-yellow-400 mr-2"></i>
        Quiet Hours
      </h3>
      
      <div class="flex items-center space-x-4 mb-4">
        <label class="flex items-center space-x-2">
          <input type="checkbox" name="quiet_hours_enabled" class="w-4 h-4 text-yellow-600 bg-slate-700 border-slate-600 rounded focus:ring-yellow-500 focus:ring-2">
          <span class="text-white font-medium">Enable Quiet Hours</span>
        </label>
      </div>

      <div id="quietHoursSettings" class="grid grid-cols-1 md:grid-cols-2 gap-4 opacity-50 pointer-events-none">
        <div>
          <label class="block text-sm font-medium text-gray-300 mb-2">Start Time</label>
          <input type="time" name="quiet_hours_start" value="22:00" class="w-full px-3 py-2 bg-slate-700 text-white rounded-lg border border-slate-600 focus:border-blue-500 focus:outline-none">
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-300 mb-2">End Time</label>
          <input type="time" name="quiet_hours_end" value="08:00" class="w-full px-3 py-2 bg-slate-700 text-white rounded-lg border border-slate-600 focus:border-blue-500 focus:outline-none">
        </div>
      </div>
    </div>
  </form>

  <!-- Save Status -->
  <div id="saveStatus" class="hidden mt-4 p-3 rounded-lg text-sm"></div>
</div>

<script>
  class NotificationPreferences {
    constructor() {
      this.form = document.getElementById('notificationPreferencesForm');
      this.saveBtn = document.getElementById('savePreferencesBtn');
      this.saveStatus = document.getElementById('saveStatus');
      this.quietHoursCheckbox = document.querySelector('input[name="quiet_hours_enabled"]');
      this.quietHoursSettings = document.getElementById('quietHoursSettings');
      
      this.init();
    }

    init() {
      this.loadPreferences();
      this.setupEventListeners();
    }

    setupEventListeners() {
      // Save button
      this.saveBtn?.addEventListener('click', () => {
        this.savePreferences();
      });

      // Quiet hours toggle
      this.quietHoursCheckbox?.addEventListener('change', (e) => {
        this.toggleQuietHours(e.target.checked);
      });

      // Form submission
      this.form?.addEventListener('submit', (e) => {
        e.preventDefault();
        this.savePreferences();
      });

      // Desktop notifications permission
      const desktopNotificationsCheckbox = document.querySelector('input[name="app_desktop_notifications"]');
      desktopNotificationsCheckbox?.addEventListener('change', (e) => {
        if (e.target.checked) {
          this.requestDesktopNotificationPermission();
        }
      });
    }

    toggleQuietHours(enabled) {
      if (this.quietHoursSettings) {
        if (enabled) {
          this.quietHoursSettings.classList.remove('opacity-50', 'pointer-events-none');
        } else {
          this.quietHoursSettings.classList.add('opacity-50', 'pointer-events-none');
        }
      }
    }

    async requestDesktopNotificationPermission() {
      if ('Notification' in window) {
        const permission = await Notification.requestPermission();
        if (permission !== 'granted') {
          const checkbox = document.querySelector('input[name="app_desktop_notifications"]');
          if (checkbox) {
            checkbox.checked = false;
          }
          this.showStatus('Desktop notifications permission denied', 'error');
        }
      }
    }

    loadPreferences() {
      const saved = localStorage.getItem('notificationPreferences');
      if (saved) {
        try {
          const preferences = JSON.parse(saved);
          this.applyPreferences(preferences);
        } catch (error) {
          console.error('Error loading notification preferences:', error);
        }
      }
    }

    applyPreferences(preferences) {
      // Apply checkbox states
      Object.keys(preferences).forEach(key => {
        const element = this.form?.querySelector(`[name="${key}"]`);
        if (element) {
          if (element.type === 'checkbox') {
            element.checked = preferences[key];
          } else {
            element.value = preferences[key];
          }
        }
      });

      // Apply quiet hours state
      if (preferences.quiet_hours_enabled) {
        this.toggleQuietHours(true);
      }
    }

    collectPreferences() {
      const formData = new FormData(this.form);
      const preferences = {};

      // Collect all form data
      for (let [key, value] of formData.entries()) {
        const element = this.form?.querySelector(`[name="${key}"]`);
        if (element && element.type === 'checkbox') {
          preferences[key] = element.checked;
        } else {
          preferences[key] = value;
        }
      }

      return preferences;
    }

    async savePreferences() {
      const preferences = this.collectPreferences();
      
      // Show loading state
      this.showSaveLoading(true);

      try {
        // Save to localStorage
        localStorage.setItem('notificationPreferences', JSON.stringify(preferences));

        // Send to server (if API is available)
        await this.syncWithServer(preferences);

        // Show success message
        this.showStatus('Notification preferences saved successfully!', 'success');

        // Apply preferences to notification service
        this.applyToNotificationService(preferences);

      } catch (error) {
        console.error('Error saving notification preferences:', error);
        this.showStatus('Failed to save preferences. Please try again.', 'error');
      } finally {
        this.showSaveLoading(false);
      }
    }

    async syncWithServer(preferences) {
      const token = localStorage.getItem('auth_token');
      if (!token) return;

      try {
        const response = await fetch('/api/user/preferences', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`,
          },
          body: JSON.stringify({
            notificationPreferences: preferences
          })
        });

        if (!response.ok) {
          throw new Error(`Server responded with ${response.status}`);
        }

        return await response.json();
      } catch (error) {
        console.warn('Failed to sync preferences with server:', error);
        // Don't throw error, localStorage save is sufficient
      }
    }

    applyToNotificationService(preferences) {
      // Apply preferences to the notification service if available
      if (window.notificationService) {
        // Enable/disable real-time updates based on preferences
        if (preferences.app_realtime_updates) {
          window.notificationService.reconnect();
        } else {
          window.notificationService.disconnect();
        }

        // Request desktop notification permission if enabled
        if (preferences.app_desktop_notifications && 'Notification' in window) {
          Notification.requestPermission();
        }
      }
    }

    showSaveLoading(loading) {
      if (!this.saveBtn) return;

      if (loading) {
        this.saveBtn.disabled = true;
        this.saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Saving...';
      } else {
        this.saveBtn.disabled = false;
        this.saveBtn.innerHTML = '<i class="fas fa-save mr-2"></i>Save Preferences';
      }
    }

    showStatus(message, type) {
      if (!this.saveStatus) return;

      this.saveStatus.textContent = message;
      this.saveStatus.classList.remove('hidden', 'bg-green-500', 'bg-red-500', 'bg-blue-500');

      const colors = {
        success: 'bg-green-500',
        error: 'bg-red-500',
        info: 'bg-blue-500'
      };

      this.saveStatus.classList.add(colors[type] || colors.info, 'text-white');

      // Auto hide after 3 seconds
      setTimeout(() => {
        this.saveStatus.classList.add('hidden');
      }, 3000);
    }
  }

  // Initialize when DOM is ready
  document.addEventListener('DOMContentLoaded', () => {
    new NotificationPreferences();
  });
</script>