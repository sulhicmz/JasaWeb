---
// DashboardExport.astro - Export dashboard data component
---

<div class="glass-panel p-6 rounded-xl">
  <div class="flex items-center justify-between mb-4">
    <h2 class="text-xl font-bold text-white">Export Reports</h2>
    <button id="export-menu-btn" class="text-sm text-blue-400 hover:text-blue-300 transition-colors">
      <i class="fas fa-download mr-1"></i> Export
    </button>
  </div>
  
  <div id="export-menu" class="hidden space-y-3">
    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
      <button onclick="exportDashboard('pdf')" class="p-3 bg-slate-800 hover:bg-slate-700 rounded-lg text-left transition-colors">
        <i class="fas fa-file-pdf text-red-400 mb-2"></i>
        <div class="text-white font-medium">PDF Report</div>
        <div class="text-gray-400 text-sm">Complete dashboard overview</div>
      </button>
      
      <button onclick="exportDashboard('excel')" class="p-3 bg-slate-800 hover:bg-slate-700 rounded-lg text-left transition-colors">
        <i class="fas fa-file-excel text-green-400 mb-2"></i>
        <div class="text-white font-medium">Excel Data</div>
        <div class="text-gray-400 text-sm">Raw data for analysis</div>
      </button>
      
      <button onclick="exportDashboard('json')" class="p-3 bg-slate-800 hover:bg-slate-700 rounded-lg text-left transition-colors">
        <i class="fas fa-file-code text-blue-400 mb-2"></i>
        <div class="text-white font-medium">JSON Data</div>
        <div class="text-gray-400 text-sm">API response format</div>
      </button>
      
      <button onclick="exportDashboard('csv')" class="p-3 bg-slate-800 hover:bg-slate-700 rounded-lg text-left transition-colors">
        <i class="fas fa-file-csv text-purple-400 mb-2"></i>
        <div class="text-white font-medium">CSV Data</div>
        <div class="text-gray-400 text-sm">Spreadsheet compatible</div>
      </button>
    </div>
  </div>
</div>

<script>
  let dashboardData = {
    stats: null,
    activities: null,
    projects: null,
    lastUpdated: null
  };

  // Collect dashboard data
  window.addEventListener('stats-updated', (e) => {
    dashboardData.stats = e.detail.stats;
    dashboardData.lastUpdated = e.detail.timestamp;
  });

  // Toggle export menu
  document.getElementById('export-menu-btn')?.addEventListener('click', () => {
    const menu = document.getElementById('export-menu');
    menu.classList.toggle('hidden');
  });

  // Close menu when clicking outside
  document.addEventListener('click', (e) => {
    const menu = document.getElementById('export-menu');
    const btn = document.getElementById('export-menu-btn');
    if (!menu.contains(e.target) && !btn.contains(e.target)) {
      menu.classList.add('hidden');
    }
  });

  async function exportDashboard(format) {
    try {
      window.notificationSystem.info(`Preparing ${format.toUpperCase()} export...`);
      
      // Collect current data
      const [stats, activities, projects] = await Promise.all([
        fetch('/api/dashboard/stats').then(r => r.json()),
        fetch('/api/dashboard/recent-activity?limit=50').then(r => r.json()),
        fetch('/api/dashboard/projects-overview?limit=20').then(r => r.json())
      ]);

      const exportData = {
        generatedAt: new Date().toISOString(),
        stats,
        activities,
        projects
      };

      switch (format) {
        case 'json':
          downloadJSON(exportData);
          break;
        case 'csv':
          downloadCSV(exportData);
          break;
        case 'excel':
          downloadExcel(exportData);
          break;
        case 'pdf':
          downloadPDF(exportData);
          break;
        default:
          throw new Error('Unsupported export format');
      }

      window.notificationSystem.success(`${format.toUpperCase()} export completed successfully!`);
    } catch (error) {
      console.error('Export error:', error);
      window.notificationSystem.error(`Failed to export ${format.toUpperCase()}: ${error.message}`);
    }
  }

  function downloadJSON(data) {
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    downloadFile(blob, `dashboard-export-${new Date().toISOString().split('T')[0]}.json`);
  }

  function downloadCSV(data) {
    let csv = 'Type,Title,Status,Created At,Priority,Due Date\n';
    
    // Add activities
    data.activities?.forEach(activity => {
      csv += `${activity.type},"${activity.title}",${activity.status},${activity.createdAt},${activity.priority || ''},${activity.dueDate || ''}\n`;
    });

    const blob = new Blob([csv], { type: 'text/csv' });
    downloadFile(blob, `dashboard-export-${new Date().toISOString().split('T')[0]}.csv`);
  }

  function downloadExcel(data) {
    // Simple HTML table that Excel can open
    let html = `
      <html>
        <head><meta charset="utf-8"></head>
        <body>
          <h1>Dashboard Export - ${new Date().toLocaleDateString()}</h1>
          
          <h2>Statistics</h2>
          <table border="1">
            <tr><th>Category</th><th>Metric</th><th>Value</th></tr>
    `;

    // Add stats
    Object.entries(data.stats || {}).forEach(([category, metrics]) => {
      Object.entries(metrics).forEach(([metric, value]) => {
        html += `<tr><td>${category}</td><td>${metric}</td><td>${value}</td></tr>`;
      });
    });

    html += `
          </table>
          
          <h2>Recent Activities</h2>
          <table border="1">
            <tr><th>Type</th><th>Title</th><th>Status</th><th>Created At</th><th>Priority</th></tr>
    `;

    data.activities?.forEach(activity => {
      html += `<tr><td>${activity.type}</td><td>${activity.title}</td><td>${activity.status}</td><td>${activity.createdAt}</td><td>${activity.priority || ''}</td></tr>`;
    });

    html += `
          </table>
        </body>
      </html>
    `;

    const blob = new Blob([html], { type: 'application/vnd.ms-excel' });
    downloadFile(blob, `dashboard-export-${new Date().toISOString().split('T')[0]}.xls`);
  }

  function downloadPDF(data) {
    // Simple HTML to PDF conversion (would require a PDF library in production)
    let html = `
      <html>
        <head>
          <meta charset="utf-8">
          <style>
            body { font-family: Arial, sans-serif; margin: 20px; }
            .header { text-align: center; margin-bottom: 30px; }
            .section { margin-bottom: 20px; }
            .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 20px; }
            .stat-card { border: 1px solid #ddd; padding: 15px; text-align: center; }
            table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
            th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
            th { background-color: #f5f5f5; }
          </style>
        </head>
        <body>
          <div class="header">
            <h1>JasaWeb Dashboard Report</h1>
            <p>Generated on ${new Date().toLocaleDateString()} at ${new Date().toLocaleTimeString()}</p>
          </div>
          
          <div class="section">
            <h2>Overview Statistics</h2>
            <div class="stats-grid">
    `;

    // Add stats cards
    if (data.stats) {
      html += `
        <div class="stat-card">
          <h3>Projects</h3>
          <p><strong>${data.stats.projects?.total || 0}</strong> Total</p>
          <p>${data.stats.projects?.active || 0} Active</p>
          <p>${data.stats.projects?.completed || 0} Completed</p>
        </div>
        <div class="stat-card">
          <h3>Tickets</h3>
          <p><strong>${data.stats.tickets?.total || 0}</strong> Total</p>
          <p>${data.stats.tickets?.open || 0} Open</p>
          <p>${data.stats.tickets?.critical || 0} Critical</p>
        </div>
        <div class="stat-card">
          <h3>Invoices</h3>
          <p><strong>${data.stats.invoices?.total || 0}</strong> Total</p>
          <p>${data.stats.invoices?.pending || 0} Pending</p>
          <p>${data.stats.invoices?.overdue || 0} Overdue</p>
        </div>
        <div class="stat-card">
          <h3>Milestones</h3>
          <p><strong>${data.stats.milestones?.total || 0}</strong> Total</p>
          <p>${data.stats.milestones?.completed || 0} Completed</p>
          <p>${data.stats.milestones?.dueThisWeek || 0} Due This Week</p>
        </div>
      `;
    }

    html += `
            </div>
          </div>
          
          <div class="section">
            <h2>Recent Activities</h2>
            <table>
              <thead>
                <tr>
                  <th>Type</th>
                  <th>Title</th>
                  <th>Status</th>
                  <th>Created At</th>
                  <th>Priority</th>
                </tr>
              </thead>
              <tbody>
    `;

    data.activities?.forEach(activity => {
      html += `
        <tr>
          <td>${activity.type}</td>
          <td>${activity.title}</td>
          <td>${activity.status}</td>
          <td>${new Date(activity.createdAt).toLocaleDateString()}</td>
          <td>${activity.priority || '-'}</td>
        </tr>
      `;
    });

    html += `
              </tbody>
            </table>
          </div>
        </body>
      </html>
    `;

    const blob = new Blob([html], { type: 'text/html' });
    downloadFile(blob, `dashboard-report-${new Date().toISOString().split('T')[0]}.html`);
  }

  function downloadFile(blob, filename) {
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }
</script>