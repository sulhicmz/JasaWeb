---
interface ProjectMetricsProps {
  projectId: string;
}

const { projectId } = Astro.props;
---

<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6" data-project-metrics>
  <!-- Loading State -->
  <div class="col-span-full flex items-center justify-center py-8" data-metrics-loading>
    <div class="flex items-center space-x-3">
      <i class="fas fa-spinner fa-spin text-blue-400"></i>
      <span class="text-gray-400">Loading metrics...</span>
    </div>
  </div>

  <!-- Metrics will be populated here -->
  <div data-metrics-container></div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', async () => {
    const projectId = '{{projectId}}';
    await loadProjectMetrics(projectId);
  });

  async function loadProjectMetrics(projectId) {
    try {
      const metrics = await fetchProjectMetrics(projectId);
      renderMetrics(metrics);
    } catch (error) {
      console.error('Failed to load project metrics:', error);
      showMetricsError();
    }
  }

  async function fetchProjectMetrics(projectId) {
    // Simulate API call
    return new Promise((resolve) => {
      setTimeout(() => {
        resolve({
          progress: {
            current: 65,
            target: 100,
            trend: 'up'
          },
          milestones: {
            completed: 5,
            total: 8,
            overdue: 0,
            thisWeek: 2
          },
          tickets: {
            open: 3,
            inProgress: 2,
            resolved: 8,
            critical: 1
          },
          timeline: {
            daysElapsed: 44,
            daysTotal: 75,
            daysRemaining: 31,
            onTrack: true
          },
          budget: {
            spent: 45000,
            total: 75000,
            remaining: 30000
          },
          team: {
            active: 6,
            total: 8,
            utilization: 85
          }
        });
      }, 1000);
    });
  }

  function renderMetrics(metrics) {
    const container = document.querySelector('[data-metrics-container]');
    const loadingEl = document.querySelector('[data-metrics-loading]');
    
    if (loadingEl) loadingEl.style.display = 'none';
    if (!container) return;

    container.innerHTML = `
      <!-- Progress Metric -->
      <div class="glass-panel p-6 rounded-xl">
        <div class="flex items-center justify-between mb-4">
          <div class="flex items-center space-x-3">
            <div class="w-10 h-10 bg-blue-500/20 rounded-lg flex items-center justify-center">
              <i class="fas fa-chart-line text-blue-400"></i>
            </div>
            <div>
              <p class="text-gray-400 text-sm">Overall Progress</p>
              <p class="text-2xl font-bold text-white">${metrics.progress.current}%</p>
            </div>
          </div>
          <div class="flex items-center space-x-1 text-green-400">
            <i class="fas fa-arrow-up text-xs"></i>
            <span class="text-xs">12%</span>
          </div>
        </div>
        <div class="w-full bg-slate-700 rounded-full h-2">
          <div class="bg-gradient-to-r from-blue-500 to-indigo-500 h-2 rounded-full transition-all duration-500" 
               style="width: ${metrics.progress.current}%"></div>
        </div>
        <p class="text-xs text-gray-500 mt-2">${metrics.progress.current}% of target</p>
      </div>

      <!-- Milestones Metric -->
      <div class="glass-panel p-6 rounded-xl">
        <div class="flex items-center justify-between mb-4">
          <div class="flex items-center space-x-3">
            <div class="w-10 h-10 bg-green-500/20 rounded-lg flex items-center justify-center">
              <i class="fas fa-flag-checkered text-green-400"></i>
            </div>
            <div>
              <p class="text-gray-400 text-sm">Milestones</p>
              <p class="text-2xl font-bold text-white">${metrics.milestones.completed}/${metrics.milestones.total}</p>
            </div>
          </div>
          <div class="flex items-center space-x-1 ${metrics.milestones.overdue > 0 ? 'text-red-400' : 'text-green-400'}">
            <i class="fas ${metrics.milestones.overdue > 0 ? 'fa-exclamation-triangle' : 'fa-check-circle'} text-xs"></i>
            <span class="text-xs">${metrics.milestones.overdue} overdue</span>
          </div>
        </div>
        <div class="space-y-2">
          <div class="flex justify-between text-xs">
            <span class="text-gray-400">Completion Rate</span>
            <span class="text-white font-medium">
              ${Math.round((metrics.milestones.completed / metrics.milestones.total) * 100)}%
            </span>
          </div>
          <div class="flex justify-between text-xs">
            <span class="text-gray-400">Due This Week</span>
            <span class="text-white font-medium">${metrics.milestones.thisWeek}</span>
          </div>
        </div>
      </div>

      <!-- Tickets Metric -->
      <div class="glass-panel p-6 rounded-xl">
        <div class="flex items-center justify-between mb-4">
          <div class="flex items-center space-x-3">
            <div class="w-10 h-10 bg-purple-500/20 rounded-lg flex items-center justify-center">
              <i class="fas fa-ticket-alt text-purple-400"></i>
            </div>
            <div>
              <p class="text-gray-400 text-sm">Active Tickets</p>
              <p class="text-2xl font-bold text-white">${metrics.tickets.open + metrics.tickets.inProgress}</p>
            </div>
          </div>
          <div class="flex items-center space-x-1 ${metrics.tickets.critical > 0 ? 'text-red-400' : 'text-yellow-400'}">
            <i class="fas ${metrics.tickets.critical > 0 ? 'fa-exclamation-triangle' : 'fa-clock'} text-xs"></i>
            <span class="text-xs">${metrics.tickets.critical} critical</span>
          </div>
        </div>
        <div class="space-y-2">
          <div class="flex justify-between text-xs">
            <span class="text-gray-400">Open</span>
            <span class="text-white font-medium">${metrics.tickets.open}</span>
          </div>
          <div class="flex justify-between text-xs">
            <span class="text-gray-400">In Progress</span>
            <span class="text-white font-medium">${metrics.tickets.inProgress}</span>
          </div>
          <div class="flex justify-between text-xs">
            <span class="text-gray-400">Resolved</span>
            <span class="text-green-400 font-medium">${metrics.tickets.resolved}</span>
          </div>
        </div>
      </div>

      <!-- Timeline Metric -->
      <div class="glass-panel p-6 rounded-xl">
        <div class="flex items-center justify-between mb-4">
          <div class="flex items-center space-x-3">
            <div class="w-10 h-10 bg-orange-500/20 rounded-lg flex items-center justify-center">
              <i class="fas fa-calendar-alt text-orange-400"></i>
            </div>
            <div>
              <p class="text-gray-400 text-sm">Timeline</p>
              <p class="text-2xl font-bold text-white">${metrics.timeline.daysRemaining}d</p>
            </div>
          </div>
          <div class="flex items-center space-x-1 ${metrics.timeline.onTrack ? 'text-green-400' : 'text-red-400'}">
            <i class="fas ${metrics.timeline.onTrack ? 'fa-check-circle' : 'fa-exclamation-triangle'} text-xs"></i>
            <span class="text-xs">${metrics.timeline.onTrack ? 'On track' : 'At risk'}</span>
          </div>
        </div>
        <div class="space-y-2">
          <div class="w-full bg-slate-700 rounded-full h-2">
            <div class="bg-gradient-to-r from-orange-500 to-red-500 h-2 rounded-full transition-all duration-500" 
                 style="width: ${(metrics.timeline.daysElapsed / metrics.timeline.daysTotal) * 100}%"></div>
          </div>
          <div class="flex justify-between text-xs">
            <span class="text-gray-400">Elapsed</span>
            <span class="text-white font-medium">${metrics.timeline.daysElapsed}d</span>
          </div>
        </div>
      </div>

      <!-- Budget Metric (if available) -->
      ${metrics.budget ? `
        <div class="glass-panel p-6 rounded-xl">
          <div class="flex items-center justify-between mb-4">
            <div class="flex items-center space-x-3">
              <div class="w-10 h-10 bg-yellow-500/20 rounded-lg flex items-center justify-center">
                <i class="fas fa-dollar-sign text-yellow-400"></i>
              </div>
              <div>
                <p class="text-gray-400 text-sm">Budget Used</p>
                <p class="text-2xl font-bold text-white">$${(metrics.budget.spent / 1000).toFixed(1)}k</p>
              </div>
            </div>
            <div class="flex items-center space-x-1 ${metrics.budget.spent / metrics.budget.total > 0.8 ? 'text-red-400' : 'text-green-400'}">
              <i class="fas ${metrics.budget.spent / metrics.budget.total > 0.8 ? 'fa-exclamation-triangle' : 'fa-check-circle'} text-xs"></i>
              <span class="text-xs">${Math.round((metrics.budget.spent / metrics.budget.total) * 100)}%</span>
            </div>
          </div>
          <div class="space-y-2">
            <div class="w-full bg-slate-700 rounded-full h-2">
              <div class="bg-gradient-to-r from-yellow-500 to-orange-500 h-2 rounded-full transition-all duration-500" 
                   style="width: ${(metrics.budget.spent / metrics.budget.total) * 100}%"></div>
            </div>
            <div class="flex justify-between text-xs">
              <span class="text-gray-400">Remaining</span>
              <span class="text-white font-medium">$${(metrics.budget.remaining / 1000).toFixed(1)}k</span>
            </div>
          </div>
        </div>
      ` : ''}

      <!-- Team Metric (if available) -->
      ${metrics.team ? `
        <div class="glass-panel p-6 rounded-xl">
          <div class="flex items-center justify-between mb-4">
            <div class="flex items-center space-x-3">
              <div class="w-10 h-10 bg-cyan-500/20 rounded-lg flex items-center justify-center">
                <i class="fas fa-users text-cyan-400"></i>
              </div>
              <div>
                <p class="text-gray-400 text-sm">Team Utilization</p>
                <p class="text-2xl font-bold text-white">${metrics.team.utilization}%</p>
              </div>
            </div>
            <div class="flex items-center space-x-1 ${metrics.team.utilization > 90 ? 'text-red-400' : metrics.team.utilization > 70 ? 'text-yellow-400' : 'text-green-400'}">
              <i class="fas ${metrics.team.utilization > 90 ? 'fa-exclamation-triangle' : metrics.team.utilization > 70 ? 'fa-exclamation-circle' : 'fa-check-circle'} text-xs"></i>
              <span class="text-xs">${metrics.team.utilization > 90 ? 'High' : metrics.team.utilization > 70 ? 'Medium' : 'Good'}</span>
            </div>
          </div>
          <div class="space-y-2">
            <div class="flex justify-between text-xs">
              <span class="text-gray-400">Active Members</span>
              <span class="text-white font-medium">${metrics.team.active}/${metrics.team.total}</span>
            </div>
            <div class="w-full bg-slate-700 rounded-full h-2">
              <div class="bg-gradient-to-r from-cyan-500 to-blue-500 h-2 rounded-full transition-all duration-500" 
                   style="width: ${metrics.team.utilization}%"></div>
            </div>
          </div>
        </div>
      ` : ''}
    `;

    // Setup metric interactions
    setupMetricInteractions();
  }

  function setupMetricInteractions() {
    const metricCards = document.querySelectorAll('[data-project-metrics] > div:not([data-metrics-loading]):not([data-metrics-container]) > div');
    
    metricCards.forEach(card => {
      card.addEventListener('click', () => {
        // Handle metric card click - could show detailed view
        console.log('Metric card clicked');
      });
    });
  }

  function showMetricsError() {
    const container = document.querySelector('[data-metrics-container]');
    const loadingEl = document.querySelector('[data-metrics-loading]');
    
    if (loadingEl) loadingEl.style.display = 'none';
    if (!container) return;

    container.innerHTML = `
      <div class="col-span-full text-center py-8">
        <i class="fas fa-exclamation-triangle text-red-400 text-3xl mb-3"></i>
        <p class="text-gray-400">Failed to load project metrics</p>
      </div>
    `;
  }
</script>