// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id                  String         @id @default(cuid())
  email               String         @unique
  name                String?
  password            String
  passwordHashVersion String         @default("bcrypt")
  profilePicture      String?
  createdAt           DateTime       @default(now())
  updatedAt           DateTime       @updatedAt
  memberships         Membership[]
  approvals           Approval[]
  tickets             Ticket[]
  invoices            Invoice[]
  auditLogs           AuditLog[]
  File                File[]
  Task                Task[]
  assignedTasks      Task[]         @relation("TaskAssignee")
  refreshTokens       RefreshToken[]
  sessions            Session[]
  kbArticles          KbArticle[]
  kbFeedback          KbFeedback[]
  kbSearchLogs        KbSearchLog[]
}

model Organization {
  id           String       @id @default(cuid())
  name         String
  billingEmail String
  plan         String?
  settings     Json?
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt
  memberships  Membership[]
  projects     Project[]
  tickets      Ticket[]
  invoices     Invoice[]
  AuditLog     AuditLog[]

  @@index([createdAt])
  @@index([plan])
}

model Membership {
  id             String       @id @default(cuid())
  role           String // owner, admin, reviewer, finance, member
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  userId         String
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([userId, organizationId])
  @@index([organizationId])
  @@index([role])
  @@index([createdAt])
}

model Project {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  name           String
  status         String // draft, progress, review, completed, paused, cancelled
  startAt        DateTime?
  dueAt          DateTime?
  stagingUrl     String?      // Staging environment URL
  productionUrl  String?      // Production/live URL
  repositoryUrl  String?      // Git repository URL
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  milestones     Milestone[]
  files          File[]
  approvals      Approval[]
  tasks          Task[]
  tickets        Ticket[]
  invoices       Invoice[]

  @@index([organizationId])
  @@index([status])
  @@index([organizationId, status])
  @@index([organizationId, status, updatedAt]) // Composite for dashboard projects overview
  @@index([organizationId, createdAt]) // For recent projects
  @@index([organizationId, dueAt]) // For projects due soon/overdue
  @@index([createdAt])
  @@index([dueAt])
  @@index([updatedAt]) // For sorting in dashboard
}

model Milestone {
  id        String    @id @default(cuid())
  projectId String
  project   Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  title     String
  dueAt     DateTime?
  status    String // todo, in-progress, completed, overdue
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@index([projectId])
  @@index([status])
  @@index([projectId, status]) // For project milestone stats
  @@index([dueAt]) // For upcoming milestones
  @@index([status, dueAt]) // For overdue milestones
  @@index([createdAt]) // For recent milestones
}

model File {
  id           String   @id @default(cuid())
  projectId    String
  project      Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  folder       String?
  filename     String
  version      String?
  size         Int?
  checksum     String?
  uploadedById String
  uploadedBy   User     @relation(fields: [uploadedById], references: [id])
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model Approval {
  id          String    @id @default(cuid())
  projectId   String
  project     Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  itemType    String // page, content, design, feature, etc.
  itemId      String
  status      String // pending, approved, rejected
  decidedById String?
  decidedBy   User?     @relation(fields: [decidedById], references: [id])
  decidedAt   DateTime?
  note        String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

model Task {
  id          String    @id @default(cuid())
  projectId   String
  project     Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  createdById String
  createdBy   User      @relation(fields: [createdById], references: [id])
  title       String
  description String?
  assignedTo  String?
  assignedUser User?     @relation("TaskAssignee", fields: [assignedTo], references: [id])
  status      String // todo, in-progress, completed
  dueAt       DateTime?
  labels      String[]  @default([])
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

model Ticket {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  projectId      String?
  project        Project?     @relation(fields: [projectId], references: [id], onDelete: SetNull)
  type           String // bug, feature, improvement, question, task
  priority       String // low, medium, high, critical
  status         String // open, in-progress, in-review, resolved, closed
  assigneeId     String?
  assignee       User?        @relation(fields: [assigneeId], references: [id])
  slaDueAt       DateTime?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@index([organizationId])
  @@index([status])
  @@index([priority])
  @@index([assigneeId])
  @@index([organizationId, status]) // For ticket stats
  @@index([organizationId, priority, status]) // For high priority open tickets
  @@index([organizationId, createdAt]) // For recent tickets
  @@index([status, priority]) // For SLA calculations
  @@index([slaDueAt])
  @@index([assigneeId, status]) // For assignee workloads
  @@index([createdAt])
  @@index([updatedAt]) // For recent activity
}

model Invoice {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  projectId      String?
  project        Project?     @relation(fields: [projectId], references: [id], onDelete: SetNull)
  userId         String?
  issuedBy       User?        @relation(fields: [userId], references: [id])
  amount         Float
  currency       String // USD, EUR, etc.
  issuedAt       DateTime
  dueAt          DateTime
  status         String // draft, issued, paid, overdue, cancelled
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@index([organizationId])
  @@index([status])
  @@index([userId])
  @@index([organizationId, status]) // For invoice stats
  @@index([organizationId, dueAt]) // For overdue invoices
  @@index([organizationId, status, dueAt]) // For pending and overdue amounts
  @@index([status, dueAt]) // For payment followups
  @@index([dueAt])
  @@index([issuedAt])
  @@index([createdAt])
  @@index([updatedAt]) // For recent activity
}

model Session {
  id         String   @id @default(cuid())
  sessionToken String @unique  // The session token
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  revokedAt  DateTime?
  userAgent  String?
  ipAddress  String?
  
  @@index([userId])
}

model RefreshToken {
  id           String   @id @default(cuid())
  tokenHash    String   @unique  // Hashed version for security
  tokenIdentifier String @unique // Plaintext identifier for lookups (not the actual token)
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt    DateTime
  createdAt    DateTime @default(now())
  revokedAt    DateTime?
  
  @@index([userId])
}

model AuditLog {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  actorId        String?
  actor          User?        @relation(fields: [actorId], references: [id])
  action         String // user_login, file_upload, approval_request, etc.
  target         String // User, Project, File, etc.
  meta           Json?
  createdAt      DateTime     @default(now())

  @@index([organizationId])
  @@index([actorId])
  @@index([action])
  @@index([createdAt])
  @@index([organizationId, createdAt])
}

model KnowledgeBaseCategory {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  icon        String?
  color       String?
  order       Int      @default(0)
  parentId    String?
  parent      KnowledgeBaseCategory? @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children    KnowledgeBaseCategory[] @relation("CategoryHierarchy")
  articles    KbArticle[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model KbArticle {
  id          String   @id @default(cuid())
  title       String
  slug        String   @unique
  content     String   // Rich text content
  excerpt     String?  // Brief description for search results
  status      String   // draft, published, archived
  featured    Boolean  @default(false)
  viewCount   Int      @default(0)
  categoryId  String
  category    KnowledgeBaseCategory @relation(fields: [categoryId], references: [id])
  authorId    String
  author      User     @relation(fields: [authorId], references: [id])
  tags        KbTag[]
  feedback    KbFeedback[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  publishedAt DateTime?

  @@index([status])
  @@index([categoryId])
  @@index([publishedAt])
  @@index([featured])
}

model KbTag {
  id       String     @id @default(cuid())
  name     String     @unique
  color    String?
  articles KbArticle[]
  createdAt DateTime   @default(now())
}

model KbFeedback {
  id        String   @id @default(cuid())
  articleId String
  article   KbArticle @relation(fields: [articleId], references: [id], onDelete: Cascade)
  userId    String?
  user      User?    @relation(fields: [userId], references: [id])
  rating    Int      // 1-5 stars
  comment   String?
  helpful   Boolean? // Was this article helpful?
  createdAt DateTime @default(now())

  @@index([articleId])
  @@index([userId])
}

model KbSearchLog {
  id        String   @id @default(cuid())
  query     String
  results   Int      @default(0)
  clicked   String?  // Article ID that was clicked
  userId    String?
  user      User?    @relation(fields: [userId], references: [id])
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())

  @@index([query])
  @@index([createdAt])
}
