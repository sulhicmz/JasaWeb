name: oc - Autonomous Developer

on:
  schedule:
    - cron: '0 */8 * * *'  # Setiap 8 jam
  workflow_dispatch:
    inputs:
      development_type:
        description: 'Development focus area'
        required: false
        default: 'comprehensive'
        type: choice
        options:
          - comprehensive
          - features
          - bugfixes
          - optimization
          - documentation
      priority:
        description: 'Priority level'
        required: false
        default: 'balanced'
        type: choice
        options:
          - high-impact
          - balanced
          - quick-wins
          - maintenance

permissions:
  id-token: write
  contents: write
  pull-requests: write
  issues: write
  actions: write

concurrency:
  group: ${{ github.workflow }}-global
  cancel-in-progress: false

jobs:
  autonomous-developer:
    name: OC Autonomous Developer
    runs-on: self-hosted
    timeout-minutes: 60
    permissions:
      id-token: write
      contents: write
      pull-requests: write
      issues: write
      actions: write

    env:
      GH_TOKEN: ${{ secrets.GH_TOKEN }}
      IFLOW_API_KEY: ${{ secrets.IFLOW_API_KEY }}

    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          token: ${{ secrets.GH_TOKEN }}

      - name: Install OpenCode CLI
        run: |
          curl -fsSL https://opencode.ai/install | bash
          echo "$HOME/.opencode/bin" >> $GITHUB_PATH

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 8.15.0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Analyze Project State
        id: analyze-project
        timeout-minutes: 15
        run: |
          DEVELOPMENT_TYPE="${{ github.event.inputs.development_type || 'comprehensive' }}"
          PRIORITY="${{ github.event.inputs.priority || 'balanced' }}"

          echo "Starting autonomous development cycle..."
          echo "Development Type: $DEVELOPMENT_TYPE"
          echo "Priority: $PRIORITY"

          opencode run "$(cat <<'PROMPT'
            **ROLE**: Senior Full-Stack Developer for JasaWeb
            **PROJECT**: Web Development Service Platform - Monorepo (pnpm)
            **TECH STACK**: Astro (apps/web), NestJS (apps/api), PostgreSQL + Prisma, Tailwind CSS
            **CODEBASE**: packages/ui (shared components), packages/config (shared configs)

            Perform comprehensive project analysis for JasaWeb:

            Analysis Parameters:
            - Development Type: '$DEVELOPMENT_TYPE'
            - Priority Level: '$PRIORITY'

            Analysis Areas:
            1. JasaWeb Business Model Analysis:
               - Analyze service offerings (School Websites, News Portals, Company Profiles)
               - Review lead generation and conversion funnels
               - Assess client portal functionality for project management
               - Evaluate billing and invoicing systems

            2. Codebase Health Assessment:
               - Identify technical debt in Astro/NestJS monorepo
               - Analyze PostgreSQL/Prisma data layer performance
               - Review Tailwind CSS implementation consistency
               - Check for TypeScript errors (strict mode required)

            3. Feature Gap Analysis:
               - Review client portal project management capabilities
               - Identify missing CRM features for lead tracking
               - Analyze admin dashboard functionality gaps

            4. Technical Infrastructure:
               - Optimize Astro build performance and SEO
               - Enhance NestJS API performance and caching
               - Improve PostgreSQL query optimization

            Output Requirements:
            1. Prioritized development tasks aligned with business goals
            2. Impact assessment for client experience and revenue
            3. Dependencies and technical prerequisites

            **CRITICAL: EPHEMERAL ENVIRONMENT - YOU MUST PERSIST ALL CHANGES**
            After completing your work, execute these Git commands:
            ```bash
            git config --global user.name "autonomous-developer"
            git config --global user.email "22936450+sulhicmz@users.noreply.github.com"
            git add -A
            git commit -m "chore(auto): project analysis and improvements"
            git push origin main || gh pr create --title "Auto: Project Improvements" --body "Automated improvements from autonomous developer" --base main
            ```
          PROMPT
          )" \
            --model iflowcn/qwen3-max \
            --share false \
            --non-interactive \

      - name: Implement High-Impact Features
        id: implement-features
        timeout-minutes: 20
        run: |
          opencode run "$(cat <<'PROMPT'
            Implement high-impact features for JasaWeb - Web Development Service Platform:

            Implementation Strategy:
            1. Feature Selection:
               - Choose 1-2 features that enhance client experience or service delivery
               - Prioritize by impact on lead conversion and client retention
               - Consider JasaWeb's B2B service model
               - Balance complexity with business value
               - Ensure alignment with web development service offerings

            2. Feature Implementation:
               - Design feature architecture respecting monorepo structure
               - Implement using Astro (frontend) and NestJS (backend)
               - Add proper error handling and validation
               - Include comprehensive testing with Jest/Playwright
               - Update Prisma schemas if database changes needed
               - Ensure multi-tenant data isolation

            3. Quality Assurance:
               - Unit tests for all new code
               - Integration tests for API endpoints
               - E2E tests for client workflows
               - Performance testing for client portal
               - Security testing for authentication and data
               - Accessibility testing for marketing pages

            4. Integration and Deployment:
               - Ensure proper integration with existing client portal
               - Update Tailwind CSS configurations if needed
               - Add database migrations if required
               - Update API documentation
               - Create client-facing documentation
               - Prepare deployment notes for Cloudflare Pages

            Feature Categories to Consider:
            1. Client Portal Enhancements:
               - Real-time project progress tracking
               - Automated milestone notifications
               - Enhanced file versioning and approval workflows
               - Integrated video calls for consultations
               - Client satisfaction surveys and feedback

            2. Lead Generation & CRM:
               - Automated lead scoring and qualification
               - Integration with popular CRM platforms
               - Proposal generation templates
               - Automated follow-up sequences
               - Analytics dashboard for conversion tracking

            3. Service Delivery Automation:
               - Automated project kickoff workflows
               - Template-based website generation
               - Content management for client sites
               - Automated testing and deployment pipelines
               - Client training and onboarding modules

            4. Marketing & Portfolio:
               - Dynamic portfolio showcase with case studies
               - Client testimonials and success stories
               - Service comparison and pricing calculators
               - SEO optimization for service pages
               - Integration with social media and review platforms

            Actions to Take:
            1. Create feature branches following GitFlow
            2. Implement features using TypeScript best practices
            3. Add comprehensive tests and documentation
            4. Create pull requests with business impact descriptions
            5. Ensure all quality checks and CI/CD pass
            6. Request reviews from team members

            Focus on features that directly improve client acquisition and retention.
            Ensure all implementations enhance JasaWeb's competitive advantage.
          PROMPT
          )" \
            --model iflowcn/qwen3-coder-plus \
            --share false \

      - name: Fix Critical Bugs
        id: fix-bugs
        timeout-minutes: 15
        run: |
          opencode run "$(cat <<'PROMPT'
            Identify and fix critical bugs for JasaWeb - Web Development Service Platform:

            Bug Analysis and Fix Strategy:
            1. Bug Identification:
               - Review client-reported issues and support tickets
               - Analyze error logs from client portal and admin dashboard
               - Check for performance issues in project management workflows
               - Review billing and payment processing errors
               - Identify multi-tenant data isolation vulnerabilities
               - Check for integration issues with deployment pipelines

            2. Bug Prioritization:
               - Critical: Client data breaches, payment failures, service downtime
               - High: Project management failures, file upload issues, login problems
               - Medium: UI inconsistencies, notification delays, reporting errors
               - Low: Cosmetic issues, minor UX improvements, documentation gaps

            3. Bug Fix Implementation:
               - Identify root cause in Astro/NestJS/PostgreSQL stack
               - Implement comprehensive fix with proper error handling
               - Add regression tests using Jest/Playwright
               - Ensure no impact on other client workflows
               - Update Prisma schemas if database changes needed
               - Test thoroughly across different client scenarios

            4. Quality Assurance:
               - Unit tests for fixed code
               - Integration tests for client portal workflows
               - E2E tests for project management scenarios
               - Performance testing for client portal responsiveness
               - Security testing for multi-tenant data access
               - Regression testing for related client features

            Common Bug Categories to Address:
            1. Client Portal Authentication:
               - Multi-tenant login and session management
               - Role-based access control for team members
               - JWT token handling and refresh mechanisms
               - Client data isolation and security

            2. Project Management System:
               - File upload/download and version control
               - Milestone tracking and notification systems
               - Real-time collaboration features
               - Project template and workflow automation

            3. Billing and Payments:
               - Invoice generation and payment processing
               - Subscription management and renewals
               - Tax calculation and reporting
               - Integration with payment gateways

            4. Marketing Website:
               - Lead capture form functionality
               - Portfolio showcase and case study displays
               - SEO optimization and page load performance
               - Contact form and inquiry routing

            Actions to Take:
            1. Create bug fix branches following GitFlow
            2. Implement fixes using TypeScript best practices
            3. Add comprehensive tests for client scenarios
            4. Update client documentation and help articles
            5. Create pull requests with client impact assessments
            6. Ensure all quality checks pass before deployment

            Focus on bugs that directly impact client satisfaction and revenue.
            Ensure fixes maintain data security and service reliability.
          PROMPT
          )" \
            --model iflowcn/qwen3-coder-plus \
            --share false \
            --non-interactive \

      - name: Optimize Performance
        id: optimize-performance
        timeout-minutes: 15
        run: |
          opencode run "$(cat <<'PROMPT'
            Optimize performance for JasaWeb - Web Development Service Platform:

            Performance Optimization Strategy:
            1. Performance Analysis:
               - Analyze client portal load times and responsiveness
               - Review NestJS API response times for client workflows
               - Check PostgreSQL query performance for multi-tenant data
               - Analyze Astro build times and SEO scores
               - Review memory usage in concurrent client sessions
               - Check file upload/download performance

            2. Backend Optimizations:
               - PostgreSQL query optimization with proper indexing
               - Prisma query optimization and N+1 prevention
               - NestJS API caching and response optimization
               - Background job processing for client notifications
               - Multi-tenant query optimization
               - Database connection pooling improvements

            3. Frontend Optimizations:
               - Astro build optimization and bundle analysis
               - Tailwind CSS purging and optimization
               - Client portal code splitting and lazy loading
               - Image optimization for portfolio and case studies
               - PWA implementation for mobile client access
               - SEO optimization for marketing pages

            4. Client Experience Optimizations:
               - Real-time collaboration performance
               - File upload/download speed improvements
               - Project dashboard loading optimization
               - Notification system performance
               - Billing and payment processing speed
               - Mobile responsiveness and performance

            Specific Optimization Areas:
            1. Client Portal Performance:
               - Dashboard load time optimization
               - Real-time updates via WebSocket optimization
               - File management system performance
               - Project timeline and milestone loading
               - Client search and filtering performance

            2. API Performance:
               - Client authentication and authorization speed
               - Project data retrieval optimization
               - File upload/download streaming
               - Billing calculation and invoice generation
               - Multi-tenant data access optimization

            3. Marketing Website Performance:
               - Landing page load speed optimization
               - Portfolio gallery performance
               - Contact form submission speed
               - SEO score and Core Web Vitals improvement
               - Mobile page speed optimization

            4. Infrastructure Performance:
               - Cloudflare Pages deployment optimization
               - Database query caching strategies
               - CDN optimization for static assets
               - Monitoring and alerting for performance degradation
               - Auto-scaling for client portal traffic

            Actions to Take:
            1. Implement performance improvements with client impact metrics
            2. Add performance monitoring for client workflows
            3. Create performance benchmarks for client scenarios
            4. Document optimization decisions and client benefits
            5. Create pull requests with performance improvements
            6. Ensure optimizations enhance client satisfaction

            Focus on optimizations that directly improve client experience and service delivery.
            Ensure improvements maintain data security and system reliability.
          PROMPT
          )" \
            --model iflowcn/qwen3-coder-plus \
            --share false \

      - name: Improve Documentation
        id: improve-documentation
        timeout-minutes: 10
        run: |
          opencode run "$(cat <<'PROMPT'
            Improve documentation for JasaWeb - Web Development Service Platform:

            Documentation Improvement Strategy:
            1. Documentation Audit:
               - Review client-facing documentation for clarity
               - Identify outdated service descriptions
               - Check for missing client onboarding guides
               - Analyze developer documentation completeness
               - Review API documentation for client portal
               - Check for consistency in service descriptions

            2. Client-Focused Documentation:
               - Update service descriptions (School Websites, News Portals, Company Profiles)
               - Improve client onboarding guides
               - Add client portal user guides
               - Create project management workflow documentation
               - Enhance billing and payment documentation
               - Improve troubleshooting guides for clients

            3. Developer Documentation:
               - Update Astro/NestJS/PostgreSQL stack documentation
               - Improve monorepo structure documentation
               - Add Prisma schema and migration guides
               - Enhance API documentation for client portal
               - Update deployment and CI/CD documentation
               - Add multi-tenant architecture documentation

            4. Business Documentation:
               - Service offering documentation
               - Pricing and package descriptions
               - Case study and portfolio documentation
               - Client success story templates
               - Sales and marketing collateral
               - Service delivery process documentation

            Documentation Areas to Improve:
            1. Client Portal Documentation:
               - Complete user guides for project management
               - File upload and collaboration workflows
               - Milestone tracking and approval processes
               - Billing and payment guides
               - Team member and permission management

            2. Service Documentation:
               - Detailed service descriptions and features
               - Pricing tiers and package comparisons
               - Technology stack explanations for clients
               - Portfolio and case study documentation
               - Client onboarding and offboarding guides

            3. Developer Documentation:
               - Monorepo structure and package organization
               - Astro frontend development guidelines
               - NestJS backend API documentation
               - PostgreSQL/Prisma data layer documentation
               - Testing and quality assurance processes
               - Deployment and infrastructure documentation

            4. Business Operations:
               - Lead generation and conversion processes
               - Project management and delivery workflows
               - Client communication and support procedures
               - Quality assurance and testing processes
               - Service level agreements and guarantees

            Actions to Take:
            1. Update client documentation with service focus
            2. Add comprehensive developer onboarding guides
            3. Improve API documentation for client portal
            4. Create interactive documentation and tutorials
            5. Add video guides for client workflows
            6. Create pull requests for documentation improvements

            Focus on documentation that enhances client acquisition and retention.
            Ensure documentation reflects JasaWeb's professional service offerings.
          PROMPT
          )" \
            --model iflowcn/qwen3-coder \
            --share false \
            --non-interactive \

      - name: Generate Development Report
        id: development-report
        timeout-minutes: 10
        run: |
          opencode run "$(cat <<'PROMPT'
            Generate comprehensive autonomous development report for JasaWeb - Web Development Service Platform:

            Report Components:
            1. Development Summary:
               - Client-facing features implemented and business impact
               - Client portal enhancements and user experience improvements
               - Lead generation and conversion optimization features
               - Service delivery automation improvements
               - Performance optimizations for client workflows
               - Documentation enhancements for clients and developers

            2. Business Impact Assessment:
               - Client acquisition and retention improvements
               - Service delivery efficiency gains
               - Lead conversion rate improvements
               - Client satisfaction and NPS improvements
               - Operational cost reductions
               - Competitive advantage enhancements

            3. Technical Metrics:
               - Client portal performance improvements
               - API response time optimizations
               - Database query performance gains
               - Frontend load time improvements
               - SEO score and Core Web Vitals improvements
               - System reliability and uptime improvements

            4. Client Experience Metrics:
               - Client portal usability improvements
               - Project management workflow efficiency
               - File upload/download performance
               - Billing and payment processing speed
               - Mobile responsiveness and accessibility
               - Support ticket resolution times

            5. Service Delivery Enhancements:
               - Automated project kickoff improvements
               - Template-based development acceleration
               - Quality assurance and testing automation
               - Deployment and delivery speed improvements
               - Client communication and collaboration tools
               - Reporting and analytics capabilities

            6. Future Business Recommendations:
               - Next service offering enhancements
               - Client experience improvement roadmap
               - Lead generation optimization priorities
               - Service delivery automation opportunities
               - Competitive differentiation strategies
               - Technology stack evolution plans

            Report Format:
            1. Executive summary with business impact highlights
            2. Client-facing feature implementation summary
            3. Performance and business metrics dashboard
            4. Client satisfaction and retention analysis
            5. Competitive positioning and market impact

            Create this report as:
            - GitHub issue with business impact labels
            - Detailed report in docs/business-development-report.html
            - Client-centric summary in workflow artifacts
            - Update business metrics dashboard

            Include actionable next steps focused on client value and business growth.
          PROMPT
          )" \
            --model iflowcn/qwen3-max \
            --share false \

      - name: Schedule Next Development Cycle
        id: schedule-next
        timeout-minutes: 5
        run: |
          opencode run "$(cat <<'PROMPT'
            Schedule next autonomous development cycle for JasaWeb - Web Development Service Platform:

            Based on current development results and business impact, determine:

            1. Next Business Cycle Planning:
               - Recommended client experience focus areas
               - Priority level for client acquisition features
               - Service delivery enhancement requirements
               - Competitive differentiation opportunities
               - Client retention and satisfaction goals

            2. Service Development Roadmap:
               - Short-term client portal improvements (1-2 weeks)
               - Medium-term service delivery enhancements (1-2 months)
               - Long-term market expansion strategies (3-6 months)
               - Feature prioritization by client impact
               - Resource allocation for service excellence

            3. Client-Centric Process Improvements:
               - Client onboarding and onboarding workflow enhancements
               - Project management and collaboration improvements
               - Billing and payment process optimizations
               - Support and communication system upgrades
               - Quality assurance and client satisfaction metrics

            4. Business Growth Initiatives:
               - Lead generation and conversion optimization
               - Service offering expansion opportunities
               - Client success story development
               - Competitive analysis and positioning
               - Partnership and integration opportunities

            5. Technology and Infrastructure:
               - Scalability planning for client growth
               - Performance optimization for client workflows
               - Security enhancements for client data
               - Monitoring and alerting for service reliability
               - Automation opportunities for service delivery

            Create GitHub issue with:
               - Next business development cycle schedule
               - Client experience enhancement roadmap
               - Service delivery improvement priorities
               - Business growth and competitive strategies

            Label with business impact and assign to product and development teams.
          PROMPT
          )" \
            --model iflowcn/qwen3-coder \
            --share false \

      - name: Create Development Summary
        if: always()
        run: |
          echo "## ðŸš€ JasaWeb Autonomous Developer Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ Business Development Cycle Details" >> $GITHUB_STEP_SUMMARY
          echo "- **Development Type**: $DEVELOPMENT_TYPE" >> $GITHUB_STEP_SUMMARY
          echo "- **Priority Level**: $PRIORITY" >> $GITHUB_STEP_SUMMARY
          echo "- **Cycle Duration**: 60 minutes" >> $GITHUB_STEP_SUMMARY
          echo "- **Focus**: Web Development Service Platform Enhancement" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸŽ¯ Business Development Activities" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… JasaWeb business model analysis completed" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Client portal features implemented" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Client experience bugs identified and fixed" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Service delivery performance optimizations applied" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Client and developer documentation improved" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Business impact report generated" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Next business development cycle scheduled" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š Business Impact" >> $GITHUB_STEP_SUMMARY
          echo "- **Client Experience**: Enhanced portal functionality and usability" >> $GITHUB_STEP_SUMMARY
          echo "- **Service Delivery**: Improved project management and collaboration" >> $GITHUB_STEP_SUMMARY
          echo "- **Performance**: Optimized client workflows and responsiveness" >> $GITHUB_STEP_SUMMARY
          echo "- **Documentation**: Better client onboarding and support materials" >> $GITHUB_STEP_SUMMARY
          echo "- **Competitive Edge**: Enhanced service offerings and automation" >> $GITHUB_STEP_SUMMARY
          echo "- **Growth**: Improved lead conversion and client retention" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸš€ Next Business Steps" >> $GITHUB_STEP_SUMMARY
          echo "- Review business impact report and client metrics" >> $GITHUB_STEP_SUMMARY
          echo "- Monitor client portal enhancements and satisfaction" >> $GITHUB_STEP_SUMMARY
          echo "- Prepare for next business development cycle" >> $GITHUB_STEP_SUMMARY
          echo "- Address client feedback and service improvements" >> $GITHUB_STEP_SUMMARY
          echo "- Continue competitive differentiation and growth initiatives" >> $GITHUB_STEP_SUMMARY
