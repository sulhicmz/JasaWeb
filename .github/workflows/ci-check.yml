name: ci check

on:
  workflow_dispatch:
  workflow_run:
    workflows: ["oc standarizer"]
    types: [completed]

permissions:
  contents: write
  actions: write
  pull-requests: write
  checks: write

concurrency:
  group: ci-check-${{ github.ref }}
  cancel-in-progress: true

jobs:
  validate-and-build:
    name: Full Stack Validation
    runs-on: ubuntu-24.04-arm
    timeout-minutes: 30
    
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: root
          POSTGRES_PASSWORD: rootpassword
          POSTGRES_DB: jasaweb_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    outputs:
      typecheck-status: ${{ steps.typecheck.outcome }}
      typecheck-time: ${{ steps.typecheck.outputs.time }}
      lint-status: ${{ steps.lint.outcome }}
      lint-time: ${{ steps.lint.outputs.time }}
      lint-errors: ${{ steps.lint.outputs.errors }}
      lint-warnings: ${{ steps.lint.outputs.warnings }}
      test-status: ${{ steps.test.outcome }}
      test-time: ${{ steps.test.outputs.time }}
      test-count: ${{ steps.test.outputs.count }}
      test-failed: ${{ steps.test.outputs.failed }}
      build-status: ${{ steps.build.outcome }}
      build-time: ${{ steps.build.outputs.time }}
      e2e-status: ${{ steps.e2e.outcome }}
      e2e-time: ${{ steps.e2e.outputs.time }}
      bundle-size: ${{ steps.perf.outputs.size-kb }}
      gzip-size: ${{ steps.perf.outputs.gzip-kb }}
      perf-score: ${{ steps.perf.outputs.score }}
      perf-grade: ${{ steps.perf.outputs.grade }}
      audit-critical: ${{ steps.audit.outputs.critical }}
      audit-high: ${{ steps.audit.outputs.high }}
      audit-moderate: ${{ steps.audit.outputs.moderate }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Standardized Node.js Setup
        continue-on-error: true
        uses: ./.github/workflows/setup
        with:
          node-version: 20
          cache-scope: 'ci-unified'
          install-deps: 'true'

      # --- PARALLEL EXECUTION STRATEGY ---
      # We run these sequentially in one job to save runner startup time, 
      # but they are logically distinct.
      
      - name: Type Check
        id: typecheck
        continue-on-error: true
        run: |
          START=$(date +%s.%N)
          pnpm typecheck
          END=$(date +%s.%N)
          echo "time=$(echo "$END - $START" | bc -l)" >> $GITHUB_OUTPUT

      - name: Lint
        id: lint
        continue-on-error: true
        run: |
          START=$(date +%s.%N)
          pnpm lint -- --format=json > lint-report.json || true
          END=$(date +%s.%N)
          echo "time=$(echo "$END - $START" | bc -l)" >> $GITHUB_OUTPUT
          
          # Handle case where file might be empty if lint crashes or produces no output
          if [ -s lint-report.json ]; then
            # jq might fail if output isn't valid JSON (e.g. plain text error), so we guard it
            ERRORS=$(jq '.[] | select(.severity == 2) | .ruleId' lint-report.json 2>/dev/null | wc -l || echo "1")
            WARNINGS=$(jq '.[] | select(.severity == 1) | .ruleId' lint-report.json 2>/dev/null | wc -l || echo "0")
          else 
            echo "Lint output empty or failed"
            ERRORS=1
            WARNINGS=0
          fi
          
          echo "errors=$ERRORS" >> $GITHUB_OUTPUT
          echo "warnings=$WARNINGS" >> $GITHUB_OUTPUT

      - name: Unit Test
        id: test
        continue-on-error: true
        run: |
          START=$(date +%s.%N)
          pnpm test -- --reporter=verbose --no-color > test.log || true
          END=$(date +%s.%N)
          echo "time=$(echo "$END - $START" | bc -l)" >> $GITHUB_OUTPUT
          
          COUNT=$(grep -c "âœ“" test.log || echo "0")
          FAILED=$(grep -c "âœ—" test.log || echo "0")
          echo "count=$COUNT" >> $GITHUB_OUTPUT
          echo "failed=$FAILED" >> $GITHUB_OUTPUT

      - name: Build
        id: build
        continue-on-error: true
        run: |
          START=$(date +%s.%N)
          pnpm build
          END=$(date +%s.%N)
          echo "time=$(echo "$END - $START" | bc -l)" >> $GITHUB_OUTPUT

      - name: Install Playwright & Seed DB
        if: steps.build.outcome == 'success'
        run: |
          pnpm exec playwright install --with-deps chromium
          # Wait for Postgres
          until pg_isready -h localhost -p 5432; do echo "Waiting for database..."; sleep 2; done
          pnpm seed:e2e
        env:
          DATABASE_URL: "postgresql://root:rootpassword@localhost:5432/jasaweb_test"

      - name: E2E Smoke Tests
        id: e2e
        if: steps.build.outcome == 'success'
        continue-on-error: true
        run: |
          echo "::group::Playwright E2E"
          START=$(date +%s.%N)
          pnpm test:e2e
          END=$(date +%s.%N)
          echo "time=$(echo "$END - $START" | bc -l)" >> $GITHUB_OUTPUT
          echo "::endgroup::"
        env:
          DATABASE_URL: "postgresql://root:rootpassword@localhost:5432/jasaweb_test"
          JWT_SECRET: "super-secret-test-jwt-key"
          # Mocking R2/Midtrans inputs
          R2_ACCESS_KEY_ID: "mock"
          R2_SECRET_ACCESS_KEY: "mock"
          R2_BUCKET_NAME: "mock-bucket"
          R2_ACCOUNT_ID: "mock-account"
          MIDTRANS_SERVER_KEY: "mock-server-key"
          MIDTRANS_CLIENT_KEY: "mock-client-key"
          MIDTRANS_IS_PRODUCTION: "false"
          CI: true

      - name: Upload E2E Report
        if: always() && steps.e2e.outcome != 'skipped'
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 7

      - name: Security Audit
        id: audit
        continue-on-error: true
        run: |
          pnpm audit --prod --audit-level=moderate --json > audit.json || true
          if [ -s audit.json ]; then
             CRIT=$(jq '.metadata.vulnerabilities.critical' audit.json 2>/dev/null || echo "0")
             HIGH=$(jq '.metadata.vulnerabilities.high' audit.json 2>/dev/null || echo "0")
             MOD=$(jq '.metadata.vulnerabilities.moderate' audit.json 2>/dev/null || echo "0")
          else
             CRIT=0; HIGH=0; MOD=0
          fi
          echo "critical=$CRIT" >> $GITHUB_OUTPUT
          echo "high=$HIGH" >> $GITHUB_OUTPUT
          echo "moderate=$MOD" >> $GITHUB_OUTPUT
          
      - name: Performance Analysis
        continue-on-error: true
        id: perf
        if: steps.build.outcome == 'success'
        run: |
          if [ -d "dist/_astro" ]; then
             BUNDLE=$(find dist/_astro -name "client.*.js" | head -1)
             if [ -z "$BUNDLE" ]; then BUNDLE=$(find dist/_astro -name "*.js" | head -1); fi
             
             if [ -f "$BUNDLE" ]; then
                 SIZE=$(stat -c%s "$BUNDLE")
                 SIZE_KB=$((SIZE / 1024))
                 GZIP=$(gzip -c "$BUNDLE" | wc -c)
                 GZIP_KB=$((GZIP / 1024))
                 
                 echo "size-kb=${SIZE_KB}KB" >> $GITHUB_OUTPUT
                 echo "gzip-kb=${GZIP_KB}KB" >> $GITHUB_OUTPUT
                 
                 SCORE=100
                 if [ $SIZE_KB -gt 200 ]; then SCORE=$((SCORE - 20)); fi
                 if [ $SIZE_KB -gt 250 ]; then SCORE=$((SCORE - 30)); fi
                 
                 echo "score=$SCORE" >> $GITHUB_OUTPUT
                 if [ $SCORE -ge 90 ]; then echo "grade=A" >> $GITHUB_OUTPUT; 
                 elif [ $SCORE -ge 80 ]; then echo "grade=B" >> $GITHUB_OUTPUT;
                 else echo "grade=C" >> $GITHUB_OUTPUT; fi
             else
                 echo "size-kb=0KB" >> $GITHUB_OUTPUT; echo "gzip-kb=0KB" >> $GITHUB_OUTPUT; echo "score=0" >> $GITHUB_OUTPUT; echo "grade=F" >> $GITHUB_OUTPUT
             fi
          else
             echo "size-kb=0KB" >> $GITHUB_OUTPUT; echo "gzip-kb=0KB" >> $GITHUB_OUTPUT; echo "score=0" >> $GITHUB_OUTPUT; echo "grade=F" >> $GITHUB_OUTPUT
          fi

  report:
    name: Generate Health Report
    needs: validate-and-build
    runs-on: ubuntu-24.04-arm
    if: always()
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref || github.ref_name }}
          token: ${{ secrets.GH_TOKEN }}

      - name: Standardized Node.js Setup
        continue-on-error: true
        uses: ./.github/workflows/setup
        with:
           install-deps: 'true'

      - name: Generate Report File
        env:
          typecheck_status: ${{ needs.validate-and-build.outputs.typecheck-status }}
          typecheck_time: ${{ needs.validate-and-build.outputs.typecheck-time }}
          lint_status: ${{ needs.validate-and-build.outputs.lint-status }}
          lint_time: ${{ needs.validate-and-build.outputs.lint-time }}
          lint_errors: ${{ needs.validate-and-build.outputs.lint-errors }}
          lint_warnings: ${{ needs.validate-and-build.outputs.lint-warnings }}
          test_status: ${{ needs.validate-and-build.outputs.test-status }}
          test_time: ${{ needs.validate-and-build.outputs.test-time }}
          test_count: ${{ needs.validate-and-build.outputs.test-count }}
          test_failed: ${{ needs.validate-and-build.outputs.test-failed }}
          build_status: ${{ needs.validate-and-build.outputs.build-status }}
          build_time: ${{ needs.validate-and-build.outputs.build-time }}
          e2e_status: ${{ needs.validate-and-build.outputs.e2e-status }}
          e2e_time: ${{ needs.validate-and-build.outputs.e2e-time }}
          bundle_size: ${{ needs.validate-and-build.outputs.bundle-size }}
          gzip_size: ${{ needs.validate-and-build.outputs.gzip-size }}
          perf_score: ${{ needs.validate-and-build.outputs.perf-score }}
          perf_grade: ${{ needs.validate-and-build.outputs.perf-grade }}
          audit_critical: ${{ needs.validate-and-build.outputs.audit-critical }}
          audit_high: ${{ needs.validate-and-build.outputs.audit-high }}
          audit_moderate: ${{ needs.validate-and-build.outputs.audit-moderate }}
          CHECKS_FAILED: ${{ (needs.validate-and-build.outputs.typecheck-status == 'failure' || needs.validate-and-build.outputs.lint-status == 'failure' || needs.validate-and-build.outputs.test-status == 'failure' || needs.validate-and-build.outputs.build-status == 'failure' || needs.validate-and-build.outputs.e2e-status == 'failure') && 'true' || 'false' }}
        run: |
          export TYPECHECK_STATUS=$typecheck_status
          export TYPECHECK_TIME=$typecheck_time
          export LINT_STATUS=$lint_status
          export LINT_TIME=$lint_time
          export LINT_ERRORS=$lint_errors
          export LINT_WARNINGS=$lint_warnings
          export TEST_STATUS=$test_status
          export TEST_TIME=$test_time
          export TEST_COUNT=$test_count
          export TEST_FAILED=$test_failed
          export BUILD_STATUS=$build_status
          export BUILD_TIME=$build_time
          export E2E_STATUS=$e2e_status
          export E2E_TIME=$e2e_time
          export BUNDLE_SIZE=$bundle_size
          export GZIP_SIZE=$gzip_size
          export PERF_SCORE=$perf_score
          export PERF_GRADE=$perf_grade
          export AUDIT_CRITICAL=$audit_critical
          export AUDIT_HIGH=$audit_high
          export AUDIT_MODERATE=$audit_moderate
          
          # Run the typescript script directly
          npx tsx scripts/generate-health-report.ts

      - name: Save Report to Agent Workspace
        continue-on-error: true
        if: always()
        run: |
          # 1. Temporarily save the generated report
          cp docs/system-health.md /tmp/system-health.md
          
          # 2. Configure Git
          git config --global user.name "sulhicmz-bot"
          git config --global user.email "bot@sulhicmz.com"
          
          # 3. Checkout target branch (agent-workspace)
          git fetch --all
          
          if git show-ref --verify --quiet refs/remotes/origin/agent-workspace; then
            echo "Branch exists on remote. Checking it out..."
            git checkout -B agent-workspace origin/agent-workspace
          else
            echo "Branch does not exist on remote. Creating orphan/new..."
            git checkout -B agent-workspace
          fi
          
          # 4. Restore report to the correct location
          mkdir -p docs
          cp /tmp/system-health.md docs/system-health.md
          
          # 5. Commit and Push to agent-workspace (Not Protected)
          git add docs/system-health.md
          if git diff --staged --quiet; then
            echo "No changes to report"
          else
            git commit -m "chore(ci): update system health report [skip ci]"
            git push origin agent-workspace
          fi

      - name: Trigger Smart CI (If Failed)
        if: env.CHECKS_FAILED == 'true'
        env:
           GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
           echo "ðŸš¨ Checks failed. Triggering Smart CI..."
           gh workflow run "oc smart-ci.yml" --ref ${{ github.ref_name }}
