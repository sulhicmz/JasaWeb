name: oc bug finder

on:
  schedule:
    - cron: '0 * * * *'
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  issues: write
  actions: write

concurrency:
  group: global
  cancel-in-progress: false

jobs:
  opencode:
    name: oc bug finder
    runs-on: ubuntu-24.04-arm
    timeout-minutes: 40
    if: github.event_name == 'workflow_dispatch' || github.event_name == 'schedule'

    permissions:
      id-token: write
      contents: write
      pull-requests: write
      issues: write
      actions: write
      
    env:
      GH_TOKEN: ${{ secrets.GH_TOKEN }}
      IFLOW_API_KEY: ${{ secrets.IFLOW_API_KEY }}
      
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 1

      - name: Install OpenCode CLI
        run: |
        
          curl -fsSL https://opencode.ai/install | bash
          echo "$HOME/.opencode/bin" >> $GITHUB_PATH

      - name: Run OpenCode
        id: run_oc
        timeout-minutes: 60
        run: |
          opencode run "$(cat <<'PROMPT'
            **Role**: Senior Software Architect & Developer
            **Context**: JasaWeb - Web Development Service Platform (Astro, NestJS, PostgreSQL, Prisma, Tailwind).

            **Strict Standards**:
            1. **Type Safety**: TypeScript Strict Mode. No `any` types permitted.
            2. **UI/UX**: Mobile-First responsiveness (Tailwind). Professional service platform aesthetic.
            3. **Architecture**: Monorepo structure with apps/ and packages/. Use Prisma for data access. Respect packages/ for shared utilities.
            4. **Security**: Validate inputs. Implement proper authentication and multi-tenancy.

            **Objective**:
            Choose **ONE** high-impact, clearly scoped task for JasaWeb:
            - Improve client portal functionality and project management features.
            - Fix critical bugs in API endpoints or database operations.
            - Optimize frontend performance and SEO for marketing pages.
            - Enhance admin dashboard and CRM capabilities.

            **CRITICAL: EPHEMERAL ENVIRONMENT WARNING**:
            - This runs in a temporary GitHub Action runner. **ALL CHANGES WILL BE LOST** if you do not push.
            - **YOU MUST** execute the following commands at the end of your work:
              1. `git config --global user.name "bug fixer"`
              2. `git config --global user.email "22936450+sulhicmz@users.noreply.github.com"`
              3. `git add .`
              4. `git commit -m "feat: [Task Name] implementation"`
              5. `git push origin main` (OR create a PR if you cannot push directly)

            **Execution Protocol**:
            1. **Analysis**: Understand JasaWeb's business model (web development services).
            2. **Implementation**: Incremental changes respecting monorepo structure.
            3. **Verification**: Code MUST build and pass quality checks.
            4. **Persistence**: **EXECUTE GIT PUSH**.

            **Deliverables**:
            - Clearly state the selected task and business impact.
            - Provide the code changes with proper documentation.
            - Update relevant documentation and tests.
            - **SUCCESSFUL GIT PUSH TO MAIN**.
          PROMPT
          )" \
            --model iflowcn/glm-4.6 \
            --share false \
      - name: Run OpenCode1
        id: run_oc1
        timeout-minutes: 60
        run: |
          opencode run "$(cat <<'PROMPT'
            **Role**: Senior Software Architect & Developer
            **Context**: JasaWeb - Web Development Service Platform (Astro, NestJS, PostgreSQL, Prisma, Tailwind).

            **Objective**:
            Execute the **Highest Priority** task for JasaWeb's business model OR continue enhancing the service platform.

            **Strict Standards**:
            1. **Type Safety**: TypeScript Strict Mode. No `any` types permitted.
            2. **UI/UX**: Mobile-First responsiveness (Tailwind). Professional service platform aesthetic.
            3. **Architecture**: Monorepo structure with apps/ and packages/. Use Prisma for data access. Respect packages/ for shared utilities.
            4. **Security**: Validate inputs. Implement proper authentication and multi-tenancy.

            **CRITICAL: EPHEMERAL ENVIRONMENT WARNING**:
            - This runs in a temporary GitHub Action runner. **ALL CHANGES WILL BE LOST** if you do not push.
            - **YOU MUST** execute the following commands at the end of your work:
              1. `git config --global user.name "bug fixer"`
              2. `git config --global user.email "22936450+sulhicmz@users.noreply.github.com"`
              3. `git add .`
              4. `git commit -m "feat: [Task Name] implementation"`
              5. `git push origin main` (OR create a PR if you cannot push directly)

            **Execution Protocol**:
            1. **Analysis**: Understand JasaWeb's business model (web development services).
            2. **Implementation**: Incremental changes respecting monorepo structure.
            3. **Verification**: Code MUST build and pass quality checks.
            4. **Persistence**: **EXECUTE GIT PUSH**.

            **Deliverables**:
            - Clearly state the selected task and business impact.
            - Provide the code changes with proper documentation.
            - Update relevant documentation and tests.
            - **SUCCESSFUL GIT PUSH TO MAIN**.
          PROMPT
          )" \
            --model iflowcn/glm-4.6 \
            --share false
