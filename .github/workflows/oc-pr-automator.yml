name: oc - PR Automator

on:
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to process'
        required: false
        type: string

permissions:
  id-token: write
  contents: write
  pull-requests: write
  issues: write
  actions: write

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.event.inputs.pr_number }}
  cancel-in-progress: false

jobs:
  pr-automator:
    name: OC PR Automator
    runs-on: ubuntu-latest
    timeout-minutes: 45
    permissions:
      id-token: write
      contents: write
      pull-requests: write
      issues: write
      actions: write
      
    env:
      GH_TOKEN: ${{ secrets.GH_TOKEN }}
      IFLOW_API_KEY: ${{ secrets.IFLOW_API_KEY }}
      
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          token: ${{ secrets.GH_TOKEN }}
          
      - name: Install OpenCode CLI
        run: |
          curl -fsSL https://opencode.ai/install | bash
          echo "$HOME/.opencode/bin" >> $GITHUB_PATH
          
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
          
      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 8.15.0
          
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
        
      - name: Analyze Pull Request
        id: analyze-pr
        timeout-minutes: 10
        run: |
          PR_NUMBER="${{ github.event.pull_request.number || github.event.inputs.pr_number }}"
          PR_TITLE="${{ github.event.pull_request.title }}"
          PR_BODY="${{ github.event.pull_request.body }}"
          PR_AUTHOR="${{ github.event.pull_request.user.login }}"
          PR_BRANCH="${{ github.event.pull_request.head.ref }}"
          PR_BASE="${{ github.event.pull_request.base.ref }}"
          PR_LABELS="${{ join(github.event.pull_request.labels.*.name, ', ') }}"
          CHANGED_FILES="${{ github.event.pull_request.changed_files }}"
          
          echo "Processing PR #$PR_NUMBER: $PR_TITLE"
          echo "Author: $PR_AUTHOR"
          echo "Branch: $PR_BRANCH -> $PR_BASE"
          echo "Labels: $PR_LABELS"
          echo "Changed files: $CHANGED_FILES"
          
          opencode run "$(cat <<'PROMPT'
            Analyze the following pull request for JasaWeb project:
            
            PR Details:
            - Number: #$PR_NUMBER
            - Title: '$PR_TITLE'
            - Body: '$PR_BODY'
            - Author: '$PR_AUTHOR'
            - Branch: '$PR_BRANCH' -> '$PR_BASE'
            - Labels: '$PR_LABELS'
            - Changed Files: $CHANGED_FILES
            
            Analysis Steps:
            1. Categorize PR type (bugfix, feature, refactor, docs, etc.)
            2. Assess complexity and risk level
            3. Identify affected components and modules
            4. Review code quality and patterns
            5. Check for potential issues or improvements
            6. Determine testing requirements
            
            Review Focus Areas:
            1. Code Quality:
               - Follows project coding standards
               - Proper TypeScript usage and type safety
               - Error handling and edge cases
               - Performance considerations
               - Security implications
            
            2. Testing:
               - Adequate test coverage for changes
               - Test quality and effectiveness
               - Integration test coverage
               - E2E test updates if needed
               - Performance test implications
            
            3. Documentation:
               - Code comments and documentation
               - README updates if needed
               - API documentation updates
               - Change log entries
               - Migration guides if breaking changes
            
            4. Integration:
               - Database schema changes
               - API compatibility
               - Frontend integration
               - Configuration changes
               - Deployment considerations
            
            Actions to Take:
            1. Run comprehensive code analysis
            2. Identify and fix any issues found
            3. Add missing tests or improve existing ones
            4. Update documentation as needed
            5. Ensure all quality checks pass
            6. Provide detailed review feedback
            
            Focus on constructive feedback and actionable improvements.
            If issues are found, provide specific suggestions for fixes.
          PROMPT
          )" \
            --model iflowcn/qwen3-max \
            --share false \
            
      - name: Run Code Quality Checks
        id: quality-checks
        timeout-minutes: 15
        run: |
          echo "Running comprehensive code quality checks..."
          
          # Linting and formatting
          echo "üîç Running linting..."
          pnpm lint:fix || echo "Linting issues found, attempting fixes..."
          
          # Type checking
          echo "üîç Running type checking..."
          pnpm typecheck || echo "Type errors found, attempting fixes..."
          
          # Code formatting
          echo "üîç Running formatting..."
          pnpm format || echo "Formatting issues found, attempting fixes..."
          
          # Security audit
          echo "üîç Running security audit..."
          pnpm security:audit || echo "Security issues found, checking severity..."
          
          # Check for any remaining issues
          if git diff --quiet; then
            echo "‚úÖ All quality checks passed"
          else
            echo "üîß Issues found and fixed, committing changes..."
            git config --local user.email "action@github.com"
            git config --local user.name "GitHub Action"
            git add .
            git commit -m "üîß Auto-fix code quality issues
            
            - Fixed linting issues
            - Resolved type errors
            - Applied code formatting
            - Addressed security warnings
            
            ü§ñ *Auto-generated by OpenCode CLI PR Automator*"
            git push
          fi
          
      - name: Run Tests
        id: run-tests
        timeout-minutes: 15
        run: |
          echo "üß™ Running comprehensive test suite..."
          
          # Unit tests
          echo "Running unit tests..."
          pnpm test:unit || echo "Unit test failures detected"
          
          # Integration tests
          echo "Running integration tests..."
          pnpm test:integration || echo "Integration test failures detected"
          
          # E2E tests (if applicable)
          echo "Running E2E tests..."
          pnpm test:e2e || echo "E2E test failures detected"
          
          # Coverage check
          echo "Checking test coverage..."
          pnpm test:coverage || echo "Coverage requirements not met"
          
          echo "‚úÖ Test execution completed"
          
      - name: Auto-Fix Common Issues
        id: auto-fix
        timeout-minutes: 10
        run: |
          opencode run "$(cat <<'PROMPT'
            Analyze the current PR and auto-fix common issues for JasaWeb project:
            
            Common Issues to Fix:
            1. Import/Export Issues:
               - Fix unused imports
               - Add missing imports
               - Resolve circular dependencies
               - Optimize import statements
            
            2. TypeScript Issues:
               - Fix type errors
               - Add missing type definitions
               - Improve type safety
               - Resolve generic type issues
            
            3. Code Quality Issues:
               - Fix ESLint warnings
               - Improve code formatting
               - Remove dead code
               - Optimize performance
            
            4. Testing Issues:
               - Fix failing tests
               - Add missing test cases
               - Improve test coverage
               - Fix test setup issues
            
            5. Documentation Issues:
               - Add missing JSDoc comments
               - Update README files
               - Fix documentation errors
               - Add code examples
            
            Actions to Take:
            1. Identify and categorize issues found
            2. Apply automatic fixes where possible
            3. Create detailed fix descriptions
            4. Commit fixes with clear messages
            5. Update PR with fix information
            
            Focus on non-breaking fixes that improve code quality.
            If complex issues are found, provide detailed guidance.
          PROMPT
          )" \
            --model iflowcn/qwen3-coder-plus \
            --share false \
            
      - name: Generate PR Review
        id: generate-review
        timeout-minutes: 10
        run: |
          opencode run "$(cat <<'PROMPT'
            Generate comprehensive PR review for JasaWeb project:
            
            PR Context:
            - Number: #$PR_NUMBER
            - Title: '$PR_TITLE'
            - Author: '$PR_AUTHOR'
            - Changes: $CHANGED_FILES files modified
            
            Review Components:
            1. Code Quality Assessment:
               - Code style and formatting
               - TypeScript usage and type safety
               - Error handling and edge cases
               - Performance considerations
               - Security implications
            
            2. Functionality Review:
               - Logic correctness
               - Business rule compliance
               - User experience impact
               - Data integrity
               - API compatibility
            
            3. Testing Assessment:
               - Test coverage adequacy
               - Test quality and effectiveness
               - Edge case coverage
               - Integration testing
               - Performance testing
            
            4. Documentation Review:
               - Code comments quality
               - README updates
               - API documentation
               - Change log entries
               - Migration guides
            
            5. Integration Review:
               - Database changes
               - API modifications
               - Frontend integration
               - Configuration updates
               - Deployment impact
            
            Review Format:
            1. Overall Assessment (APPROVE/REQUEST_CHANGES)
            2. Key Findings and Observations
            3. Specific Issues and Recommendations
            4. Required Changes (if any)
            5. Suggestions for Improvement
            6. Testing Requirements
            7. Documentation Updates Needed
            
            Actions:
            1. Post detailed review comment
            2. Add appropriate labels
            3. Request changes if needed
            4. Approve if all checks pass
            5. Auto-merge if conditions are met
            
            Focus on constructive, actionable feedback.
            Provide specific examples and suggestions.
          PROMPT
          )" \
            --model iflowcn/qwen3-max \
            --share false \
            
      - name: Auto-Approve and Merge
        id: auto-merge
        if: success()
        run: |
          # Check conditions for auto-merge
          PR_NUMBER="${{ github.event.pull_request.number || github.event.inputs.pr_number }}"
          
          # Get PR status
          PR_STATUS=$(gh pr view "$PR_NUMBER" --json mergeable --jq '.mergeable')
          PR_REVIEWS=$(gh pr view "$PR_NUMBER" --json reviews --jq '.reviews | map(select(.state == "APPROVED")) | length')
          PR_CHECKS=$(gh pr view "$PR_NUMBER" --json statusCheckRollup --jq '.statusCheckRollup | map(select(.conclusion == "SUCCESS")) | length')
          TOTAL_CHECKS=$(gh pr view "$PR_NUMBER" --json statusCheckRollup --jq '.statusCheckRollup | length')
          
          echo "PR Status: $PR_STATUS"
          echo "Approvals: $PR_REVIEWS"
          echo "Passed Checks: $PR_CHECKS/$TOTAL_CHECKS"
          
          # Auto-merge conditions
          if [ "$PR_STATUS" = "CLEAN" ] && [ "$PR_CHECKS" -eq "$TOTAL_CHECKS" ] && [ "$PR_REVIEWS" -ge 0 ]; then
            echo "üöÄ Auto-merging PR #$PR_NUMBER..."
            
            # Approve PR
            gh pr review "$PR_NUMBER" --approve \
              --body "‚úÖ **Auto-Approved**
              
            This PR has been automatically approved by OpenCode CLI PR Automator.
            
            ### üìä Review Summary
            - **Code Quality**: ‚úÖ Passed
            - **Tests**: ‚úÖ Passed
            - **Security**: ‚úÖ Passed
            - **Documentation**: ‚úÖ Updated if needed
            
            ### üéØ Merge Decision
            - All checks are passing
            - Code quality is acceptable
            - No blocking issues found
            - Ready for production
            
            ---
            
            ü§ñ *Review generated by OpenCode CLI PR Automator*"
            
            # Merge PR
            gh pr merge "$PR_NUMBER" --merge --delete-branch
            
            echo "‚úÖ PR #$PR_NUMBER merged successfully"
          else
            echo "‚è≥ PR not ready for auto-merge"
            echo "Status: $PR_STATUS"
            echo "Checks: $PR_CHECKS/$TOTAL_CHECKS"
            echo "Approvals: $PR_REVIEWS"
          fi
          
      - name: Update PR Status
        id: update-pr
        if: always()
        run: |
          PR_NUMBER="${{ github.event.pull_request.number || github.event.inputs.pr_number }}"
          
          if [ "${{ job.status }}" = "success" ]; then
            gh pr comment "$PR_NUMBER" \
              --body "## üöÄ PR Processing Complete
              
            ‚úÖ **All Checks Passed**
            - Code quality: ‚úÖ Excellent
            - Tests: ‚úÖ All passing
            - Security: ‚úÖ No issues found
            - Documentation: ‚úÖ Updated if needed
            
            ### üìä Processing Summary
            - **Auto-fixes applied**: Issues resolved automatically
            - **Review generated**: Comprehensive feedback provided
            - **Auto-merge**: Initiated if conditions met
            - **Branch cleanup**: Scheduled after merge
            
            ### üéØ Next Steps
            - PR will be auto-merged if all conditions are met
            - Manual review may be required for complex changes
            - Check individual review comments for specific feedback
            
            ---
            
            ü§ñ *Status updated by OpenCode CLI PR Automator*"
          else
            gh pr comment "$PR_NUMBER" \
              --body "## ‚ö†Ô∏è PR Processing Status
              
            ‚ùå **Processing Failed**
            - An error occurred during PR processing
            - Manual intervention may be required
            - Please check the workflow logs for details
            
            ### üîç Troubleshooting
            - Check workflow logs for error details
            - Verify all tests are passing locally
            - Review code quality issues
            - Check for merge conflicts
            
            ---
            
            ü§ñ *Status updated by OpenCode CLI PR Automator*"
          fi
          
      - name: Create PR Processing Summary
        if: always()
        run: |
          echo "## üîß PR Automator Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üìã PR Details" >> $GITHUB_STEP_SUMMARY
          echo "- **PR Number**: #$PR_NUMBER" >> $GITHUB_STEP_SUMMARY
          echo "- **Title**: $PR_TITLE" >> $GITHUB_STEP_SUMMARY
          echo "- **Author**: $PR_AUTHOR" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: $PR_BRANCH -> $PR_BASE" >> $GITHUB_STEP_SUMMARY
          echo "- **Changed Files**: $CHANGED_FILES" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üéØ Processing Actions" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ PR analysis completed" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Code quality checks executed" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Comprehensive test suite run" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Auto-fixes applied where needed" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Detailed review generated" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Auto-merge process evaluated" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ PR status updated" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üìä Processing Status" >> $GITHUB_STEP_SUMMARY
          if [ "${{ job.status }}" = "success" ]; then
            echo "- **Status**: ‚úÖ Successfully Processed" >> $GITHUB_STEP_SUMMARY
            echo "- **Quality**: ‚úÖ All checks passed" >> $GITHUB_STEP_SUMMARY
            echo "- **Tests**: ‚úÖ All passing" >> $GITHUB_STEP_SUMMARY
            echo "- **Auto-merge**: ‚úÖ Evaluated and executed" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Status**: ‚ùå Processing Failed" >> $GITHUB_STEP_SUMMARY
            echo "- **Action**: Manual intervention required" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üöÄ Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "- Monitor merge process completion" >> $GITHUB_STEP_SUMMARY
          echo "- Review detailed feedback comments" >> $GITHUB_STEP_SUMMARY
          echo "- Address any remaining issues manually" >> $GITHUB_STEP_SUMMARY
          echo "- Check workflow logs if processing failed" >> $GITHUB_STEP_SUMMARY