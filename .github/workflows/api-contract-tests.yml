name: API Contract Tests

# Run on pushes and PRs to main and develop branches
on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

# Environment variables
env:
  NODE_VERSION: '20'
  PNPM_VERSION: '8'

jobs:
  contract-tests:
    name: API Contract Tests
    runs-on: ubuntu-latest

    # Service containers for testing
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: password
          POSTGRES_DB: jasaweb_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

      redis:
        image: redis:7
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v3
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Setup test environment
        run: |
          cp .env.example .env.test
          echo "DATABASE_URL=postgresql://postgres:password@localhost:5432/jasaweb_test" >> .env.test
          echo "TEST_DATABASE_URL=postgresql://postgres:password@localhost:5432/jasaweb_test" >> .env.test
          echo "REDIS_URL=redis://localhost:6379" >> .env.test
          echo "JWT_SECRET=test-jwt-secret-for-contract-tests" >> .env.test
          echo "JWT_REFRESH_SECRET=test-refresh-secret-for-contract-tests" >> .env.test

      - name: Generate Prisma client
        run: pnpm db:generate
        env:
          DATABASE_URL: postgresql://postgres:password@localhost:5432/jasaweb_test

      - name: Run database migrations
        run: pnpm db:migrate
        env:
          DATABASE_URL: postgresql://postgres:password@localhost:5432/jasaweb_test

      - name: Build applications
        run: pnpm build
        env:
          NODE_ENV: test
          DATABASE_URL: postgresql://postgres:password@localhost:5432/jasaweb_test

      - name: Run API contract tests
        run: |
          cd apps/api
          pnpm vitest run test/contracts --reporter=verbose --reporter=json --outputFile=contract-test-results.json
        env:
          NODE_ENV: test
          DATABASE_URL: postgresql://postgres:password@localhost:5432/jasaweb_test
          TEST_DATABASE_URL: postgresql://postgres:password@localhost:5432/jasaweb_test

      - name: Upload contract test results
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: contract-test-results
          path: apps/api/contract-test-results.json

      - name: Generate contract test report
        run: |
          cd apps/api
          node -e "
            const results = JSON.parse(require('fs').readFileSync('contract-test-results.json', 'utf8'));
            const passed = results.testResults.filter(t => t.status === 'passed').length;
            const failed = results.testResults.filter(t => t.status === 'failed').length;
            const total = results.testResults.length;
            
            console.log('\\nüìä API Contract Test Report');
            console.log('========================');
            console.log(\`Total Tests: \${total}\`);
            console.log(\`‚úÖ Passed: \${passed}\`);
            console.log(\`‚ùå Failed: \${failed}\`);
            console.log(\`üìà Success Rate: \${((passed / total) * 100).toFixed(2)}%\`);
            
            if (failed > 0) {
              console.log('\\n‚ùå Failed Tests:');
              results.testResults
                .filter(t => t.status === 'failed')
                .forEach(t => {
                  console.log(\`  - \${t.name}: \${t.failureMessage}\`);
                });
            }
          "

  contract-validation:
    name: Contract Validation
    runs-on: ubuntu-latest
    needs: contract-tests

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Download contract test results
        uses: actions/download-artifact@v3
        with:
          name: contract-test-results
          path: apps/api/

      - name: Validate contract compliance
        run: |
          cd apps/api

          # Check if contract tests exist and have required structure
          if [ ! -f "contract-test-results.json" ]; then
            echo "‚ùå Contract test results not found"
            exit 1
          fi

          # Validate that all required endpoints have contract tests
          REQUIRED_ENDPOINTS=(
            "auth"
            "projects" 
            "dashboard"
            "files"
            "health"
          )

          for endpoint in "${REQUIRED_ENDPOINTS[@]}"; do
            if [ ! -f "test/contracts/${endpoint}.contract.test.ts" ]; then
              echo "‚ùå Missing contract test for endpoint: ${endpoint}"
              exit 1
            fi
          done

          echo "‚úÖ All required contract tests are present"

          # Validate test coverage
          node -e "
            const results = JSON.parse(require('fs').readFileSync('contract-test-results.json', 'utf8'));
            const passed = results.testResults.filter(t => t.status === 'passed').length;
            const total = results.testResults.length;
            const successRate = (passed / total) * 100;
            
            console.log(\`Contract test success rate: \${successRate.toFixed(2)}%\`);
            
            // Require at least 95% success rate for contract tests
            if (successRate < 95) {
              console.log('‚ùå Contract test success rate below 95% threshold');
              process.exit(1);
            }
            
            console.log('‚úÖ Contract test validation passed');
          "

  contract-comparison:
    name: Contract Comparison with main
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    needs: contract-tests

    steps:
      - name: Checkout PR code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Checkout main branch for comparison
        run: |
          git fetch origin main:main
          git checkout main

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Generate baseline contract tests
        run: |
          cp .env.example .env.test
          echo "DATABASE_URL=postgresql://postgres:password@localhost:5432/jasaweb_test" >> .env.test
          echo "TEST_DATABASE_URL=postgresql://postgres:password@localhost:5432/jasaweb_test" >> .env.test
          echo "JWT_SECRET=test-jwt-secret-for-contract-tests" >> .env.test
          echo "JWT_REFRESH_SECRET=test-refresh-secret-for-contract-tests" >> .env.test

          pnpm db:generate
          pnpm build

      - name: Compare contract test files
        run: |
          # Switch back to PR branch
          git checkout ${{ github.head_ref }}

          # Get list of changed contract test files
          CHANGED_FILES=$(git diff --name-only main...HEAD | grep -E "test/contracts/.*\.contract\.test\.ts$" || true)

          if [ -n "\$CHANGED_FILES" ]; then
            echo "üìù Changed contract test files:"
            echo "\$CHANGED_FILES"
            
            # Validate that contract changes don't break backward compatibility
            for file in \$CHANGED_FILES; do
              echo "üîç Analyzing changes in \$file..."
              
              # Check for breaking changes in contract tests
              if git diff main...HEAD -- "\$file" | grep -q "expect.*\.toBe.*undefined"; then
                echo "‚ö†Ô∏è  Potential breaking change detected in \$file"
                echo "  - Removal of expected fields detected"
              fi
              
              # Check for new contract tests (good)
              if git log main...HEAD -- "\$file" | grep -q "feat.*contract.*test\|add.*contract.*test"; then
                echo "‚úÖ New contract test added in \$file"
              fi
            done
          else
            echo "‚úÖ No contract test files changed"
          fi

  security-scan:
    name: Security Scan for Contract Tests
    runs-on: ubuntu-latest
    needs: contract-tests

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run security audit
        run: pnpm audit --audit-level moderate

      - name: Scan contract tests for security issues
        run: |
          echo "üîí Scanning contract tests for security issues..."

          # Check for hardcoded secrets in contract tests
          if grep -r "password.*=.*['\"]" apps/api/test/contracts/ | grep -v "SecurePass123\|SecurePassword"; then
            echo "‚ùå Potential hardcoded secrets found in contract tests"
            exit 1
          fi

          # Check for insecure test configurations
          if grep -r "NODE_ENV.*=.*production" apps/api/test/contracts/; then
            echo "‚ö†Ô∏è  Production environment usage in contract tests"
          fi

          # Verify proper cleanup in contract tests
          echo "‚úÖ Security scan completed"

  notify-results:
    name: Notify Test Results
    runs-on: ubuntu-latest
    needs: [contract-tests, contract-validation]
    if: always()

    steps:
      - name: Download contract test results
        uses: actions/download-artifact@v3
        with:
          name: contract-test-results
          path: results/

      - name: Generate summary
        run: |
          if [ -f "results/contract-test-results.json" ]; then
            node -e "
              const results = JSON.parse(require('fs').readFileSync('results/contract-test-results.json', 'utf8'));
              const total = results.testResults.length;
              const passed = results.testResults.filter(t => t.status === 'passed').length;
              const failed = results.testResults.filter(t => t.status === 'failed').length;
              
              console.log('## üìä API Contract Test Results\\n');
              console.log(\`- **Total Tests**: \${total}\\n\`);
              console.log(\`- **‚úÖ Passed**: \${passed}\\n\`);
              console.log(\`- **‚ùå Failed**: \${failed}\\n\`);
              console.log(\`- **üìà Success Rate**: \${((passed / total) * 100).toFixed(2)}%\\n\`);
              
              if (failed > 0) {
                console.log('### ‚ùå Failed Tests\\n');
                results.testResults
                  .filter(t => t.status === 'failed')
                  .forEach(t => {
                    console.log(\`- **\${t.name}**: \${t.failureMessage?.split('\\n')[0] || 'Unknown error'}\`);
                  });
              }
            "
          else
            echo "## ‚ùå Contract Test Results Not Available\\n"
            echo "Contract tests failed to produce results."
          fi
        continue-on-error: true
