name: oc - Workflow Monitoring

on:
  schedule:
    - cron: '0 * * * *' # Setiap jam
  workflow_dispatch:
    inputs:
      monitoring_type:
        description: 'Type of monitoring'
        required: false
        default: 'health-check'
        type: choice
        options:
          - health-check
          - performance-analysis
          - error-analysis
          - full-report

permissions:
  issues: write
  actions: read
  contents: read # Diperlukan untuk checkout

concurrency:
  group: ${{ github.workflow }}-global
  cancel-in-progress: true # Batalkan run sebelumnya jika ada yang baru

jobs:
  workflow-monitoring:
    name: OC Workflow Monitoring
    runs-on: self-hosted
    timeout-minutes: 10
    permissions:
      issues: write
      actions: read
      contents: read # Diperlukan untuk checkout
      
    env:
      GH_TOKEN: ${{ secrets.GH_TOKEN }}
      IFLOW_API_KEY: ${{ secrets.IFLOW_API_KEY }}
      
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          
      - name: Install OpenCode CLI
        run: |
          curl -fsSL https://opencode.ai/install | bash
          echo "$HOME/.opencode/bin" >> $GITHUB_PATH
      - name: Run opencode with non-interactive
        run: |
          opencode run --non-interactive
          
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 8.15.0
          
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
        
      - name: Monitor Workflow Health
        id: health-monitor
        timeout-minutes: 8
        run: |
          MONITORING_TYPE="${{ github.event.inputs.monitoring_type || 'health-check' }}"
          
          echo "Starting workflow monitoring..."
          echo "Monitoring Type: $MONITORING_TYPE"
          
          # Get workflow runs from last 24 hours
          WORKFLOWS=(
            "oc-pr-automator"
            "oc-efficient-automator" 
            "oc-code-quality-testing"
            "oc-autonomous-developer"
            "oc-maintenance-monitoring"
            "oc-security-scanning"
            "oc-issue-solver"
          )
          
          TOTAL_RUNS=0
          FAILED_RUNS=0
          SUCCESS_RATE=0
          CRITICAL_ISSUES=()
          
          for workflow in "${WORKFLOWS[@]}"; do
            echo "Analyzing workflow: $workflow"
            
            # Get recent runs
            RUNS_JSON=$(gh run list --workflow="$workflow.yml" --limit=10 --json status,conclusion,createdAt --jq '.')
            RECENT_RUNS=$(echo "$RUNS_JSON" | jq --arg time_24h_ago "$(date -u -d '24 hours ago' --iso-8601=seconds)" '[.[] | select(.createdAt > $time_24h_ago)]')
            
            if [ -n "$RECENT_RUNS" ] && [ "$(echo "$RECENT_RUNS" | jq 'length')" -gt 0 ]; then
              WORKFLOW_RUNS=$(echo "$RECENT_RUNS" | jq 'length')
              WORKFLOW_FAILURES=$(echo "$RECENT_RUNS" | jq '[.[] | select(.conclusion == "failure")] | length')
              
              if [ "$WORKFLOW_RUNS" -gt 0 ]; then
                WORKFLOW_SUCCESS_RATE=$(echo "scale=2; (100 * ($WORKFLOW_RUNS - $WORKFLOW_FAILURES)) / $WORKFLOW_RUNS" | bc)
              else
                WORKFLOW_SUCCESS_RATE=100
              fi
              
              TOTAL_RUNS=$((TOTAL_RUNS + WORKFLOW_RUNS))
              FAILED_RUNS=$((FAILED_RUNS + WORKFLOW_FAILURES))
              
              echo "  - Runs: $WORKFLOW_RUNS, Failures: $WORKFLOW_FAILURES, Success Rate: $WORKFLOW_SUCCESS_RATE%"
              
              # Check for critical issues (3+ consecutive failures)
              CONSECUTIVE_FAILURES=$(echo "$RECENT_RUNS" | jq -s '.[0:3] | if all(.conclusion == "failure") then 1 else 0 end')
              if [ "$CONSECUTIVE_FAILURES" -eq 1 ]; then
                CRITICAL_ISSUES+=("$workflow: 3+ consecutive failures")
              fi
            else
              echo "  - No recent runs found"
            fi
          done
          
          # Calculate overall success rate
          if [ "$TOTAL_RUNS" -gt 0 ]; then
            SUCCESS_RATE=$(echo "scale=2; (100 * ($TOTAL_RUNS - $FAILED_RUNS)) / $TOTAL_RUNS" | bc)
          fi
          
          echo "Overall Statistics:"
          echo "  - Total Runs: $TOTAL_RUNS"
          echo "  - Failed Runs: $FAILED_RUNS"
          echo "  - Success Rate: $SUCCESS_RATE%"
          echo "  - Critical Issues: ${#CRITICAL_ISSUES[@]}"
          
          # Set outputs for next steps
          echo "total_runs=$TOTAL_RUNS" >> $GITHUB_OUTPUT
          echo "failed_runs=$FAILED_RUNS" >> $GITHUB_OUTPUT
          echo "success_rate=$SUCCESS_RATE" >> $GITHUB_OUTPUT
          echo "critical_issues_count=${#CRITICAL_ISSUES[@]}" >> $GITHUB_OUTPUT
          
          # Store critical issues for reporting
          printf '%s\n' "${CRITICAL_ISSUES[@]}" > /tmp/critical_issues.txt
          
      - name: Generate Monitoring Report
        id: generate-report
        timeout-minutes: 5
        run: |
          MONITORING_TYPE="${{ github.event.inputs.monitoring_type || 'health-check' }}"
          TOTAL_RUNS="${{ steps.health-monitor.outputs.total_runs }}"
          FAILED_RUNS="${{ steps.health-monitor.outputs.failed_runs }}"
          SUCCESS_RATE="${{ steps.health-monitor.outputs.success_rate }}"
          CRITICAL_ISSUES_COUNT="${{ steps.health-monitor.outputs.critical_issues_count }}"
          
          echo "Generating monitoring report..."
          
          # Determine health status
          HEALTH_STATUS="HEALTHY"
          PRIORITY="low"
          if (( $(echo "$SUCCESS_RATE < 90" | bc -l) )); then
            HEALTH_STATUS="WARNING"
            PRIORITY="medium"
          fi
          if (( $(echo "$SUCCESS_RATE < 75" | bc -l) )) || [ "$CRITICAL_ISSUES_COUNT" -gt 0 ]; then
            HEALTH_STATUS="CRITICAL"
            PRIORITY="high"
          fi
          
          echo "Health Status: $HEALTH_STATUS"
          echo "Priority: $PRIORITY"
          
          # Create monitoring report
          REPORT_BODY="## ðŸ” GitHub Actions Workflow Monitoring Report
          
          **Generated**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          **Monitoring Type**: $MONITORING_TYPE
          
          ### ðŸ“Š Overall Status
          - **Health Status**: $HEALTH_STATUS
          - **Total Runs (24h)**: $TOTAL_RUNS
          - **Failed Runs**: $FAILED_RUNS
          - **Success Rate**: $SUCCESS_RATE%
          - **Critical Issues**: $CRITICAL_ISSUES_COUNT
          
          ### ðŸš¨ Critical Issues
          "
          
          if [ -s "/tmp/critical_issues.txt" ]; then
            while IFS= read -r issue; do
              REPORT_BODY="$REPORT_BODY
          - âŒ $issue"
            done < /tmp/critical_issues.txt"
          else
            REPORT_BODY="$REPORT_BODY
          - âœ… No critical issues detected"
          fi
          
          REPORT_BODY="$REPORT_BODY
          
          ### ðŸŽ¯ Recommendations
          "
          
          if [ "$HEALTH_STATUS" = "CRITICAL" ]; then
            REPORT_BODY="$REPORT_BODY
          - ðŸš¨ **IMMEDIATE ACTION REQUIRED**
          - Investigate failing workflows immediately.
          - Check runner configuration and dependencies.
          - Review recent changes that may have caused failures."
          elif [ "$HEALTH_STATUS" = "WARNING" ]; then
            REPORT_BODY="$REPORT_BODY
          - âš ï¸ **ATTENTION NEEDED**
          - Monitor workflow performance closely.
          - Review error patterns and optimize."
          else
            REPORT_BODY="$REPORT_BODY
          - âœ… **SYSTEM HEALTHY**
          - Continue normal monitoring."
          fi
          
          REPORT_BODY="$REPORT_BODY
          
          ### ðŸ”— Related Resources
          - [Workflow Runs Dashboard](https://github.com/${{ github.repository }}/actions)
          - [Workflow Error Analysis Doc](docs/WORKFLOW_ERROR_ANALYSIS_AND_FIXES.md)
          
          ---
          
          ðŸ¤– *Report generated by OpenCode CLI Workflow Monitoring*"
          
          # Create or update monitoring issue
          EXISTING_ISSUE=$(gh issue list --label="workflow-monitoring" --state=open --limit 1 --json number --jq '.[0].number // ""')
          
          if [ -n "$EXISTING_ISSUE" ]; then
            echo "Updating existing monitoring issue #$EXISTING_ISSUE"
            gh issue edit "$EXISTING_ISSUE" \
              --title "ðŸ” Workflow Monitoring Report - $HEALTH_STATUS" \
              --body "$REPORT_BODY"
            gh issue comment "$EXISTING_ISSUE" --body "Regular update: Status is **$HEALTH_STATUS**."
          else
            echo "Creating new monitoring issue"
            gh issue create \
              --title "ðŸ” Workflow Monitoring Report - $HEALTH_STATUS" \
              --body "$REPORT_BODY" \
              --label "workflow-monitoring,automation,area:ci" \
              --assignee "@me"
          fi
          
      - name: Create Monitoring Summary
        if: always()
        run: |
          TOTAL_RUNS="${{ steps.health-monitor.outputs.total_runs }}"
          FAILED_RUNS="${{ steps.health-monitor.outputs.failed_runs }}"
          SUCCESS_RATE="${{ steps.health-monitor.outputs.success_rate }}"
          CRITICAL_ISSUES_COUNT="${{ steps.health-monitor.outputs.critical_issues_count }}"
          
          echo "## ðŸ” Workflow Monitoring Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š Monitoring Results" >> $GITHUB_STEP_SUMMARY
          echo "- **Total Workflows Analyzed**: 7" >> $GITHUB_STEP_SUMMARY
          echo "- **Total Runs (24h)**: $TOTAL_RUNS" >> $GITHUB_STEP_SUMMARY
          echo "- **Failed Runs**: $FAILED_RUNS" >> $GITHUB_STEP_SUMMARY
          echo "- **Success Rate**: $SUCCESS_RATE%" >> $GITHUB_STEP_SUMMARY
          echo "- **Critical Issues**: $CRITICAL_ISSUES_COUNT" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸŽ¯ Health Status" >> $GITHUB_STEP_SUMMARY
          
          if (( $(echo "$SUCCESS_RATE >= 90" | bc -l) )) && [ "$CRITICAL_ISSUES_COUNT" -eq 0 ]; then
            echo "- **Status**: âœ… HEALTHY" >> $GITHUB_STEP_SUMMARY
          elif (( $(echo "$SUCCESS_RATE >= 75" | bc -l) )); then
            echo "- **Status**: âš ï¸ WARNING" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Status**: ðŸš¨ CRITICAL" >> $GITHUB_STEP_SUMMARY
          fi