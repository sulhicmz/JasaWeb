name: Performance

on:
  schedule:
    # Run performance tests weekly on Sundays at 2 AM UTC
    - cron: '0 2 * * 0'
  push:
    branches: [main]
    paths:
      - 'apps/web/**'
      - 'apps/api/**'
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: '20'
  PNPM_VERSION: '8.15.0'

jobs:
  web-performance:
    name: Web Performance
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build web application
        run: pnpm build:web

      - name: Start application
        run: |
          cd apps/web
          npm run preview &
          sleep 10

      - name: Run Lighthouse CI
        run: |
          npm install -g @lhci/cli@0.12.x
          lhci autorun --collect.url=http://localhost:4321
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}

      - name: Analyze bundle size
        run: |
          echo "ðŸ“¦ Analyzing bundle sizes..."
          cd apps/web/dist

          total_kb=$(du -sk . | cut -f1)
          echo "Total bundle size: ${total_kb}KB"

          if [ $total_kb -le 1024 ]; then
            echo "âœ… Bundle size within limits (â‰¤1MB)"
          elif [ $total_kb -le 2048 ]; then
            echo "âš ï¸ Bundle size large (â‰¤2MB)"
            echo "::warning::Consider bundle optimization"
          else
            echo "âŒ Bundle size too large (>2MB)"
            echo "::error::Bundle size exceeds recommended limits"
            exit 1
          fi

      - name: Upload Lighthouse report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: lighthouse-report
          path: .lighthouseci/
          retention-days: 30

  api-performance:
    name: API Performance
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: jasaweb_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build API
        run: pnpm build:api

      - name: Start API
        run: |
          cd apps/api
          DATABASE_URL="postgresql://postgres:postgres@localhost:5432/jasaweb_test" npm run start:prod &
          sleep 10
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/jasaweb_test

      - name: Install Artillery
        run: npm install -g artillery@latest

      - name: Run API load tests
        run: |
          cat > artillery-config.yml << 'EOF'
          config:
            target: 'http://localhost:3000'
            phases:
              - duration: 60
                arrivalRate: 10
                name: "Warm up"
              - duration: 120
                arrivalRate: 50
                name: "Load test"
          scenarios:
            - name: "Health Check"
              weight: 50
              flow:
                - get:
                    url: "/health"
            - name: "API Endpoints"
              weight: 50
              flow:
                - get:
                    url: "/api/projects"
          EOF

          artillery run artillery-config.yml --output report.json

          # Check performance thresholds
          if [ -f report.json ]; then
            avg_response=$(cat report.json | jq -r '.aggregate.latency.mean // 0')
            p95_response=$(cat report.json | jq -r '.aggregate.latency.p95 // 0')

            echo "Average Response Time: ${avg_response}ms"
            echo "95th Percentile: ${p95_response}ms"

            if (( $(echo "$avg_response > 200" | bc -l) )); then
              echo "::warning::API response time above 200ms"
            fi

            if (( $(echo "$p95_response > 500" | bc -l) )); then
              echo "::warning::API P95 response time above 500ms"
            fi
          fi

      - name: Upload performance report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: api-performance-report
          path: report.json
          retention-days: 30

  performance-report:
    name: Performance Report
    runs-on: ubuntu-latest
    needs: [web-performance, api-performance]
    if: always()
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/

      - name: Generate performance report
        run: |
          echo "# ðŸš€ Performance Report" > performance-report.md
          echo "" >> performance-report.md
          echo "## Report Generated: $(date)" >> performance-report.md
          echo "" >> performance-report.md
          echo "### Test Results" >> performance-report.md
          echo "- Web Performance: ${{ needs.web-performance.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }}" >> performance-report.md
          echo "- API Performance: ${{ needs.api-performance.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }}" >> performance-report.md
          echo "" >> performance-report.md
          echo "### Recommendations" >> performance-report.md
          echo "- Monitor performance metrics regularly" >> performance-report.md
          echo "- Optimize bundle sizes for better loading" >> performance-report.md
          echo "- Implement caching for frequently accessed data" >> performance-report.md
          echo "- Consider CDN for static assets" >> performance-report.md

      - name: Upload performance report
        uses: actions/upload-artifact@v4
        with:
          name: performance-report
          path: performance-report.md
          retention-days: 30
