name: oc - Issue Solver

on:
  issues:
    types: [opened, reopened]
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issue number to solve'
        required: false
        type: string

permissions:
  id-token: write
  contents: write
  issues: write
  pull-requests: write
  actions: write

concurrency:
  group: ${{ github.workflow }}-${{ github.event.issue.number || github.event.inputs.issue_number }}
  cancel-in-progress: false

jobs:
  issue-solver:
    name: OC Issue Solver
    runs-on: self-hosted
    timeout-minutes: 40
    permissions:
      id-token: write
      contents: write
      issues: write
      pull-requests: write
      actions: write

    env:
      GH_TOKEN: ${{ secrets.GH_TOKEN }}
      IFLOW_API_KEY: ${{ secrets.IFLOW_API_KEY }}

    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 1
          token: ${{ secrets.GH_TOKEN }}

      - name: Install OpenCode CLI
        run: |
          curl -fsSL https://opencode.ai/install | bash
          echo "$HOME/.opencode/bin" >> $GITHUB_PATH

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 8.15.0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Analyze and Solve Issue
        id: solve-issue
        timeout-minutes: 30
        run: |
          ISSUE_NUMBER="${{ github.event.issue.number || github.event.inputs.issue_number }}"
          ISSUE_TITLE="${{ github.event.issue.title }}"
          ISSUE_BODY="${{ github.event.issue.body }}"
          ISSUE_LABELS="${{ join(github.event.issue.labels.*.name, ', ') }}"

          echo "Processing issue #$ISSUE_NUMBER: $ISSUE_TITLE"
          echo "Labels: $ISSUE_LABELS"

          opencode run "$(cat <<'PROMPT'
            **ROLE**: Issue Resolver for JasaWeb
            **PROJECT**: Web Development Service Platform - Monorepo (pnpm)
            **TECH STACK**: Astro (apps/web), NestJS (apps/api), PostgreSQL + Prisma, Tailwind
            **DOCS**: AGENTS.md, todo.md, bug.md

            Issue Details:
            - Number: #'$ISSUE_NUMBER'
            - Title: '$ISSUE_TITLE'
            - Body: '$ISSUE_BODY'
            - Labels: '$ISSUE_LABELS'

            Analysis Steps:
            1. Categorize issue (bug/feature/documentation/improvement)
            2. Assess complexity and effort
            3. Identify affected paths (apps/web, apps/api, packages/ui)

            Implementation:
            - Bug: Locate code, fix with proper error handling, add tests
            - Feature: Design with Prisma/NestJS, implement, add tests
            - Documentation: Update AGENTS.md or specific docs

            Actions:
            1. Create branch: fix/issue-$ISSUE_NUMBER or feat/issue-$ISSUE_NUMBER
            2. Implement solution following TypeScript strict mode
            3. Run: pnpm lint && pnpm typecheck
            4. Update bug.md or todo.md with findings

            **CRITICAL: EPHEMERAL ENVIRONMENT - PERSIST ALL CHANGES**
            ```bash
            git config --global user.name "issue-solver"
            git config --global user.email "22936450+sulhicmz@users.noreply.github.com"
            git checkout -b fix/issue-$ISSUE_NUMBER || true
            git add -A
            git commit -m "fix(#$ISSUE_NUMBER): $ISSUE_TITLE"
            git push -u origin HEAD
            gh pr create --title "Fix #$ISSUE_NUMBER: $ISSUE_TITLE" --body "Closes #$ISSUE_NUMBER" --base main
            ```
          PROMPT
          )" \
            --model iflowcn/qwen3-max \
            --share false \
            --non-interactive \

      - name: Run Tests
        id: run-tests
        timeout-minutes: 10
        run: |
          echo "Running tests to validate the solution..."
          pnpm test:quick
          pnpm lint
          pnpm typecheck

      - name: Create Pull Request
        id: create-pr
        if: success()
        run: |
          echo "Creating pull request for issue solution..."

          # Get current branch name
          BRANCH_NAME=$(git branch --show-current)

          # Create PR if not already exists
          if ! gh pr view --json number --jq '.number' 2>/dev/null; then
            PR_URL=$(gh pr create \
              --title "Fix #$ISSUE_NUMBER: $ISSUE_TITLE" \
              --body "## ðŸŽ¯ Issue Resolution

            This PR addresses issue #$ISSUE_NUMBER: **$ISSUE_TITLE**

            ### ðŸ“ Changes Made
            - Implemented solution following best practices
            - Added comprehensive tests
            - Updated documentation where needed
            - Ensured backward compatibility

            ### ðŸ§ª Testing
            - All unit tests pass
            - Integration tests validate functionality
            - Code quality checks pass
            - TypeScript compilation successful

            ### ðŸ”— Related Issue
            Closes #$ISSUE_NUMBER

            ---

            ðŸ¤– *This PR was automatically generated by OpenCode CLI Issue Solver*" \
              --base main \
              --head "$BRANCH_NAME" \
              --label "auto-generated" \
              --label "issue-solver")

            echo "PR created: $PR_URL"
          else
            echo "PR already exists for this branch"
          fi

      - name: Auto-Merge Simple Fixes
        id: auto-merge
        if: success()
        run: |
          # Check if PR is ready for auto-merge
          PR_NUMBER=$(gh pr view --json number --jq '.number')

          if [ -n "$PR_NUMBER" ]; then
            # Get PR status
            PR_STATUS=$(gh pr view "$PR_NUMBER" --json mergeable --jq '.mergeable')
            PR_REVIEWS=$(gh pr view "$PR_NUMBER" --json reviews --jq '.reviews | length')

            # Auto-merge if conditions are met
            if [ "$PR_STATUS" = "CLEAN" ] && [ "$PR_REVIEWS" -ge 0 ]; then
              echo "Auto-merging PR #$PR_NUMBER..."
              gh pr merge "$PR_NUMBER" --merge --delete-branch

              # Close the original issue
              gh issue close "$ISSUE_NUMBER" \
                --comment "âœ… **Issue Resolved**

                This issue has been automatically resolved and merged via PR #$PR_NUMBER.

                ðŸ¤– *Resolution handled by OpenCode CLI Issue Solver*"
            else
              echo "PR not ready for auto-merge (Status: $PR_STATUS, Reviews: $PR_REVIEWS)"
            fi
          fi

      - name: Update Issue Status
        id: update-issue
        if: always()
        run: |
          # Add comment to issue with status update
          if [ "${{ job.status }}" = "success" ]; then
            gh issue comment "$ISSUE_NUMBER" \
              --body "## ðŸš€ Issue Resolution Progress

            âœ… **Solution Implemented**
            - Code changes have been implemented
            - Tests have been added and are passing
            - Pull request has been created
            - Auto-merge process initiated

            ### ðŸ“Š Current Status
            - **Branch**: $BRANCH_NAME
            - **PR**: #$PR_NUMBER
            - **Tests**: âœ… Passing
            - **Code Quality**: âœ… Validated

            ### ðŸ”„ Next Steps
            - Waiting for PR review and merge
            - Issue will be automatically closed when PR is merged

            ---

            ðŸ¤– *Status updated by OpenCode CLI Issue Solver*"
          else
            gh issue comment "$ISSUE_NUMBER" \
              --body "## âš ï¸ Issue Resolution Status

            âŒ **Resolution Failed**
            - An error occurred during the resolution process
            - The issue needs manual intervention
            - Please check the workflow logs for details

            ### ðŸ” Troubleshooting
            - Check workflow logs for error details
            - Verify issue requirements are clear
            - Consider breaking down complex issues

            ---

            ðŸ¤– *Status updated by OpenCode CLI Issue Solver*"
          fi

      - name: Create Issue Resolution Summary
        if: always()
        run: |
          echo "## ðŸ”§ Issue Solver Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ Issue Details" >> $GITHUB_STEP_SUMMARY
          echo "- **Issue Number**: #$ISSUE_NUMBER" >> $GITHUB_STEP_SUMMARY
          echo "- **Title**: $ISSUE_TITLE" >> $GITHUB_STEP_SUMMARY
          echo "- **Labels**: $ISSUE_LABELS" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸŽ¯ Resolution Actions" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Issue analysis completed" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Solution implemented" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Tests added and validated" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Pull request created" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Issue status updated" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š Resolution Status" >> $GITHUB_STEP_SUMMARY
          if [ "${{ job.status }}" = "success" ]; then
            echo "- **Status**: âœ… Successfully Resolved" >> $GITHUB_STEP_SUMMARY
            echo "- **PR**: Created and ready for review" >> $GITHUB_STEP_SUMMARY
            echo "- **Auto-merge**: Initiated if conditions met" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Status**: âŒ Resolution Failed" >> $GITHUB_STEP_SUMMARY
            echo "- **Action**: Manual intervention required" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸš€ Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "- Monitor PR review and merge process" >> $GITHUB_STEP_SUMMARY
          echo "- Issue will auto-close when PR is merged" >> $GITHUB_STEP_SUMMARY
          echo "- Check workflow logs if resolution failed" >> $GITHUB_STEP_SUMMARY
