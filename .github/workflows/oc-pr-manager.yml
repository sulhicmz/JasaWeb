name: "OC - PR Intelligence"

on:
  schedule:
    - cron: "* */30 * * *"
  workflow_dispatch:

permissions:
  id-token: write
  contents: write
  pull-requests: write
  issues: write
  actions: read
jobs:
  opencode:
    name: OC PR Intelligence
    runs-on: ubuntu-24.04-arm
    timeout-minutes: 40
    permissions:
      id-token: write
      contents: write
      pull-requests: write
      issues: write
      actions: write
    env:
      GH_TOKEN: ${{ secrets.GH_TOKEN }}
      IFLOW_API_KEY: ${{ secrets.IFLOW_API_KEY }}
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 1
      - name: Collect open PR metadata
        run: |
          mkdir -p pr_intel
          gh pr list --state open --json \
            number,title,author,mergeable,mergeStateStatus,updatedAt,createdAt,headRefName,baseRefName,reviewDecision,isDraft \
            > pr_intel/open_prs.json
          count=$(jq '. | length' pr_intel/open_prs.json)
          echo "Found $count open PRs."
          if [ "$count" -eq 0 ]; then
            echo "No open PRs found. Skipping downstream job." >> $GITHUB_ENV
            echo "skip_jobs=true" >> $GITHUB_ENV
          else
            echo "skip_jobs=false" >> $GITHUB_ENV
          fi
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          IFLOW_API_KEY: ${{ secrets.IFLOW_API_KEY }}
      - name: Upload PR intel
        if: env.skip_jobs == 'false'
        uses: actions/upload-artifact@v5
        with:
          name: pr-intel-data-${{ github.run_id }}
          path: pr_intel/
      - name: Install OpenCode CLI
        run: |
          curl -fsSL https://opencode.ai/install | bash
          echo "$HOME/.opencode/bin" >> $GITHUB_PATH
      - name: Run Manajer Kualitas Kode
        id: run_code_quality
        timeout-minutes: 60
        run: |
          opencode run "$(cat <<'PROMPT'
            **ROLE**: PR Manager for JasaWeb
            **PROJECT**: Web Development Service Platform - Monorepo (pnpm)
            **TECH STACK**: Astro (apps/web), NestJS (apps/api), PostgreSQL + Prisma
            **REPOSITORY**: ${{ github.repository }}
            **PR DATA**: ./pr_intel/open_prs.json

            GOALS:
            1. Analyze open PRs and prioritize:
               - Mergeable but blocked by unresolved comments
               - Out-of-date with base branch
               - Conflicts or failed checks

            2. If all PRs are healthy:
               - Comment: "âœ… All PRs are healthy."
               - Exit cleanly

            3. For selected PR:
               - Update branch: gh pr update --rebase
               - Apply suggested code fixes from diff blocks
               - Re-run failed workflows: gh run rerun
               - Attempt merge: gh pr merge $PR_NUMBER --squash --delete-branch

            RULES:
            - Skip draft PRs
            - Never delete branches manually unless merged
            - Keep commits atomic

            **CRITICAL: EPHEMERAL - All actions via gh CLI**
            Any code changes must create new commits:
            ```bash
            git config --global user.name "pr-manager"
            git config --global user.email "22936450+sulhicmz@users.noreply.github.com"
            git add -A
            git commit -m "chore(pr): apply PR improvements"
            git push
            ```
          PROMPT
          )" \
            --model iflowcn/qwen3-coder-plus \
            --share false \
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          IFLOW_API_KEY: ${{ secrets.IFLOW_API_KEY }}
