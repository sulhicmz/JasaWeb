name: oc - Code Quality & Testing

on:
  schedule:
    - cron: '0 */4 * * *'  # Setiap 4 jam
  workflow_dispatch:
    inputs:
      test_level:
        description: 'Testing level'
        required: false
        default: 'standard'
        type: choice
        options:
          - quick
          - standard
          - comprehensive
          - full
      focus_area:
        description: 'Focus area for testing'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - unit
          - integration
          - e2e
          - performance

permissions:
  id-token: write
  contents: write
  pull-requests: write
  issues: write
  actions: write

concurrency:
  group: ${{ github.workflow }}-global
  cancel-in-progress: false

jobs:
  code-quality-testing:
    name: OC Code Quality & Testing
    runs-on: self-hosted
    timeout-minutes: 50
    permissions:
      id-token: write
      contents: write
      pull-requests: write
      issues: write
      actions: write
      
    env:
      GH_TOKEN: ${{ secrets.GH_TOKEN }}
      IFLOW_API_KEY: ${{ secrets.IFLOW_API_KEY }}
      
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 1
          
      - name: Install OpenCode CLI
        run: |
          curl -fsSL https://opencode.ai/install | bash
          echo "$HOME/.opencode/bin" >> $GITHUB_PATH
          
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
          
      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 8.15.0
          
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
        
      - name: Run Code Quality Analysis
        id: code-quality-analysis
        timeout-minutes: 15
        run: |
          opencode run "$(cat <<'PROMPT'
            Perform comprehensive code quality analysis for JasaWeb project:
            
            1. Static Code Analysis:
               - Run ESLint and fix auto-fixable issues
               - Check TypeScript compilation and type safety
               - Analyze code complexity and maintainability
               - Review code duplication and redundancy
               - Check for anti-patterns and code smells
               - Verify consistent coding standards
            
            2. Code Structure Analysis:
               - Review project architecture and structure
               - Check for proper separation of concerns
               - Analyze module dependencies and coupling
               - Review naming conventions and consistency
               - Check for proper error handling patterns
               - Verify documentation and comments quality
            
            3. Performance Code Review:
               - Identify performance bottlenecks in code
               - Check for inefficient algorithms or data structures
               - Review memory usage patterns
               - Analyze database query efficiency
               - Check for proper caching implementation
               - Review async/await usage and promise handling
            
            Actions to take:
            - Auto-fix linting and formatting issues
            - Create PRs for code quality improvements
            - Refactor complex functions and methods
            - Improve type definitions and interfaces
            - Add missing error handling
            - Optimize performance-critical code
            
            Focus on maintainability, readability, and performance.
            Generate detailed code quality report with metrics.
          PROMPT
          )" \
            --model iflowcn/qwen3-coder-plus \
            --share false \
            
      - name: Run Unit Testing
        id: unit-testing
        timeout-minutes: 15
        run: |
          opencode run "$(cat <<'PROMPT'
            Perform comprehensive unit testing for JasaWeb project:
            
            1. Test Coverage Analysis:
               - Analyze current test coverage across all modules
               - Identify untested critical paths and functions
               - Review test quality and effectiveness
               - Check for test duplication and redundancy
               - Analyze test performance and execution time
               - Review test data management and fixtures
            
            2. Test Implementation:
               - Write unit tests for uncovered critical functions
               - Improve existing test quality and assertions
               - Add edge case and boundary condition tests
               - Implement proper mocking and stubbing
               - Add performance and load testing for critical functions
               - Create integration tests for complex workflows
            
            3. Test Infrastructure:
               - Review test setup and configuration
               - Optimize test execution performance
               - Improve test data management
               - Enhance test reporting and coverage
               - Set up test automation and CI integration
               - Create test utilities and helpers
            
            Actions to take:
            - Generate missing unit tests automatically
            - Improve existing test quality and coverage
            - Optimize test execution performance
            - Create comprehensive test suites
            - Set up test reporting and metrics
            - Add test documentation and guidelines
            
            Target minimum 80% coverage for critical paths.
            Focus on business logic and API endpoints.
          PROMPT
          )" \
            --model iflowcn/qwen3-coder-plus \
            --share false \
            
      - name: Run Integration Testing
        id: integration-testing
        timeout-minutes: 15
        run: |
          opencode run "$(cat <<'PROMPT'
            Perform comprehensive integration testing for JasaWeb project:
            
            1. API Integration Testing:
               - Test all API endpoints with various inputs
               - Verify authentication and authorization flows
               - Test database integration and transactions
               - Check error handling and response codes
               - Validate data consistency and integrity
               - Test rate limiting and throttling
            
            2. Service Integration Testing:
               - Test service-to-service communication
               - Verify external API integrations
               - Test database connection and operations
               - Check file storage and retrieval
               - Test email and notification services
               - Verify caching mechanisms
            
            3. System Integration Testing:
               - Test complete user workflows
               - Verify multi-tenant data isolation
               - Test concurrent user scenarios
               - Check system performance under load
               - Verify data backup and recovery
               - Test monitoring and logging systems
            
            Actions to take:
            - Create comprehensive integration test suites
            - Implement API contract testing
            - Add database integration tests
            - Create end-to-end workflow tests
            - Set up performance testing
            - Implement monitoring and alerting
            
            Focus on critical business workflows and API reliability.
            Ensure proper error handling and recovery mechanisms.
          PROMPT
          )" \
            --model iflowcn/qwen3-coder-plus \
            --share false \
            
      - name: Run Performance Testing
        id: performance-testing
        timeout-minutes: 10
        run: |
          opencode run "$(cat <<'PROMPT'
            Perform comprehensive performance testing for JasaWeb project:
            
            1. Load Testing:
               - Test API response times under various loads
               - Measure database query performance
               - Test concurrent user handling
               - Analyze memory usage patterns
               - Check CPU utilization under load
               - Test scalability and performance limits
            
            2. Frontend Performance:
               - Analyze page load times and rendering
               - Test JavaScript bundle sizes and optimization
               - Check CSS and asset optimization
               - Test browser compatibility and performance
               - Analyze Core Web Vitals metrics
               - Test mobile performance and responsiveness
            
            3. Backend Performance:
               - Test API endpoint performance
               - Analyze database query optimization
               - Check caching effectiveness
               - Test background job performance
               - Analyze memory leak detection
               - Test resource utilization efficiency
            
            Actions to take:
            - Implement performance monitoring and alerting
            - Optimize slow database queries
            - Improve caching strategies
            - Optimize frontend bundle sizes
            - Add performance regression tests
            - Create performance benchmarks and reports
            
            Focus on user experience and system reliability.
            Set up performance alerts for degradation.
          PROMPT
          )" \
            --model iflowcn/qwen3-coder-plus \
            --share false \
            
      - name: Run Accessibility Testing
        id: accessibility-testing
        timeout-minutes: 10
        run: |
          opencode run "$(cat <<'PROMPT'
            Perform comprehensive accessibility testing for JasaWeb project:
            
            1. WCAG Compliance Testing:
               - Test keyboard navigation and focus management
               - Verify screen reader compatibility
               - Check color contrast and visual accessibility
               - Test form accessibility and validation
               - Verify ARIA labels and roles
               - Check semantic HTML structure
            
            2. Usability Testing:
               - Test responsive design and mobile accessibility
               - Verify text scaling and zoom functionality
               - Test alternative text for images and media
               - Check link and button accessibility
               - Test error message accessibility
               - Verify navigation and orientation
            
            3. Assistive Technology Testing:
               - Test with various screen readers
               - Check voice control compatibility
               - Test switch navigation
               - Verify braille display compatibility
               - Test voice recognition software
               - Check alternative input devices
            
            Actions to take:
            - Implement accessibility improvements
            - Add ARIA labels and roles where needed
            - Improve color contrast and visual design
            - Enhance keyboard navigation
            - Add accessibility testing to CI/CD
            - Create accessibility documentation
            
            Target WCAG 2.2 AA compliance.
            Focus on inclusive design and user experience.
          PROMPT
          )" \
            --model iflowcn/qwen3-coder-plus \
            --share false \
            
      - name: Generate Quality Report
        id: quality-report
        timeout-minutes: 10
        run: |
          opencode run "$(cat <<'PROMPT'
            Generate comprehensive code quality and testing report for JasaWeb project:
            
            Collect and analyze results from all quality checks and create:
            
            1. Quality Metrics Summary:
               - Code quality score and trends
               - Test coverage percentages by module
               - Performance benchmarks and improvements
               - Accessibility compliance status
               - Security scan results integration
               - Technical debt assessment
            
            2. Testing Analysis:
               - Unit test coverage and quality
               - Integration test results and coverage
               - Performance test metrics and benchmarks
               - Accessibility test compliance status
               - Test execution times and efficiency
               - Test failure analysis and trends
            
            3. Improvement Recommendations:
               - Code quality improvement priorities
               - Testing strategy enhancements
               - Performance optimization opportunities
               - Accessibility improvements needed
               - Tool and process improvements
               - Training and documentation needs
            
            4. Action Items:
               - Immediate fixes required
               - Scheduled improvements
               - Process enhancements
               - Tool upgrades needed
               - Team training requirements
            
            Create this report as:
            - GitHub issue with quality labels
            - Detailed report in docs/quality-report.html
            - Quality metrics dashboard update
            - Summary in workflow artifacts
            
            Include actionable next steps and assign to appropriate team.
          PROMPT
          )" \
            --model iflowcn/qwen3-max \
            --share false \
            
      - name: Update Quality Standards
        id: update-standards
        timeout-minutes: 10
        run: |
          opencode run "$(cat <<'PROMPT'
            Update code quality standards and testing guidelines for JasaWeb project:
            
            Based on quality analysis results, update:
            
            1. Code Quality Standards:
               - Update ESLint rules and configurations
               - Enhance TypeScript strictness settings
               - Improve code formatting standards
               - Update naming conventions and patterns
               - Enhance error handling guidelines
               - Update documentation standards
            
            2. Testing Standards:
               - Update test coverage requirements
               - Enhance test writing guidelines
               - Improve test data management
               - Update test automation standards
               - Enhance performance testing criteria
               - Update accessibility testing requirements
            
            3. Process Improvements:
               - Update code review processes
               - Enhance quality gate requirements
               - Improve testing workflows
               - Update quality monitoring
               - Enhance reporting and metrics
               - Update team training materials
            
            Create PRs for all standard updates:
            - Include detailed changelog and rationale
            - Add examples and best practices
            - Update documentation and guidelines
            - Include migration guides if needed
            
            Ensure all updates align with industry best practices.
          PROMPT
          )" \
            --model iflowcn/qwen3-coder-plus \
            --share false \
            
      - name: Create Quality Metrics Dashboard
        id: quality-dashboard
        timeout-minutes: 5
        run: |
          opencode run "$(cat <<'PROMPT'
            Create quality metrics dashboard for JasaWeb project:
            
            Generate interactive dashboard with:
            
            1. Code Quality Metrics:
               - Code quality score trends
               - Technical debt metrics
               - Code complexity analysis
               - Duplication and redundancy metrics
               - Maintainability index
               - Code review statistics
            
            2. Testing Metrics:
               - Test coverage trends by module
               - Test execution times and performance
               - Test pass/fail rates
               - Test quality and effectiveness
               - Performance benchmark trends
               - Accessibility compliance status
            
            3. Quality Trends:
               - Historical quality improvements
               - Regression detection and alerts
               - Quality goal tracking
               - Team performance metrics
               - Tool effectiveness analysis
               - Process improvement impact
            
            Create dashboard in docs/quality-dashboard.html:
            - Interactive charts and graphs
            - Real-time data updates
            - Alert configurations
            - Export capabilities
            - Mobile-responsive design
            
            Set up automated updates and notifications.
            Include quality benchmarks and targets.
          PROMPT
          )" \
            --model iflowcn/qwen3-coder \
            --share false \
            
      - name: Schedule Next Quality Cycle
        id: schedule-next
        timeout-minutes: 5
        run: |
          opencode run "$(cat <<'PROMPT'
            Schedule next code quality and testing cycle for JasaWeb project:
            
            Based on current quality analysis, determine:
            
            1. Next Cycle Schedule:
               - Recommended frequency based on findings
               - Priority level for next cycle
               - Focus areas for next run
               - Resource requirements
            
            2. Quality Goals:
               - Set quality improvement targets
               - Define testing coverage goals
               - Establish performance benchmarks
               - Set accessibility compliance targets
               - Define technical debt reduction goals
            
            3. Preparation Tasks:
               - List quality improvements to implement
               - Identify testing enhancements needed
               - Schedule team training sessions
               - Prepare tool and process updates
               - Define success criteria
            
            Create GitHub issue with:
               - Next quality cycle schedule
               - Quality improvement roadmap
               - Testing strategy enhancements
               - Resource requirements
               
            Label appropriately and assign to quality team.
          PROMPT
          )" \
            --model iflowcn/qwen3-coder \
            --share false \
            
      - name: Create Quality Summary
        if: always()
        run: |
          echo "## ðŸ§ª Code Quality & Testing Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š Quality Tasks Completed" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Code Quality Analysis" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Unit Testing" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Integration Testing" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Performance Testing" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Accessibility Testing" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Quality Report Generated" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Quality Standards Updated" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Quality Metrics Dashboard" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Next Quality Cycle Scheduled" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸŽ¯ Quality Improvements" >> $GITHUB_STEP_SUMMARY
          echo "- Automated code quality analysis and fixes" >> $GITHUB_STEP_SUMMARY
          echo "- Comprehensive test coverage and quality" >> $GITHUB_STEP_SUMMARY
          echo "- Performance optimization and monitoring" >> $GITHUB_STEP_SUMMARY
          echo "- Accessibility compliance improvements" >> $GITHUB_STEP_SUMMARY
          echo "- Quality standards and process updates" >> $GITHUB_STEP_SUMMARY
          echo "- Real-time quality metrics and tracking" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“ˆ Quality Status" >> $GITHUB_STEP_SUMMARY
          echo "- Code quality: Enhanced and monitored" >> $GITHUB_STEP_SUMMARY
          echo "- Test coverage: Comprehensive and automated" >> $GITHUB_STEP_SUMMARY
          echo "- Performance: Optimized and benchmarked" >> $GITHUB_STEP_SUMMARY
          echo "- Accessibility: WCAG compliant and tested" >> $GITHUB_STEP_SUMMARY
          echo "- Standards: Updated and enforced" >> $GITHUB_STEP_SUMMARY
          echo "- Metrics: Tracked and visualized" >> $GITHUB_STEP_SUMMARY