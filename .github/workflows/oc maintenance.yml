name: oc bug finder

on:
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  issues: write
  actions: write

concurrency:
  group: global
  cancel-in-progress: false

jobs:
  opencode:
    name: oc pr handler
    runs-on: ubuntu-24.04-arm
    timeout-minutes: 40
    if: github.event_name == 'workflow_dispatch' || github.event_name == 'schedule'

    permissions:
      id-token: write
      contents: write
      pull-requests: write
      issues: write
      actions: write
      
    env:
      GH_TOKEN: ${{ secrets.GH_TOKEN }}
      IFLOW_API_KEY: ${{ secrets.IFLOW_API_KEY }}
      
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 1

      - name: Install OpenCode CLI
        run: |
          curl -fsSL https://opencode.ai/install | bash
          echo "$HOME/.opencode/bin" >> $GITHUB_PATH
      - name: Run OpenCode
        id: run_oc
        timeout-minutes: 60
        run: |
          **Objective**:
          Review `task.md`, `blueprint.md`, and `AGENTS.md`. Choose **ONE** high-impact, clearly scoped task:
          - stability 
          - performance
          - security
          - scalability
          - modularity
          - flexibility
          - consistency
          
          **Execution Protocol**:
          1. **Analysis**: efficient dependency check.
          2. **Implementation**: Incremental, modular changes.
          3. **Verification**: Code MUST build and pass strict linting.
          4. **Flexibiligy**: use dynamic, no hardcoded
          5. **Persistence**: commit and push to 'dev' branch          
          
          **Deliverables**:
          - Clearly state the selected task and rationale.
          - Provide the code changes.
          - Update `task.md` (progress tracking), `blueprint.md` (architectural updates), and `bug.md` (if applicable).
          PROMPT
          )" \
            --model iflowcn/glm-4.6 \
            --share false

      - name: Run OpenCode1
        id: run_oc1
        timeout-minutes: 60
        run: |
          opencode run "$(cat <<'PROMPT'
          Task:
            - "Maintain repository hygiene by organizing directory structure and removing unused, temporary, or duplicate files according to project rules"
            - "Ensure the repository contains only valid source code and essential project assets"
            - "Audit and clean up outdated or irrelevant documents, ensuring all remaining documentation is current and consistent"
            - "Refactor and reorganize documentation files to improve clarity, structure, and accessibility"
            - "Verify repository layout aligns with the intended project architecture and correct deviations when necessary"
            - "Monitor and remove deprecated scripts, configs, or artifacts that are no longer referenced by the codebase"
            - "Standardize file naming, folder conventions, and documentation formatting across the repository"
            - "Update or regenerate project metadata and configuration files when required for repository maintenance"
            - "Ensure README and other core documentation reflect the latest repository structure and cleanup results"
          **CRITICAL: EPHEMERAL ENVIRONMENT WARNING**:
            - This runs in a temporary GitHub Action runner. **ALL CHANGES WILL BE LOST** if you do not push.
            - **YOU MUST** execute the following commands at the end of your work:
              1. `git config --global user.name "maintenance"`
              2. `git config --global user.email "22936450+sulhicmz@users.noreply.github.com"`
              3. `git add .`
              4. `git commit`
              5. `git push origin dev`
              6. make/update pr to main, ensure mergeble
          **Execution Protocol**:
            1. **Analysis**: Understand JasaWeb's business model (web development services).
            2. **Implementation**: Incremental changes respecting monorepo structure.
            3. **Verification**: Code MUST build and pass quality checks.
            4. **Persistence**: **EXECUTE GIT PUSH TO DEV**.
            **Deliverables**:
            - Clearly state the selected task and business impact.
            - Provide the code changes with proper documentation.
            - Update relevant documentation and tests.
            - **SUCCESSFUL GIT PUSH TO DEV**.
          PROMPT
          )" \
            --model iflowcn/glm-4.6 \
            --share false
      - name: Run OpenCode2
        id: run_oc2
        timeout-minutes: 60
        run: |
          opencode run "$(cat <<'PROMPT'
            ROLE: GitHub Pull Request Maintenance Agent
            
            OBJECTIVE:
            Maintain repository health by resolving problematic open pull requests and preparing them for successful merge.
            
            TASKS (EXECUTE IN ORDER):
            
            1. PULL REQUEST DISCOVERY
               - List all open pull requests in the repository.
               - Sort by creation date (oldest first).
               - Select the oldest pull request that is currently not mergeable.
            
            2. MERGE CONFLICT RESOLUTION
               - Identify the cause of non-mergeable status (merge conflicts, failing checks, outdated base branch).
               - Update the pull request branch with the latest main branch using rebase or merge, following repository standards.
               - Resolve all merge conflicts carefully, preserving intended functionality and coding standards.
            
            3. REVIEW & CONVERSATION HANDLING
               - Analyze all review comments and discussion threads in the pull request conversation.
               - Apply requested changes if they are still relevant and technically valid.
               - Respond to comments where clarification or justification is required.
               - Mark resolved comments as resolved only after changes are applied.
            
            4. VALIDATION
               - Run the full build and test pipeline.
               - Ensure all required status checks pass.
               - Confirm the pull request is now cleanly mergeable without conflicts.
            
            5. PULL REQUEST UPDATE
               - Push all fixes and updates to the pull request branch.
               - Update the pull request description if necessary to reflect changes made.
               - Ensure the pull request is ready for merge according to repository contribution rules.
            
            CONSTRAINTS:
            - Do not introduce unrelated refactors or scope creep.
            - Follow existing code style, architecture, and contribution guidelines.
            - Prioritize minimal, safe, and review-aligned changes.
            
            FINAL STATE:
            - The selected pull request is conflict-free, review comments are resolved, all checks pass, and the pull request is mergeable.
          PROMPT
          )" \
            --model iflowcn/glm-4.6 \
            --share false
      - name: Run OpenCode3
        id: run_oc3
        timeout-minutes: 60
        run: |
          opencode run "$(cat <<'PROMPT'
            ROLE: GitHub Repository Branch Cleanup Agent
            
            OBJECTIVE:
            Safely clean up excessive branches to improve repository health, efficiency, and maintainability without risking data loss.            
            TASKS (EXECUTE IN ORDER):            
            1. BRANCH INVENTORY
               - Fetch and list all local and remote branches.
               - Classify branches into:
                 a) Merged branches
                 b) Stale branches (no commits for a long period)
                 c) Active branches
                 d) Protected branches (main, develop, release, or explicitly protected)            
            2. SAFETY VERIFICATION
               - Verify repository branch protection rules.
               - Exclude all protected branches from deletion.
               - Confirm merged status against the default branch.
               - Identify branches referenced by open pull requests and exclude them.            
            3. DELETION ELIGIBILITY
               - Mark branches eligible for deletion only if:
                 - Fully merged into the default branch OR explicitly abandoned
                 - Not associated with any open pull request
                 - Not recently updated
                 - Not required for release, hotfix, or long-term support            
            4. BACKUP & TRACEABILITY
               - Ensure commit history remains accessible after deletion.
               - Log branch names, last commit hashes, authors, and deletion timestamps.
               - Optionally tag critical commits before deletion if required by policy.            
            5. SAFE BRANCH REMOVAL
               - Delete eligible local branches.
               - Delete eligible remote branches.
               - Prune stale remote references.            
            6. REPOSITORY HEALTH CHECK
               - Verify no CI/CD pipelines, scripts, or documentation reference deleted branches.
               - Confirm default branch integrity.
               - Validate repository status remains clean and operational.            
            7. POST-CLEANUP OPTIMIZATION
               - Standardize branch naming conventions.
               - Recommend branch lifecycle rules (creation, update, deletion).
               - Document cleanup results and remaining active branches.            
            CONSTRAINTS:
            - Never delete protected or active branches.
            - Never delete branches linked to open pull requests.
            - Prefer conservative deletion over aggressive cleanup.
            - Do not modify code or commit history beyond branch removal.            
            FINAL STATE:
            - Repository contains only active, protected, or intentionally retained branches.
            - No orphaned or stale branches remain.
            - Repository is clean, efficient, and easier to maintain.
          PROMPT
          )" \
            --model iflowcn/glm-4.6 \
            --share false
