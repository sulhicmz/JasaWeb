name: oc analyzer

on:
  workflow_dispatch:
  workflow_run:
    workflows: ["oc standarizer"]
    types: [completed]
  schedule:
    - cron: '0 */6 * * *'  # Every 6 hours (offset from standarizer)

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: oc-analyzer
  cancel-in-progress: false

jobs:
  analyze:
    name: Analyze Codebase
    runs-on: ubuntu-24.04-arm
    timeout-minutes: 60
    if: ${{ github.event_name == 'workflow_dispatch' || github.event_name == 'schedule' || github.event.workflow_run.conclusion == 'success' }}

    env:
      GH_TOKEN: ${{ secrets.GH_TOKEN }}
      IFLOW_API_KEY: ${{ secrets.IFLOW_API_KEY }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GH_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 8.15.0

      - name: Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: Configure Git
        run: |
          git config --global user.name "sulhicmz"
          git config --global user.email "22936450+sulhicmz@users.noreply.github.com"

      - name: Install OpenCode
        run: |
          curl -fsSL https://opencode.ai/install | bash
          echo "$HOME/.opencode/bin" >> $GITHUB_PATH

      - name: Analyze
        run: |
          opencode run "$(cat <<'PROMPT'
          ROLE: Codebase Analyzer (Read-Only)

          TECH STACK:
          - Astro + React
          - Cloudflare Workers/Pages
          - Neon PostgreSQL + Prisma
          - Cloudflare KV & R2
          - Midtrans (payment)

          STEPS:
          1. Read: AGENTS.md, docs/architecture/blueprint.md, task.md, bug.md
          2. Run: pnpm build (check for errors)
          3. Run: pnpm lint (check for warnings)
          4. Check task.md for progress
          5. If there are unchecked tasks, report status
          6. Update evaluasi.md with findings
          7. If bugs found, add to bug.md
          8. Commit: docs(eval): update evaluation
          9. Push to dev branch directly

          CONSTRAINTS:
          - DO NOT modify code files (.ts, .tsx, .js)
          - Only update .md documentation files
          - Be honest in evaluation
          PROMPT
          )" --model iflowcn/glm-4.6 --share false

      - name: Check Remaining Tasks
        id: check_tasks
        run: |
          if grep -q "\[ \]" task.md; then
            echo "has_tasks=true" >> $GITHUB_OUTPUT
          else
            echo "has_tasks=false" >> $GITHUB_OUTPUT
          fi

      - name: Trigger Standarizer (if tasks remain)
        if: success() && steps.check_tasks.outputs.has_tasks == 'true'
        run: |
          sleep 30
          gh workflow run "oc standarizer.yml"

      - name: All Tasks Complete
        if: success() && steps.check_tasks.outputs.has_tasks == 'false'
        run: |
          echo "ðŸŽ‰ All tasks completed! Agent loop stopped."
