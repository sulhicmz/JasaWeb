name: oc migration

on:
  workflow_dispatch:
    inputs:
      phase:
        description: 'Migration phase to execute'
        required: true
        type: choice
        options:
          - 'phase-1-database'
          - 'phase-2-cache'
          - 'phase-3-storage'
          - 'phase-4-backend'
          - 'phase-5-cleanup'

permissions:
  contents: write
  pull-requests: write
  issues: write
  actions: write

concurrency:
  group: migration-${{ github.workflow }}
  cancel-in-progress: false

jobs:
  migrate:
    name: Execute Migration Phase
    runs-on: ubuntu-24.04-arm
    timeout-minutes: 60

    env:
      GH_TOKEN: ${{ secrets.GH_TOKEN }}
      IFLOW_API_KEY: ${{ secrets.IFLOW_API_KEY }}
      DATABASE_URL: ${{ secrets.DATABASE_URL }}

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GH_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 8.15.0
          run_install: false

      - name: Get pnpm store directory
        shell: bash
        run: echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: ${{ runner.os }}-pnpm-store-

      - name: Configure Git Identity
        run: |
          git config --global user.name "sulhicmz"
          git config --global user.email "22936450+sulhicmz@users.noreply.github.com"

      - name: Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: Install OpenCode CLI
        run: |
          curl -fsSL https://opencode.ai/install | bash
          echo "$HOME/.opencode/bin" >> $GITHUB_PATH

      - name: Execute Phase 1 - Database Migration
        if: ${{ github.event.inputs.phase == 'phase-1-database' }}
        run: |
          opencode run "$(cat <<'PROMPT'
          You are a **Migration Specialist** for Cloudflare ecosystem.

          **PHASE 1: DATABASE MIGRATION**

          **OBJECTIVE:** Migrate from local PostgreSQL to Neon + Prisma with Cloudflare Workers runtime.

          **TECH STACK:**
          - Database: Neon PostgreSQL (external, already setup)
          - ORM: Prisma with runtime = "cloudflare"
          - Connection: via Cloudflare Hyperdrive

          **TASKS:**
          1. Move `apps/api/prisma/schema.prisma` to `apps/web/prisma/schema.prisma`
          2. Update schema.prisma:
             - Add `previewFeatures = ["driverAdapters"]`
             - Add `runtime = "cloudflare"`
          3. Create `apps/web/src/lib/prisma.ts`:
             - Factory function that creates PrismaClient per-request
             - Use PrismaPg adapter with Hyperdrive connection
          4. Install dependencies: `@prisma/adapter-pg`, `pg`
          5. Verify: `pnpm prisma generate` succeeds

          **FILES TO CREATE/MODIFY:**
          - apps/web/prisma/schema.prisma (create)
          - apps/web/src/lib/prisma.ts (create)
          - apps/web/package.json (add prisma deps)

          **CONSTRAINTS:**
          - DO NOT modify apps/api (deprecated)
          - DO NOT break existing functionality
          - Commit with: `feat(db): migrate prisma to cloudflare workers runtime`

          **SUCCESS CRITERIA:**
          - schema.prisma has `runtime = "cloudflare"`
          - prisma.ts factory function exists
          - `pnpm prisma generate` works
          - Create PR to `dev` branch
          PROMPT
          )" --model iflowcn/glm-4.6 --share false

      - name: Execute Phase 2 - Cache Migration
        if: ${{ github.event.inputs.phase == 'phase-2-cache' }}
        run: |
          opencode run "$(cat <<'PROMPT'
          You are a **Migration Specialist** for Cloudflare ecosystem.

          **PHASE 2: CACHE MIGRATION (Redis → Cloudflare KV)**

          **OBJECTIVE:** Replace all Redis usage with Cloudflare KV.

          **TECH STACK:**
          - Cache: Cloudflare KV (binding: CACHE)

          **TASKS:**
          1. Create `apps/web/src/services/cache.service.ts`:
             - KVCacheService class with get, set, delete, has methods
             - Factory function: createCache(env)
          2. Search for Redis usages: `grep -r "redis" apps/`
          3. Replace Redis patterns with KV patterns
          4. Update wrangler.toml with KV namespace binding

          **KV SERVICE TEMPLATE:**
          ```typescript
          export class KVCacheService {
            constructor(private kv: KVNamespace) {}

            async get<T>(key: string): Promise<T | null> {
              const value = await this.kv.get(key, 'json');
              return value as T | null;
            }

            async set(key: string, value: unknown, ttl?: number): Promise<void> {
              await this.kv.put(key, JSON.stringify(value),
                ttl ? { expirationTtl: ttl } : undefined);
            }

            async delete(key: string): Promise<void> {
              await this.kv.delete(key);
            }
          }

          export function createCache(env: { CACHE: KVNamespace }) {
            return new KVCacheService(env.CACHE);
          }
          ```

          **CONSTRAINTS:**
          - DO NOT modify apps/api (deprecated)
          - Keep same cache semantics (TTL, keys)
          - Commit with: `feat(cache): migrate redis to cloudflare kv`

          **SUCCESS CRITERIA:**
          - cache.service.ts exists and compiles
          - No Redis imports in apps/web
          - Create PR to `dev` branch
          PROMPT
          )" --model iflowcn/glm-4.6 --share false

      - name: Execute Phase 3 - Storage Migration
        if: ${{ github.event.inputs.phase == 'phase-3-storage' }}
        run: |
          opencode run "$(cat <<'PROMPT'
          You are a **Migration Specialist** for Cloudflare ecosystem.

          **PHASE 3: STORAGE MIGRATION (S3 → Cloudflare R2)**

          **OBJECTIVE:** Replace AWS S3/MinIO with Cloudflare R2.

          **TECH STACK:**
          - Storage: Cloudflare R2 (binding: STORAGE)
          - Note: R2 is S3-compatible

          **TASKS:**
          1. Create `apps/web/src/services/storage.service.ts`:
             - R2StorageService class with upload, download, delete, list methods
             - Factory function: createStorage(env)
          2. Update wrangler.toml with R2 bucket binding
          3. Search for S3/MinIO usages and document migration path

          **R2 SERVICE TEMPLATE:**
          ```typescript
          export class R2StorageService {
            constructor(private bucket: R2Bucket) {}

            async upload(key: string, data: ArrayBuffer | ReadableStream, contentType?: string) {
              return await this.bucket.put(key, data, {
                httpMetadata: contentType ? { contentType } : undefined
              });
            }

            async download(key: string): Promise<ArrayBuffer | null> {
              const obj = await this.bucket.get(key);
              return obj ? await obj.arrayBuffer() : null;
            }

            async delete(key: string): Promise<void> {
              await this.bucket.delete(key);
            }

            async list(prefix?: string) {
              return await this.bucket.list({ prefix });
            }
          }

          export function createStorage(env: { STORAGE: R2Bucket }) {
            return new R2StorageService(env.STORAGE);
          }
          ```

          **CONSTRAINTS:**
          - DO NOT modify apps/api (deprecated)
          - Commit with: `feat(storage): add cloudflare r2 service`

          **SUCCESS CRITERIA:**
          - storage.service.ts exists and compiles
          - wrangler.toml has R2 binding
          - Create PR to `dev` branch
          PROMPT
          )" --model iflowcn/glm-4.6 --share false

      - name: Execute Phase 4 - Backend Migration
        if: ${{ github.event.inputs.phase == 'phase-4-backend' }}
        run: |
          opencode run "$(cat <<'PROMPT'
          You are a **Migration Specialist** for Cloudflare ecosystem.

          **PHASE 4: BACKEND MIGRATION (NestJS → Astro API Routes)**

          **OBJECTIVE:** Migrate critical API endpoints from NestJS to Astro API routes.

          **TECH STACK:**
          - Backend: Astro SSR with Cloudflare adapter
          - Runtime: Cloudflare Workers

          **TASKS:**
          1. Create basic API structure in `apps/web/src/pages/api/`:
             - health.ts (GET /api/health)
             - auth/login.ts (POST /api/auth/login)
             - auth/logout.ts (POST /api/auth/logout)
          2. Use services created in previous phases:
             - createPrismaClient for database
             - createCache for KV
             - createStorage for R2
          3. Add Cloudflare env types to `apps/web/src/env.d.ts`

          **API ROUTE TEMPLATE:**
          ```typescript
          // apps/web/src/pages/api/health.ts
          import type { APIRoute } from 'astro';

          export const GET: APIRoute = async ({ locals }) => {
            const env = locals.runtime.env;

            return new Response(JSON.stringify({
              status: 'ok',
              timestamp: new Date().toISOString()
            }), {
              headers: { 'Content-Type': 'application/json' }
            });
          };
          ```

          **CONSTRAINTS:**
          - Focus on auth endpoints first (most critical)
          - DO NOT modify apps/api
          - Commit with: `feat(api): add astro api routes for cloudflare workers`

          **SUCCESS CRITERIA:**
          - /api/health endpoint works
          - /api/auth/* endpoints scaffolded
          - TypeScript compiles without errors
          - Create PR to `dev` branch
          PROMPT
          )" --model iflowcn/glm-4.6 --share false

      - name: Execute Phase 5 - Cleanup
        if: ${{ github.event.inputs.phase == 'phase-5-cleanup' }}
        run: |
          opencode run "$(cat <<'PROMPT'
          You are a **Migration Specialist** for Cloudflare ecosystem.

          **PHASE 5: CLEANUP & VERIFICATION**

          **OBJECTIVE:** Clean up old code and verify migration is complete.

          **TASKS:**
          1. Verify all services work:
             - Run `pnpm build`
             - Run `pnpm test`
             - Run `pnpm lint`
          2. Update documentation:
             - AGENTS.md: Mark migration complete
             - README.md: Update tech stack section
             - Remove references to Docker/NestJS for new deployments
          3. Create migration summary in `docs/deployment/MIGRATION_COMPLETE.md`:
             - List all migrated components
             - Document any breaking changes
             - Note any remaining tasks
          4. DO NOT delete apps/api yet (keep for reference)

          **CONSTRAINTS:**
          - Verify before documenting
          - Be honest about incomplete items
          - Commit with: `docs: finalize cloudflare migration documentation`

          **SUCCESS CRITERIA:**
          - Build passes
          - Tests pass
          - Documentation updated
          - Create PR to `dev` branch
          PROMPT
          )" --model iflowcn/glm-4.6 --share false

      - name: Summary
        if: always()
        run: |
          echo "Migration phase ${{ github.event.inputs.phase }} completed"
          echo "Check the PR created for review"
