name: oc migration

on:
  workflow_dispatch:
    inputs:
      phase:
        description: 'Migration phase'
        required: true
        type: choice
        options:
          - 'phase-1-database'
          - 'phase-2-services'
          - 'phase-3-auth'
          - 'phase-4-public-site'
          - 'phase-5-client-portal'
          - 'phase-6-admin-panel'
          - 'phase-7-payment'

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: oc-migration
  cancel-in-progress: false

jobs:
  migrate:
    name: Execute Migration
    runs-on: ubuntu-24.04-arm
    timeout-minutes: 60

    env:
      GH_TOKEN: ${{ secrets.GH_TOKEN }}
      IFLOW_API_KEY: ${{ secrets.IFLOW_API_KEY }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GH_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Install Dependencies
        continue-on-error: true
        run: pnpm install --frozen-lockfile || pnpm install

      - name: Configure Git
        run: |
          git config --global user.name "sulhicmz"
          git config --global user.email "22936450+sulhicmz@users.noreply.github.com"

      - name: Install OpenCode
        run: |
          curl -fsSL https://opencode.ai/install | bash
          echo "$HOME/.opencode/bin" >> $GITHUB_PATH

      - name: Phase 1 - Database
        if: inputs.phase == 'phase-1-database'
        run: |
          opencode run "$(cat <<'PROMPT'
          PHASE 1: DATABASE SETUP

          Read: AGENTS.md, blueprint.md, docs/task.md

          Branch: Create `migration/phase-1` from `dev`. Work exclusively on this branch.

          Tasks:
          1. Create apps/web/prisma/schema.prisma (copy schema from blueprint.md)
          2. Add: previewFeatures = ["driverAdapters"], runtime = "cloudflare"
          3. Create apps/web/src/lib/prisma.ts (factory function)
          4. Install: @prisma/client @prisma/adapter-pg pg
          5. Run: pnpm prisma generate
          6. Update docs/task.md: mark Phase 1 tasks as [x]

          Commit: feat(db): setup prisma for cloudflare workers
          Create PR to dev
          PROMPT
          )" --model iflowcn/glm-4.6 --share false

      - name: Phase 2 - Services
        if: inputs.phase == 'phase-2-services'
        run: |
          opencode run "$(cat <<'PROMPT'
          PHASE 2: SERVICES SETUP

          Read: AGENTS.md, docs/task.md

          Branch: Create `migration/phase-2` from `dev`. Work exclusively on this branch.

          Tasks:
          1. Create apps/web/src/services/cache.service.ts (KV wrapper)
          2. Create apps/web/src/services/storage.service.ts (R2 wrapper)
          3. Update apps/web/wrangler.toml with KV and R2 bindings
          4. Update docs/task.md

          Commit: feat(services): add kv cache and r2 storage services
          Create PR to dev
          PROMPT
          )" --model iflowcn/glm-4.6 --share false

      - name: Phase 3 - Auth
        if: inputs.phase == 'phase-3-auth'
        run: |
          opencode run "$(cat <<'PROMPT'
          PHASE 3: AUTH ENDPOINTS

          Read: AGENTS.md, blueprint.md, docs/task.md

          Branch: Create `migration/phase-3` from `dev`. Work exclusively on this branch.

          Tasks:
          1. Create apps/web/src/lib/auth.ts (JWT utilities)
          2. Create apps/web/src/pages/api/auth/register.ts
          3. Create apps/web/src/pages/api/auth/login.ts
          4. Create apps/web/src/pages/api/auth/logout.ts
          5. Create apps/web/src/pages/api/auth/me.ts
          6. Update docs/task.md

          Requirements:
          - Use bcrypt for password hashing
          - JWT with 15min access token, 7d refresh token
          - Roles: admin, client

          Commit: feat(auth): implement auth endpoints
          Create PR to dev
          PROMPT
          )" --model iflowcn/glm-4.6 --share false

      - name: Phase 4 - Public Site
        if: inputs.phase == 'phase-4-public-site'
        run: |
          opencode run "$(cat <<'PROMPT'
          PHASE 4: PUBLIC SITE PAGES

          Read: AGENTS.md, blueprint.md, docs/task.md

          Branch: Create `migration/phase-4` from `dev`. Work exclusively on this branch.

          Tasks:
          1. Create/update landing page
          2. Create template gallery page
          3. Create pricing page
          4. Create blog list & detail pages
          5. Create register & login pages
          6. Update docs/task.md

          Requirements:
          - Use Astro pages with React components
          - Tailwind for styling
          - Fetch data from API endpoints

          Commit: feat(public): add public site pages
          Create PR to dev
          PROMPT
          )" --model iflowcn/glm-4.6 --share false

      - name: Phase 5 - Client Portal
        if: inputs.phase == 'phase-5-client-portal'
        run: |
          opencode run "$(cat <<'PROMPT'
          PHASE 5: CLIENT PORTAL

          Read: AGENTS.md, blueprint.md, docs/task.md

          Branch: Create `migration/phase-5` from `dev`. Work exclusively on this branch.

          Tasks:
          1. Create dashboard page
          2. Create "Web Saya" projects list page
          3. Create project detail page (status, URL, credentials)
          4. Create billing page (invoices, payment)
          5. Create "Akun Saya" page
          6. Add auth guard for client routes
          7. Update docs/task.md

          Requirements:
          - Protected routes (require login)
          - Role check: client or admin

          Commit: feat(portal): add client portal pages
          Create PR to dev
          PROMPT
          )" --model iflowcn/glm-4.6 --share false

      - name: Phase 6 - Admin Panel
        if: inputs.phase == 'phase-6-admin-panel'
        run: |
          opencode run "$(cat <<'PROMPT'
          PHASE 6: ADMIN PANEL

          Read: AGENTS.md, blueprint.md, docs/task.md

          Branch: Create `migration/phase-6` from `dev`. Work exclusively on this branch.

          Tasks:
          1. Create admin dashboard
          2. Create manage clients CRUD
          3. Create manage projects CRUD + status update
          4. Create manage blog CRUD
          5. Create manage pages CRUD
          6. Create manage templates CRUD
          7. Add admin guard (role: admin only)
          8. Update docs/task.md

          Commit: feat(admin): add admin panel
          Create PR to dev
          PROMPT
          )" --model iflowcn/glm-4.6 --share false

      - name: Phase 7 - Payment
        if: inputs.phase == 'phase-7-payment'
        run: |
          opencode run "$(cat <<'PROMPT'
          PHASE 7: MIDTRANS PAYMENT

          Read: AGENTS.md, blueprint.md, docs/task.md

          Branch: Create `migration/phase-7` from `dev`. Work exclusively on this branch.

          Tasks:
          1. Install midtrans-client
          2. Create apps/web/src/lib/midtrans.ts (client wrapper)
          3. Create apps/web/src/pages/api/invoices/[id]/pay.ts
          4. Create apps/web/src/pages/api/webhooks/midtrans.ts
          5. Update billing page to show QRIS
          6. Update docs/task.md

          Requirements:
          - QRIS payment method
          - Webhook to update invoice status
          - Environment: MIDTRANS_SERVER_KEY, MIDTRANS_CLIENT_KEY

          Commit: feat(payment): integrate midtrans qris
          Create PR to dev
          PROMPT
          )" --model iflowcn/glm-4.6 --share false
