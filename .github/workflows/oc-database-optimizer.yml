name: oc - Database Optimizer

on:
  schedule:
    - cron: '0 3 * * *'  # Setiap hari jam 3 AM UTC
  workflow_dispatch:
    inputs:
      optimization_type:
        description: 'Type of database optimization'
        required: false
        default: 'comprehensive'
        type: choice
        options:
          - comprehensive
          - performance-only
          - cleanup-only
          - schema-only
      target_database:
        description: 'Target database environment'
        required: false
        default: 'staging'
        type: choice
        options:
          - staging
          - production
          - all

permissions:
  id-token: write
  contents: write
  pull-requests: write
  issues: write
  actions: write

concurrency:
  group: ${{ github.workflow }}-global
  cancel-in-progress: false

jobs:
  database-optimizer:
    name: OC Database Optimizer
    runs-on: self-hosted
    timeout-minutes: 45
    permissions:
      id-token: write
      contents: write
      pull-requests: write
      issues: write
      actions: write
      
    env:
      GH_TOKEN: ${{ secrets.GH_TOKEN }}
      IFLOW_API_KEY: ${{ secrets.IFLOW_API_KEY }}
      
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 1
          
      - name: Install OpenCode CLI
        run: |
          curl -fsSL https://opencode.ai/install | bash
          echo "$HOME/.opencode/bin" >> $GITHUB_PATH
          
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
          
      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 8.15.0
          
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
        
      - name: Database Performance Analysis
        id: performance-analysis
        timeout-minutes: 15
        run: |
          OPTIMIZATION_TYPE="${{ github.event.inputs.optimization_type || 'comprehensive' }}"
          TARGET_DATABASE="${{ github.event.inputs.target_database || 'staging' }}"
          
          echo "Starting database optimization cycle..."
          echo "Optimization Type: $OPTIMIZATION_TYPE"
          echo "Target Database: $TARGET_DATABASE"
          
          opencode run "$(cat <<'PROMPT'
            Perform comprehensive database optimization for JasaWeb project:
            
            Optimization Parameters:
            - Type: '$OPTIMIZATION_TYPE'
            - Target: '$TARGET_DATABASE'
            
            Database Optimization Strategy:
            1. Performance Analysis:
               - Analyze slow query logs
               - Check query execution plans
               - Identify missing indexes
               - Review table statistics
               - Analyze connection pool usage
               - Check for deadlocks and locks
            
            2. Schema Optimization:
               - Review table structures for efficiency
               - Check for proper data types
               - Analyze foreign key constraints
               - Review partitioning opportunities
               - Check for normalization issues
               - Identify denormalization opportunities
            
            3. Index Optimization:
               - Identify missing indexes
               - Review existing index usage
               - Check for duplicate or redundant indexes
               - Analyze index fragmentation
               - Review composite index opportunities
               - Optimize index order and columns
            
            4. Query Optimization:
               - Analyze slow queries
               - Review N+1 query problems
               - Check for inefficient joins
               - Review pagination queries
               - Analyze subquery performance
               - Check for query caching opportunities
            
            Actions to Take:
            1. Generate optimization recommendations
            2. Create migration scripts for schema changes
            3. Implement index optimizations
            4. Optimize problematic queries
            5. Create performance monitoring setup
            6. Document optimization decisions
            
            Focus on measurable performance improvements.
            Ensure backward compatibility and data integrity.
            Create PRs for all optimization changes.
          PROMPT
          )" \
            --model iflowcn/qwen3-coder-plus \
            --share false \
            --non-interactive
            
      - name: Create Database Optimization Summary
        if: always()
        run: |
          echo "## ðŸ—„ï¸ Database Optimizer Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š Optimization Details" >> $GITHUB_STEP_SUMMARY
          echo "- **Optimization Type**: $OPTIMIZATION_TYPE" >> $GITHUB_STEP_SUMMARY
          echo "- **Target Database**: $TARGET_DATABASE" >> $GITHUB_STEP_SUMMARY
          echo "- **Duration**: 45 minutes" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸŽ¯ Optimization Actions" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Performance analysis completed" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Database cleanup and maintenance" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Schema validation performed" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Optimization report generated" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Database monitoring updated" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Next optimization cycle scheduled" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“ˆ Key Improvements" >> $GITHUB_STEP_SUMMARY
          echo "- Query performance optimization" >> $GITHUB_STEP_SUMMARY
          echo "- Index efficiency improvements" >> $GITHUB_STEP_SUMMARY
          echo "- Data integrity validation" >> $GITHUB_STEP_SUMMARY
          echo "- Storage optimization" >> $GITHUB_STEP_SUMMARY
          echo "- Security enhancements" >> $GITHUB_STEP_SUMMARY
          echo "- Monitoring and alerting setup" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸš€ Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "- Review optimization report and metrics" >> $GITHUB_STEP_SUMMARY
          echo "- Monitor implemented optimizations" >> $GITHUB_STEP_SUMMARY
          echo "- Address any performance issues" >> $GITHUB_STEP_SUMMARY
          echo "- Prepare for next optimization cycle" >> $GITHUB_STEP_SUMMARY
          echo "- Continue database performance improvements" >> $GITHUB_STEP_SUMMARY