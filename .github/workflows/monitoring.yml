name: Monitoring and Health Checks

on:
  schedule:
    # Run health checks every 5 minutes
    - cron: '*/5 * * * *'
    # Run comprehensive monitoring every hour
    - cron: '0 * * * *'
  workflow_dispatch:
  push:
    branches: [main]
    paths:
      - '.github/workflows/monitoring.yml'
      - 'apps/api/src/health/**'

jobs:
  health-check:
    name: Application Health Check
    runs-on: ubuntu-latest
    if: github.event.schedule == '*/5 * * * *'

    steps:
    - name: Check Production Health
      run: |
        echo "üîç Checking production application health..."
        
        # Check web application
        WEB_STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://jasaweb.com || echo "000")
        if [ "$WEB_STATUS" = "200" ]; then
          echo "‚úÖ Web application healthy (HTTP $WEB_STATUS)"
        else
          echo "‚ùå Web application unhealthy (HTTP $WEB_STATUS)"
          echo "::warning::Web application health check failed"
        fi
        
        # Check API health
        API_STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://api.jasaweb.com/health || echo "000")
        if [ "$API_STATUS" = "200" ]; then
          echo "‚úÖ API healthy (HTTP $API_STATUS)"
        else
          echo "‚ùå API unhealthy (HTTP $API_STATUS)"
          echo "::warning::API health check failed"
        fi
        
        # Check API response time
        API_RESPONSE_TIME=$(curl -s -o /dev/null -w "%{time_total}" https://api.jasaweb.com/health || echo "0")
        if (( $(echo "$API_RESPONSE_TIME < 2.0" | bc -l) )); then
          echo "‚úÖ API response time acceptable (${API_RESPONSE_TIME}s)"
        else
          echo "‚ö†Ô∏è API response time slow (${API_RESPONSE_TIME}s)"
          echo "::warning::API response time above threshold"
        fi

    - name: Check Database Health
      run: |
        echo "üóÑÔ∏è Checking database health..."
        
        # This would typically connect to your database
        # For now, we'll simulate the check
        DB_STATUS=$(curl -s -X POST https://api.jasaweb.com/health/db -H "Content-Type: application/json" -d '{"check": true}' || echo '{"status": "error"}')
        
        if echo "$DB_STATUS" | grep -q '"status":"ok"'; then
          echo "‚úÖ Database healthy"
        else
          echo "‚ùå Database unhealthy"
          echo "::warning::Database health check failed"
        fi

    - name: Check External Services
      run: |
        echo "üåê Checking external services..."
        
        # Check email service
        SMTP_STATUS=$(timeout 10 bash -c "</dev/tcp/smtp.gmail.com/587" 2>/dev/null && echo "open" || echo "closed")
        if [ "$SMTP_STATUS" = "open" ]; then
          echo "‚úÖ SMTP service reachable"
        else
          echo "‚ö†Ô∏è SMTP service unreachable"
          echo "::warning::SMTP service health check failed"
        fi
        
        # Check storage service
        S3_STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://s3.amazonaws.com/jasaweb-storage || echo "000")
        if [ "$WEB_STATUS" = "200" ] || [ "$WEB_STATUS" = "403" ]; then
          echo "‚úÖ S3 storage accessible"
        else
          echo "‚ö†Ô∏è S3 storage issue (HTTP $S3_STATUS)"
          echo "::warning::S3 storage health check failed"
        fi

    - name: Send Health Alert
      if: failure()
      run: |
        echo "üö® Sending health alert..."
        curl -X POST "${{ secrets.SLACK_WEBHOOK_URL }}" \
          -H 'Content-type: application/json' \
          --data "{
            \"text\": \"üö® JasaWeb Health Check Failed\",
            \"attachments\": [
              {
                \"color\": \"danger\",
                \"fields\": [
                  {
                    \"title\": \"Time\",
                    \"value\": \"$(date)\",
                    \"short\": true
                  },
                  {
                    \"title\": \"Repository\",
                    \"value\": \"jasaweb/jasaweb\",
                    \"short\": true
                  },
                  {
                    \"title\": \"Workflow\",
                    \"value\": \"Monitoring and Health Checks\",
                    \"short\": true
                  },
                  {
                    \"title\": \"Action Required\",
                    \"value\": \"Please check application status and logs\",
                    \"short\": false
                  }
                ]
              }
            ]
          }" || echo "Failed to send Slack alert"

  comprehensive-monitoring:
    name: Comprehensive Monitoring
    runs-on: ubuntu-latest
    if: github.event.schedule == '0 * * * *' || github.event_name == 'workflow_dispatch'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install monitoring tools
      run: |
        npm install -g @lhci/cli
        npm install -g lighthouse

    - name: Run Lighthouse Performance Audit
      run: |
        echo "üöÄ Running Lighthouse performance audit..."
        
        # Run Lighthouse on main site
        lighthouse https://jasaweb.com \
          --output=json \
          --output-path=./lighthouse-report.json \
          --chrome-flags="--headless" \
          --quiet
        
        # Extract key metrics
        PERFORMANCE_SCORE=$(cat lighthouse-report.json | jq -r '.categories.performance.score * 100')
        FCP=$(cat lighthouse-report.json | jq -r '.audits["first-contentful-paint"].numericValue / 1000')
        LCP=$(cat lighthouse-report.json | jq -r '.audits["largest-contentful-paint"].numericValue / 1000')
        TTI=$(cat lighthouse-report.json | jq -r '.audits["interactive"].numericValue / 1000')
        CLS=$(cat lighthouse-report.json | jq -r '.audits["cumulative-layout-shift"].numericValue')
        
        echo "üìä Performance Metrics:"
        echo "Performance Score: ${PERFORMANCE_SCORE}"
        echo "First Contentful Paint: ${FCP}s"
        echo "Largest Contentful Paint: ${LCP}s"
        echo "Time to Interactive: ${TTI}s"
        echo "Cumulative Layout Shift: ${CLS}"
        
        # Check against thresholds
        if (( $(echo "$PERFORMANCE_SCORE >= 90" | bc -l) )); then
          echo "‚úÖ Performance score excellent"
        elif (( $(echo "$PERFORMANCE_SCORE >= 50" | bc -l) )); then
          echo "‚ö†Ô∏è Performance score needs improvement"
          echo "::warning::Performance score below 90: ${PERFORMANCE_SCORE}"
        else
          echo "‚ùå Performance score poor"
          echo "::error::Performance score below 50: ${PERFORMANCE_SCORE}"
        fi
        
        if (( $(echo "$FCP <= 1.8" | bc -l) )); then
          echo "‚úÖ First Contentful Paint good"
        else
          echo "‚ö†Ô∏è First Contentful Paint slow: ${FCP}s"
          echo "::warning::FCP above 1.8s threshold"
        fi

    - name: Check SSL Certificate
      run: |
        echo "üîí Checking SSL certificates..."
        
        # Check main domain
        SSL_MAIN=$(echo | openssl s_client -servername jasaweb.com -connect jasaweb.com:443 2>/dev/null | openssl x509 -noout -dates | grep "notAfter" | cut -d= -f2)
        SSL_MAIN_EPOCH=$(date -d "$SSL_MAIN" +%s)
        CURRENT_EPOCH=$(date +%s)
        DAYS_LEFT=$(( (SSL_MAIN_EPOCH - CURRENT_EPOCH) / 86400 ))
        
        if [ $DAYS_LEFT -gt 30 ]; then
          echo "‚úÖ SSL certificate valid for $DAYS_LEFT days"
        elif [ $DAYS_LEFT -gt 7 ]; then
          echo "‚ö†Ô∏è SSL certificate expires in $DAYS_LEFT days"
          echo "::warning::SSL certificate expiring soon"
        else
          echo "‚ùå SSL certificate expires in $DAYS_LEFT days"
          echo "::error::SSL certificate expiring very soon"
        fi

    - name: Monitor Error Rates
      run: |
        echo "üìà Checking error rates..."
        
        # This would typically query your monitoring service
        # For demonstration, we'll simulate the check
        ERROR_RATE=$(curl -s "https://api.jasaweb.com/metrics/error-rate?period=1h" || echo "0")
        
        if (( $(echo "$ERROR_RATE <= 1.0" | bc -l) )); then
          echo "‚úÖ Error rate acceptable: ${ERROR_RATE}%"
        elif (( $(echo "$ERROR_RATE <= 5.0" | bc -l) )); then
          echo "‚ö†Ô∏è Error rate elevated: ${ERROR_RATE}%"
          echo "::warning::Error rate above 1%"
        else
          echo "‚ùå Error rate high: ${ERROR_RATE}%"
          echo "::error::Error rate above 5%"
        fi

    - name: Check Resource Usage
      run: |
        echo "üíª Checking resource usage..."
        
        # This would typically query your monitoring service
        CPU_USAGE=$(curl -s "https://api.jasaweb.com/metrics/cpu" || echo "0")
        MEMORY_USAGE=$(curl -s "https://api.jasaweb.com/metrics/memory" || echo "0")
        DISK_USAGE=$(curl -s "https://api.jasaweb.com/metrics/disk" || echo "0")
        
        echo "CPU Usage: ${CPU_USAGE}%"
        echo "Memory Usage: ${MEMORY_USAGE}%"
        echo "Disk Usage: ${DISK_USAGE}%"
        
        # Check thresholds
        if (( $(echo "$CPU_USAGE <= 80" | bc -l) )); then
          echo "‚úÖ CPU usage acceptable"
        else
          echo "‚ö†Ô∏è CPU usage high: ${CPU_USAGE}%"
          echo "::warning::CPU usage above 80%"
        fi
        
        if (( $(echo "$MEMORY_USAGE <= 85" | bc -l) )); then
          echo "‚úÖ Memory usage acceptable"
        else
          echo "‚ö†Ô∏è Memory usage high: ${MEMORY_USAGE}%"
          echo "::warning::Memory usage above 85%"
        fi

    - name: Generate Monitoring Report
      run: |
        echo "# üìä Monitoring Report" > monitoring-report.md
        echo "" >> monitoring-report.md
        echo "## Report Generated: $(date)" >> monitoring-report.md
        echo "" >> monitoring-report.md
        echo "### Performance Metrics" >> monitoring-report.md
        echo "- Performance Score: ${PERFORMANCE_SCORE:-N/A}" >> monitoring-report.md
        echo "- First Contentful Paint: ${FCCP:-N/A}s" >> monitoring-report.md
        echo "- Largest Contentful Paint: ${LCP:-N/A}s" >> monitoring-report.md
        echo "- Time to Interactive: ${TTI:-N/A}s" >> monitoring-report.md
        echo "" >> monitoring-report.md
        echo "### System Health" >> monitoring-report.md
        echo "- CPU Usage: ${CPU_USAGE:-N/A}%" >> monitoring-report.md
        echo "- Memory Usage: ${MEMORY_USAGE:-N/A}%" >> monitoring-report.md
        echo "- Disk Usage: ${DISK_USAGE:-N/A}%" >> monitoring-report.md
        echo "- Error Rate: ${ERROR_RATE:-N/A}%" >> monitoring-report.md
        echo "" >> monitoring-report.md
        echo "### SSL Status" >> monitoring-report.md
        echo "- Certificate expires in: ${DAYS_LEFT:-N/A} days" >> monitoring-report.md
        echo "" >> monitoring-report.md
        echo "### Recommendations" >> monitoring-report.md
        echo "- Review performance metrics regularly" >> monitoring-report.md
        echo "- Monitor error rates and resource usage" >> monitoring-report.md
        echo "- Renew SSL certificate before expiration" >> monitoring-report.md

    - name: Upload Monitoring Report
      uses: actions/upload-artifact@v4
      with:
        name: monitoring-report
        path: monitoring-report.md
        retention-days: 7

    - name: Send Comprehensive Report
      run: |
        echo "üìä Sending comprehensive monitoring report..."
        curl -X POST "${{ secrets.SLACK_WEBHOOK_URL }}" \
          -H 'Content-type: application/json' \
          --data "{
            \"text\": \"üìä JasaWeb Hourly Monitoring Report\",
            \"attachments\": [
              {
                \"color\": \"good\",
                \"fields\": [
                  {
                    \"title\": \"Performance Score\",
                    \"value\": \"${PERFORMANCE_SCORE:-N/A}\",
                    \"short\": true
                  },
                  {
                    \"title\": \"Error Rate\",
                    \"value\": \"${ERROR_RATE:-N/A}%\",
                    \"short\": true
                  },
                  {
                    \"title\": \"CPU Usage\",
                    \"value\": \"${CPU_USAGE:-N/A}%\",
                    \"short\": true
                  },
                  {
                    \"title\": \"Memory Usage\",
                    \"value\": \"${MEMORY_USAGE:-N/A}%\",
                    \"short\": true
                  },
                  {
                    \"title\": \"SSL Certificate\",
                    \"value\": \"${DAYS_LEFT:-N/A} days remaining\",
                    \"short\": true
                  },
                  {
                    \"title\": \"Report Time\",
                    \"value\": \"$(date)\",
                    \"short\": true
                  }
                ]
              }
            ]
          }" || echo "Failed to send comprehensive report"

  uptime-monitoring:
    name: Uptime Monitoring
    runs-on: ubuntu-latest
    if: github.event.schedule == '*/5 * * * *'

    steps:
    - name: Check Service Uptime
      run: |
        echo "‚è±Ô∏è Checking service uptime..."
        
        # Array of services to check
        services=("https://jasaweb.com" "https://api.jasaweb.com/health")
        
        for service in "${services[@]}"; do
          echo "Checking $service..."
          
          # Measure response time and status
          start_time=$(date +%s.%N)
          status=$(curl -s -o /dev/null -w "%{http_code}" "$service" || echo "000")
          end_time=$(date +%s.%N)
          
          response_time=$(echo "$end_time - $start_time" | bc)
          
          if [ "$status" = "200" ]; then
            if (( $(echo "$response_time < 5.0" | bc -l) )); then
              echo "‚úÖ $service - OK (${response_time}s)"
            else
              echo "‚ö†Ô∏è $service - Slow response (${response_time}s)"
              echo "::warning::Slow response from $service"
            fi
          else
            echo "‚ùå $service - FAILED (HTTP $status)"
            echo "::error::Service $service is down"
            
            # Send immediate alert for downtime
            curl -X POST "${{ secrets.SLACK_WEBHOOK_URL }}" \
              -H 'Content-type: application/json' \
              --data "{
                \"text\": \"üö® Service Down: $service\",
                \"attachments\": [
                  {
                    \"color\": \"danger\",
                    \"fields\": [
                      {
                        \"title\": \"Service\",
                        \"value\": \"$service\",
                        \"short\": true
                      },
                      {
                        \"title\": \"Status Code\",
                        \"value\": \"$status\",
                        \"short\": true
                      },
                      {
                        \"title\": \"Time\",
                        \"value\": \"$(date)\",
                        \"short\": true
                      },
                      {
                        \"title\": \"Action\",
                        \"value\": \"Immediate investigation required\",
                        \"short\": false
                      }
                    ]
                  }
                ]
              }" || echo "Failed to send downtime alert"
          fi
        done