name: Monitoring

on:
  schedule:
    # Run health checks every 15 minutes (reduced from 5)
    - cron: '*/15 * * * *'
    # Run comprehensive monitoring every 6 hours (reduced from 1)
    - cron: '0 */6 * * *'
  workflow_dispatch:
  push:
    branches: [main]
    paths:
      - '.github/workflows/monitoring.yml'
      - 'apps/api/src/health/**'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  health-check:
    name: Health Check
    runs-on: ubuntu-latest
    if: github.event.schedule == '*/15 * * * *' || github.event_name == 'workflow_dispatch'
    steps:
      - name: Check application health
        run: |
          echo "üîç Checking application health..."

          # Function to check service health
          check_service() {
            local url=$1
            local name=$2
            local status=$(curl -s -o /dev/null -w "%{http_code}" "$url" || echo "000")
            local response_time=$(curl -s -o /dev/null -w "%{time_total}" "$url" || echo "0")

            if [ "$status" = "200" ]; then
              echo "‚úÖ $name healthy (HTTP $status, ${response_time}s)"
              return 0
            else
              echo "‚ùå $name unhealthy (HTTP $status)"
              echo "::warning::$name health check failed"
              return 1
            fi
          }

          # Check services
          check_service "https://jasaweb.com" "Web Application"
          check_service "https://api.jasaweb.com/health" "API"

      - name: Send alert on failure
        if: failure()
        run: |
          curl -X POST "${{ secrets.SLACK_WEBHOOK_URL }}" \
            -H 'Content-type: application/json' \
            --data "{
              \"text\": \"üö® JasaWeb Health Check Failed\",
              \"attachments\": [{
                \"color\": \"danger\",
                \"fields\": [
                  {\"title\": \"Time\", \"value\": \"$(date)\", \"short\": true},
                  {\"title\": \"Action\", \"value\": \"Immediate investigation required\", \"short\": false}
                ]
              }]
            }" || echo "Failed to send alert"

  comprehensive-monitoring:
    name: Comprehensive Monitoring
    runs-on: ubuntu-latest
    if: github.event.schedule == '0 */6 * * *' || github.event_name == 'workflow_dispatch'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install monitoring tools
        run: npm install -g lighthouse

      - name: Run Lighthouse audit
        run: |
          echo "üöÄ Running Lighthouse audit..."
          lighthouse https://jasaweb.com \
            --output=json \
            --output-path=./lighthouse-report.json \
            --chrome-flags="--headless" \
            --quiet || true

          if [ -f lighthouse-report.json ]; then
            PERFORMANCE_SCORE=$(cat lighthouse-report.json | jq -r '.categories.performance.score * 100' || echo "0")
            FCP=$(cat lighthouse-report.json | jq -r '.audits["first-contentful-paint"].numericValue / 1000' || echo "0")
            LCP=$(cat lighthouse-report.json | jq -r '.audits["largest-contentful-paint"].numericValue / 1000' || echo "0")

            echo "Performance Score: ${PERFORMANCE_SCORE}"
            echo "First Contentful Paint: ${FCP}s"
            echo "Largest Contentful Paint: ${LCP}s"

            echo "PERFORMANCE_SCORE=${PERFORMANCE_SCORE}" >> $GITHUB_ENV
            echo "FCP=${FCP}" >> $GITHUB_ENV
            echo "LCP=${LCP}" >> $GITHUB_ENV

            if (( $(echo "$PERFORMANCE_SCORE < 50" | bc -l) )); then
              echo "::warning::Performance score below 50: ${PERFORMANCE_SCORE}"
            fi
          fi

      - name: Check SSL certificate
        run: |
          echo "üîí Checking SSL certificate..."
          SSL_EXPIRY=$(echo | openssl s_client -servername jasaweb.com -connect jasaweb.com:443 2>/dev/null | openssl x509 -noout -dates | grep "notAfter" | cut -d= -f2 || echo "")

          if [ -n "$SSL_EXPIRY" ]; then
            SSL_EPOCH=$(date -d "$SSL_EXPIRY" +%s)
            CURRENT_EPOCH=$(date +%s)
            DAYS_LEFT=$(( (SSL_EPOCH - CURRENT_EPOCH) / 86400 ))

            echo "SSL certificate expires in $DAYS_LEFT days"
            echo "DAYS_LEFT=${DAYS_LEFT}" >> $GITHUB_ENV

            if [ $DAYS_LEFT -le 30 ]; then
              echo "::warning::SSL certificate expires in $DAYS_LEFT days"
            fi
          fi

      - name: Generate monitoring report
        run: |
          echo "# üìä Monitoring Report" > monitoring-report.md
          echo "" >> monitoring-report.md
          echo "## Report Generated: $(date)" >> monitoring-report.md
          echo "" >> monitoring-report.md
          echo "### Performance Metrics" >> monitoring-report.md
          echo "- Performance Score: ${PERFORMANCE_SCORE:-N/A}" >> monitoring-report.md
          echo "- First Contentful Paint: ${FCP:-N/A}s" >> monitoring-report.md
          echo "- Largest Contentful Paint: ${LCP:-N/A}s" >> monitoring-report.md
          echo "" >> monitoring-report.md
          echo "### SSL Status" >> monitoring-report.md
          echo "- Certificate expires in: ${DAYS_LEFT:-N/A} days" >> monitoring-report.md
          echo "" >> monitoring-report.md
          echo "### Recommendations" >> monitoring-report.md
          echo "- Monitor performance metrics regularly" >> monitoring-report.md
          echo "- Renew SSL certificate before expiration" >> monitoring-report.md

      - name: Upload monitoring report
        uses: actions/upload-artifact@v4
        with:
          name: monitoring-report
          path: monitoring-report.md
          retention-days: 7

      - name: Send monitoring report
        if: always()
        run: |
          curl -X POST "${{ secrets.SLACK_WEBHOOK_URL }}" \
            -H 'Content-type: application/json' \
            --data "{
              \"text\": \"üìä JasaWeb Monitoring Report\",
              \"attachments\": [{
                \"color\": \"good\",
                \"fields\": [
                  {\"title\": \"Performance Score\", \"value\": \"${PERFORMANCE_SCORE:-N/A}\", \"short\": true},
                  {\"title\": \"SSL Certificate\", \"value\": \"${DAYS_LEFT:-N/A} days remaining\", \"short\": true},
                  {\"title\": \"Report Time\", \"value\": \"$(date)\", \"short\": true}
                ]
              }]
            }" || echo "Failed to send report"

  uptime-check:
    name: Uptime Check
    runs-on: ubuntu-latest
    if: github.event.schedule == '*/15 * * * *' || github.event_name == 'workflow_dispatch'
    steps:
      - name: Check service uptime
        run: |
          echo "‚è±Ô∏è Checking service uptime..."

          services=("https://jasaweb.com" "https://api.jasaweb.com/health")
          failed=0

          for service in "${services[@]}"; do
            echo "Checking $service..."

            start_time=$(date +%s.%N)
            status=$(curl -s -o /dev/null -w "%{http_code}" "$service" || echo "000")
            end_time=$(date +%s.%N)
            response_time=$(echo "$end_time - $start_time" | bc)

            if [ "$status" = "200" ]; then
              if (( $(echo "$response_time < 5.0" | bc -l) )); then
                echo "‚úÖ $service - OK (${response_time}s)"
              else
                echo "‚ö†Ô∏è $service - Slow response (${response_time}s)"
                echo "::warning::Slow response from $service"
              fi
            else
              echo "‚ùå $service - FAILED (HTTP $status)"
              echo "::error::Service $service is down"
              failed=1

              # Send immediate alert
              curl -X POST "${{ secrets.SLACK_WEBHOOK_URL }}" \
                -H 'Content-type: application/json' \
                --data "{
                  \"text\": \"üö® Service Down: $service\",
                  \"attachments\": [{
                    \"color\": \"danger\",
                    \"fields\": [
                      {\"title\": \"Service\", \"value\": \"$service\", \"short\": true},
                      {\"title\": \"Status Code\", \"value\": \"$status\", \"short\": true},
                      {\"title\": \"Time\", \"value\": \"$(date)\", \"short\": true}
                    ]
                  }]
                }" || echo "Failed to send alert"
            fi
          done

          exit $failed
