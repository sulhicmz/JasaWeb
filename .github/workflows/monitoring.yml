name: Monitoring & Alerts

on:
  workflow_dispatch:
  schedule:
    # Run daily at 9:00 AM UTC
    - cron: '0 9 * * *'
  pull_request:
    types: [opened, reopened, synchronize]

permissions:
  contents: read
  issues: write
  actions: read

jobs:
  check-build-health:
    name: Check Build Health
    runs-on: ubuntu-24.04-arm
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci

      - name: Build
        run: npm run build

      - name: Run Tests
        run: npm run test:run

      - name: Check Test Flakiness
        id: flaky_tests
        run: |
          # This would ideally connect to a test tracking system
          # For now, we'll just check if tests pass
          echo "âœ… All tests passed"
          echo "flaky=0" >> $GITHUB_OUTPUT

      - name: Check Build Time
        id: build_time
        run: |
          # Measure build time
          START=$(date +%s)
          npm run build
          END=$(date +%s)
          BUILD_TIME=$((END - START))
          
          echo "Build time: ${BUILD_TIME}s"
          
          if [ $BUILD_TIME -gt 60 ]; then
            echo "âš ï¸  Build time exceeds 60s threshold: ${BUILD_TIME}s"
            echo "build_slow=true" >> $GITHUB_OUTPUT
          else
            echo "âœ… Build time within acceptable range"
            echo "build_slow=false" >> $GITHUB_OUTPUT
          fi

      - name: Alert on Build Issues
        if: steps.flaky_tests.outputs.flaky == '1' || steps.build_time.outputs.build_slow == 'true'
        run: |
          # Create issue for build problems
          gh issue create \
            --title "âš ï¸ Build Health Alert - $(date +%Y-%m-%d)" \
            --label "ci" \
            --label "P2" \
            --body "Build health check detected issues:
            
            - Flaky tests: ${{ steps.flaky_tests.outputs.flaky }}
            - Slow build: ${{ steps.build_time.outputs.build_slow }}
            - Build time: ${{ steps.build_time.outputs.build_time }}s
            
            This issue was automatically created by the monitoring workflow."
          env:
            GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  check-code-quality:
    name: Check Code Quality
    runs-on: ubuntu-24.04-arm
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci

      - name: Type Check
        run: npm run typecheck

      - name: Lint
        run: npm run lint

      - name: Check for Console Logs
        id: console_logs
        run: |
          # Count console.log statements (excluding tests)
          CONSOLE_COUNT=$(grep -r "console.log" src --include="*.ts" --include="*.tsx" | wc -l)
          echo "console_log_count=${CONSOLE_COUNT}" >> $GITHUB_OUTPUT
          echo "Found ${CONSOLE_COUNT} console.log statements in source code"

      - name: Check for Untyped Code
        id: untyped
        run: |
          # Count 'any' type usages
          ANY_COUNT=$(grep -r ": any" src --include="*.ts" --include="*.tsx" | wc -l)
          echo "any_count=${ANY_COUNT}" >> $GITHUB_OUTPUT
          echo "Found ${ANY_COUNT} 'any' type usages"

      - name: Alert on Code Quality Issues
        if: steps.console_logs.outputs.console_log_count > 10 || steps.untyped.outputs.any_count > 20
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue create \
            --title "ðŸ“Š Code Quality Alert - $(date +%Y-%m-%d)" \
            --label "refactor" \
            --label "P3" \
            --body "Code quality check detected issues:

            - Console log statements: ${{ steps.console_logs.outputs.console_log_count }}
            - 'any' type usages: ${{ steps.untyped.outputs.any_count }}

            Recommendations:
            - Consider removing or replacing console.log statements with proper logging
            - Replace 'any' types with specific types for better type safety

            This issue was automatically created by the monitoring workflow."

  check-dependencies:
    name: Check Dependencies
    runs-on: ubuntu-24.04-arm
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci

      - name: Check for Vulnerabilities
        id: audit
        run: |
          npm audit --production 2>&1 | tee audit_report.txt || true
          
          VULNERABILITIES=$(grep -o "found [0-9]* vulnerabilities" audit_report.txt | grep -o "[0-9]*" || echo "0")
          echo "vulnerability_count=${VULNERABILITIES}" >> $GITHUB_OUTPUT
          echo "Found ${VULNERABILITIES} vulnerabilities"

      - name: Check Outdated Dependencies
        id: outdated
        run: |
          npm outdated 2>&1 | tee outdated_report.txt || true
          
          OUTDATED=$(grep -c " " outdated_report.txt || echo "0")
          echo "outdated_count=${OUTDATED}" >> $GITHUB_OUTPUT
          echo "Found ${OUTDATED} outdated dependencies"

      - name: Alert on Security Issues
        if: steps.audit.outputs.vulnerability_count > '0'
        run: |
          gh issue create \
            --title "ðŸ”’ Security Alert - Vulnerabilities Detected - $(date +%Y-%m-%d)" \
            --label "security" \
            --label "P0" \
            --body "Security audit detected vulnerabilities:
            
            - Vulnerabilities found: ${{ steps.audit.outputs.vulnerability_count }}
            
            Please review the audit report and update affected dependencies.
            
            Run 'npm audit fix' to automatically fix vulnerabilities.
            
            This issue was automatically created by the monitoring workflow."
          env:
            GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Alert on Outdated Dependencies
        if: steps.outdated.outputs.outdated_count > '5'
        run: |
          gh issue create \
            --title "ðŸ“¦ Dependencies Alert - Outdated Packages - $(date +%Y-%m-%d)" \
            --label "chore" \
            --label "P3" \
            --body "Dependencies check detected outdated packages:
            
            - Outdated dependencies: ${{ steps.outdated.outputs.outdated_count }}
            
            Please review and update outdated dependencies to ensure security and performance.
            
            Run 'npm outdated' to see which packages need updates.
            
            This issue was automatically created by the monitoring workflow."
          env:
            GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  summarize-findings:
    name: Summarize Monitoring Findings
    needs: [check-build-health, check-code-quality, check-dependencies]
    if: always()
    runs-on: ubuntu-24.04-arm
    
    steps:
      - name: Create Summary
        run: |
          echo "# Monitoring & Alerting Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Date:** $(date -u)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## Build Health" >> $GITHUB_STEP_SUMMARY
          echo "- Status: ${{ needs.check-build-health.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## Code Quality" >> $GITHUB_STEP_SUMMARY
          echo "- Status: ${{ needs.check-code-quality.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## Dependencies" >> $GITHUB_STEP_SUMMARY
          echo "- Status: ${{ needs.check-dependencies.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## Overall Health" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ needs.check-build-health.result }}" == "success" && "${{ needs.check-code-quality.result }}" == "success" && "${{ needs.check-dependencies.result }}" == "success" ]]; then
            echo "âœ… All checks passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸  Some checks failed. Please review the findings above." >> $GITHUB_STEP_SUMMARY
          fi
