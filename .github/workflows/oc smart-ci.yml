name: oc smart-ci

on:
  workflow_dispatch:
  workflow_run:
    workflows: ["oc standarizer"]
    types: [completed]

permissions:
  contents: write
  pull-requests: write
  actions: write

concurrency:
  group: oc-agent
  cancel-in-progress: false

jobs:
  smart-decision:
    name: Smart Decision & Fix
    runs-on: ubuntu-24.04-arm
    timeout-minutes: 20
    # Run if manual dispatch OR Standarizer Success
    # Note: CI Check Failures trigger this via workflow_dispatch explicitly, creating a specific event.
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event.workflow_run.name == 'oc standarizer' && github.event.workflow_run.conclusion == 'success')

    env:
      GH_TOKEN: ${{ secrets.GH_TOKEN }}
      IFLOW_API_KEY: ${{ secrets.IFLOW_API_KEY }}

    steps:
      - name: Wait in Queue
        uses: softprops/turnstyle@v2
        with:
          poll-interval-seconds: 10
          same-branch-only: false
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}

      - name: Checkout Agent Workspace
        uses: actions/checkout@v4
        with:
          ref: agent-workspace
          fetch-depth: 0
          token: ${{ secrets.GH_TOKEN }}

      - name: Standardized Node.js Setup
        uses: ./.github/workflows/setup
        with:
          node-version: 20
          cache-scope: 'smart-ci'
          install-deps: 'false' # Agent will install if needed

      - name: Configure Git & Sync
        run: |
          git config --global user.name "sulhicmz"
          git config --global user.email "22936450+sulhicmz@users.noreply.github.com"
          
          # Ensure we are up to date with origin/agent-workspace (where ci-check pushed the report)
          git fetch origin agent-workspace
          git reset --hard origin/agent-workspace

      - name: Load System Health Context
        id: health
        run: |
          if [ -f "docs/system-health.md" ]; then
            echo "ðŸ“„ Reading System Health Report..."
            HEALTH_CONTENT=$(cat docs/system-health.md)
            
            # Debug: allow seeing content in logs if needed, but truncated
            echo "${HEALTH_CONTENT:0:500}..."
            
            # Heuristic Detection of Failures
            # We look for explicit markers typically generated by our reporting script
            if grep -q "âŒ" docs/system-health.md || grep -q "Failure" docs/system-health.md || grep -q "Grade: F" docs/system-health.md; then
               echo "status=failure" >> $GITHUB_OUTPUT
               echo "ðŸ”´ System Health indicates FAILURES."
            else
               echo "status=success" >> $GITHUB_OUTPUT
               echo "ðŸŸ¢ System Health looks GOOD."
            fi
          else
            echo "âš ï¸ Report not found. Defaulting to failure mode to trigger analysis."
            HEALTH_CONTENT="System Health Report not found on agent-workspace. Full diagnostics required."
            echo "status=failure" >> $GITHUB_OUTPUT
          fi
          
          # Pass content to Env for Agent
          {
            echo 'HEALTH_CONTEXT<<EOF'
            echo "$HEALTH_CONTENT"
            echo 'EOF'
          } >> $GITHUB_ENV

      - name: Install OpenCode CLI
        if: steps.health.outputs.status == 'failure'
        run: |
          curl -fsSL https://opencode.ai/install | bash
          echo "$HOME/.opencode/bin" >> $GITHUB_PATH

      - name: Auto-Fix Agent (triggered on Failures)
        if: steps.health.outputs.status == 'failure'
        run: |
          echo "ðŸ”§ **Triggering Auto-Fix Agent**..."
          
          opencode run "$(cat <<'PROMPT'
          You are a **Smart CI Fixer Agent**.
          The `CI Check` workflow has failed. Your job is to READ the health report and FIX the code on `agent-workspace`.
          
          **DIAGNOSTIC REPORT:**
          ${{ env.HEALTH_CONTEXT }}
          
          **YOUR MISSION:**
          1.  **Analyze**: Identify WHICH step failed (Lint? Test? Build? E2E?).
          2.  **Locate**: Find the file/module causing the error.
          3.  **Fix**: Apply a surgical fix to resolve the error.
              - If Lint error: Fix the style/syntax.
              - If Logic error: Fix the code logic.
              - If E2E failure: Fix the selector or race condition.
              - **Important**: Run `pnpm install` if you need to verify changes locally.
          4.  **Commit**: `fix(ci): resolve build/test failures`
          5.  **Push**: Push to `agent-workspace`.
          
          **CONSTRAINTS:**
          - Do not blindly delete code. Fix it.
          - If you cannot fix it, document the bug in `docs/bug.md`.
          PROMPT
          )" \
            --model iflowcn/glm-4.6 \
            --share false

      - name: Auto-Merge Gatekeeper (triggered on Success)
        if: steps.health.outputs.status == 'success'
        run: |
          echo "ðŸš€ **System Health is Green.** Initiating Merge Sequence."
          
          # Find the PR from agent-workspace to dev
          PR_URL=$(gh pr list --head agent-workspace --base dev --json url --jq '.[0].url')
          
          if [ -n "$PR_URL" ]; then
            echo "Found PR: $PR_URL"
            
            # Simple summarization for PR body
            SUMMARY=$(grep -E "Test|Build|Lint" docs/system-health.md | head -n 5 || echo "System Health: OK")
            
            # Update PR
            gh pr edit "$PR_URL" --body "## ðŸ¤– Auto-Generated PR (Smart CI)\n\n### System Health Check: âœ… PASS\n\n$SUMMARY"
            
            echo "Enabling Auto-Merge..."
            # --auto implies: Merge when requirements (CI Check) are met.
            gh pr merge "$PR_URL" --auto --merge
            echo "âœ… Auto-merge enabled."
            
          else
            echo "âš ï¸ No PR found. Creating one to ensure continuity..."
            gh pr create --base dev --head agent-workspace --title "chore(agent): automated updates" --body "Automated changes from agent-workspace."
          fi
