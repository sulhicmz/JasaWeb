name: Deploy

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production
  push:
    branches:
      - main
  pull_request:
    types: [closed]

permissions:
  contents: read
  deployments: write

jobs:
  deploy-staging:
    name: Deploy to Staging
    if: |
      github.event_name == 'workflow_dispatch' && inputs.environment == 'staging' ||
      github.event_name == 'push' && github.ref == 'refs/heads/main' ||
      github.event_name == 'pull_request' && github.event.pull_request.merged == true
    runs-on: ubuntu-24.04-arm
    environment:
      name: staging
      url: ${{ steps.deploy.outputs.url }}
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci

      - name: Run Tests
        run: npm run test:run

      - name: Run Type Check
        run: npm run typecheck

      - name: Run Lint
        run: npm run lint

      - name: Build
        run: npm run build

      - name: Deploy to Staging
        id: deploy
        env:
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          JWT_SECRET: ${{ secrets.STAGING_JWT_SECRET }}
        run: |
          wrangler deploy --env staging

      - name: Health Check
        run: |
          max_retries=5
          retry_count=0
          
          while [ $retry_count -lt $max_retries ]; do
            echo "Health check attempt $((retry_count + 1)) of $max_retries"
            
            if curl -f -s -o /dev/null -w "%{http_code}" https://staging.your-domain.workers.dev/api/health | grep -q "200\|404"; then
              echo "✅ Health check passed"
              exit 0
            fi
            
            retry_count=$((retry_count + 1))
            echo "Health check failed, retrying in 10 seconds..."
            sleep 10
          done
          
          echo "❌ Health check failed after $max_retries attempts"
          exit 1

      - name: Create Deployment Status Badge
        if: success()
        run: |
          curl -X POST ${{ github.api_url }}/repos/${{ github.repository }}/statuses/${{ github.sha }} \
            -H "Authorization: Bearer ${{ github.token }}" \
            -H "Accept: application/vnd.github+json" \
            -d '{
              "state": "success",
              "target_url": "https://staging.your-domain.workers.dev",
              "description": "Deployed to staging",
              "context": "deployment/staging"
            }'

  deploy-production:
    name: Deploy to Production
    if: |
      github.event_name == 'workflow_dispatch' && inputs.environment == 'production'
    runs-on: ubuntu-24.04-arm
    environment:
      name: production
      url: ${{ steps.deploy.outputs.url }}
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci

      - name: Run Tests
        run: npm run test:run

      - name: Run Type Check
        run: npm run typecheck

      - name: Run Lint
        run: npm run lint

      - name: Build
        run: npm run build

      - name: Backup Current Deployment
        id: backup
        env:
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        run: |
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          echo "backup_tag=rollback_$TIMESTAMP" >> $GITHUB_OUTPUT
          wrangler deployment list --env production > /tmp/deployment_backup_$TIMESTAMP.txt

      - name: Deploy to Production
        id: deploy
        env:
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
        run: |
          wrangler deploy --env production

      - name: Health Check
        run: |
          max_retries=5
          retry_count=0
          
          while [ $retry_count -lt $max_retries ]; do
            echo "Health check attempt $((retry_count + 1)) of $max_retries"
            
            if curl -f -s -o /dev/null -w "%{http_code}" https://your-domain.workers.dev/api/health | grep -q "200\|404"; then
              echo "✅ Health check passed"
              exit 0
            fi
            
            retry_count=$((retry_count + 1))
            echo "Health check failed, retrying in 10 seconds..."
            sleep 10
          done
          
          echo "❌ Health check failed after $max_retries attempts"
          echo "Initiating rollback..."
          exit 1

      - name: Rollback on Failure
        if: failure()
        env:
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        run: |
          echo "Rolling back deployment due to health check failure..."
          # Rollback logic would go here
          # For Cloudflare Workers, you'd typically redeploy the previous version
          
      - name: Create Deployment Status Badge
        if: success()
        run: |
          curl -X POST ${{ github.api_url }}/repos/${{ github.repository }}/statuses/${{ github.sha }} \
            -H "Authorization: Bearer ${{ github.token }}" \
            -H "Accept: application/vnd.github+json" \
            -d '{
              "state": "success",
              "target_url": "https://your-domain.workers.dev",
              "description": "Deployed to production",
              "context": "deployment/production"
            }'

      - name: Notify Success
        if: success()
        run: |
          echo "✅ Production deployment successful!"
          # Add Slack/Email notification here
