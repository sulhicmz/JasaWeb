---
/**
 * Projects List Page (Web Saya)
 * Shows all user's projects
 */
import PortalLayout from '../../layouts/PortalLayout.astro';
import Card from '../../components/ui/Card.astro';
import Button from '../../components/ui/Button.astro';
---

<PortalLayout title="Web Saya" currentPath="/dashboard/projects">
  <div class="page-header">
    <p class="page-description">Daftar website yang Anda pesan</p>
    <Button href="/layanan" variant="primary" size="sm">+ Pesan Baru</Button>
  </div>

  <div id="projectsList" class="projects-grid">
    <Card padding="lg" class="loading-state">
      <p>Memuat proyek...</p>
    </Card>
  </div>
</PortalLayout>

<style>
  .page-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 2rem;
  }

  .page-description {
    color: var(--color-text-secondary);
  }

  .projects-grid {
    display: grid;
    gap: 1.5rem;
  }

  .loading-state,
  .empty-state {
    text-align: center;
    color: var(--color-text-secondary);
    padding: 3rem;
  }

  .project-card {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 1.5rem;
    padding: 1.5rem;
    background: var(--color-bg-secondary);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-lg);
  }

  .project-info {
    flex: 1;
  }

  .project-name {
    font-size: 1.125rem;
    font-weight: 600;
    margin-bottom: 0.5rem;
  }

  .project-type {
    color: var(--color-text-secondary);
    font-size: 0.875rem;
    margin-bottom: 1rem;
  }

  .project-meta {
    display: flex;
    gap: 1rem;
    font-size: 0.75rem;
    color: var(--color-text-muted);
  }

  .project-actions {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    align-items: flex-end;
  }

  .status-badge {
    padding: 0.25rem 0.75rem;
    color: white;
    border-radius: 999px;
    font-size: 0.75rem;
    font-weight: 500;
  }

  .status-pending_payment {
    background: var(--color-secondary);
  }

  .status-in_progress {
    background: var(--color-primary);
  }

  .status-review {
    background: var(--color-bg-tertiary);
  }

  .status-completed {
    background: var(--color-success);
  }

  .project-link {
    font-size: 0.75rem;
    color: var(--color-primary);
    font-weight: 500;
    text-decoration: none;
    transition: color var(--transition-fast);
  }

  .project-link:hover {
    color: var(--color-primary-dark);
  }
</style>

<script>
  async function loadProjects() {
    const container = document.getElementById('projectsList');
    if (!container) return;

    try {
      const res = await fetch('/api/client/projects');
      const data = await res.json();

      if (!res.ok || !data.success) {
        container.innerHTML = '<div class="empty-state"><p>Gagal memuat proyek</p></div>';
        return;
      }

      if (data.data.length === 0) {
        container.innerHTML = '<div class="empty-state"><p>Belum ada proyek. <a href="/layanan" style="color:var(--color-primary)">Pesan sekarang</a></p></div>';
        return;
      }

      // Create project cards using the component structure
      container.innerHTML = data.data.map((project: any) => {
        return '<div class="project-card">' +
          '<div class="project-info">' +
            '<div class="project-name">' + project.name + '</div>' +
            '<div class="project-type">' + project.type + '</div>' +
            '<div class="project-meta">' +
              '<span>Dibuat: ' + new Date(project.createdAt).toLocaleDateString('id-ID') + '</span>' +
            '</div>' +
          '</div>' +
          '<div class="project-actions">' +
            '<span class="status-badge status-' + project.status + '">' + getStatusLabel(project.status) + '</span>' +
            (project.url ? '<a href="' + project.url + '" target="_blank" class="project-link">Kunjungi â†’</a>' : '') +
          '</div>' +
        '</div>';
      }).join('');
    } catch (e) {
      container.innerHTML = '<div class="empty-state"><p>Terjadi kesalahan</p></div>';
    }
  }

  function getStatusLabel(status: string) {
    const labels: Record<string, string> = {
      pending_payment: 'Menunggu Bayar',
      in_progress: 'Dalam Proses',
      review: 'Review',
      completed: 'Selesai'
    };
    return labels[status] || status;
  }

  loadProjects();
</script>
