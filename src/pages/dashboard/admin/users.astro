---
import AdminLayout from '@/layouts/AdminLayout.astro';
import { siteConfig } from '@/lib/config';
import Card from '@/components/ui/Card.astro';
import AdminHeader from '@/components/ui/AdminHeader.astro';
import AdminTable from '@/components/ui/AdminTable.astro';

interface User {
  id: string;
  email: string;
  name: string;
  phone?: string;
  role: string;
  createdAt: string;
}

let users: User[] = [];
let error = '';

try {
  const response = await fetch(`${siteConfig.url}/api/admin/users`, {
    headers: {
      'Cookie': Astro.request.headers.get('Cookie') || '',
    },
  });
  
  if (!response.ok) {
    throw new Error('Failed to fetch users');
  }
  
  const data = await response.json();
  users = data.data || data;
} catch (e) {
  error = e instanceof Error ? e.message : 'Unknown error';
}
---

<AdminLayout title="Manage Users" currentPath="/dashboard/admin/users">
  <AdminHeader 
    title="Manage Users"
    description="View and manage client accounts"
    actions={[
      {
        href: "/dashboard/admin/users/new",
        variant: "primary",
        text: "Add New User"
      }
    ]}
  />

  <Card>
    <AdminTable
      data={users}
      error={error}
      columns={[
        {
          key: "name",
          label: "Name"
        },
        {
          key: "email",
          label: "Email"
        },
        {
          key: "phone",
          label: "Phone",
          render: (user) => user.phone || '-'
        },
        {
          key: "role",
          label: "Role",
          badge: { 
            variant: "error",
            condition: (value) => value === 'admin'
          }
        },
        {
          key: "createdAt",
          label: "Joined",
          date: true
        }
      ]}
      actions={[
        {
          href: (user) => `/dashboard/admin/users/${user.id}`,
          text: "Edit",
          variant: "outline",
          size: "sm"
        }
      ]}
      emptyMessage="No users found"
    />
  </Card>
</AdminLayout>