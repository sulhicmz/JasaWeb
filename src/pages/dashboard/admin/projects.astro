---
import AdminLayout from '@/layouts/AdminLayout.astro';
import { siteConfig } from '@/lib/config';
import Card from '@/components/ui/Card.astro';
import AdminHeader from '@/components/ui/AdminHeader.astro';
import AdminTable from '@/components/ui/AdminTable.astro';

interface Project {
  id: string;
  name: string;
  type: string;
  status: string;
  url?: string;
  user: {
    name: string;
    email: string;
  };
  createdAt: string;
  updatedAt: string;
}

let projects: Project[] = [];
let error = '';

try {
  const response = await fetch(`${siteConfig.url}/api/admin/projects`, {
    headers: {
      'Cookie': Astro.request.headers.get('Cookie') || '',
    },
  });
  
  if (!response.ok) {
    throw new Error('Failed to fetch projects');
  }
  
  const data = await response.json();
  projects = data.data || data;
} catch (e) {
  error = e instanceof Error ? e.message : 'Unknown error';
}
---

<AdminLayout title="Manage Projects" currentPath="/dashboard/admin/projects">
  <AdminHeader 
    title="Manage Projects"
    description="View and manage client projects"
    actions={[
      {
        href: "/dashboard/admin/projects/new",
        variant: "primary",
        text: "Add New Project"
      }
    ]}
  />

  <Card>
    <AdminTable
      data={projects}
      error={error}
      columns={[
        {
          key: "name",
          label: "Project",
          render: (project) => `
            <div>
              <div class="font-medium text-white">${project.name}</div>
              ${project.url ? `
                <div class="text-[var(--color-text-secondary)] text-sm">
                  <a href="${project.url}" target="_blank" class="text-[var(--color-primary)] hover:underline">
                    ${project.url}
                  </a>
                </div>
              ` : ''}
            </div>
          `
        },
        {
          key: "user.name",
          label: "Client",
          render: (project) => `
            <div class="text-[var(--color-text)]">${project.user.name}</div>
            <div class="text-[var(--color-text-secondary)] text-sm">${project.user.email}</div>
          `
        },
        {
          key: "type",
          label: "Type",
          badge: { variant: "default" }
        },
        {
          key: "status",
          label: "Status",
          render: (project) => {
            const statusVariant = project.status === 'completed' ? 'success' :
                               project.status === 'in_progress' ? 'primary' :
                               project.status === 'review' ? 'warning' : 'error';
            return `<div><Badge variant="${statusVariant}">${project.status.replace('_', ' ')}</Badge></div>`;
          }
        },
        {
          key: "createdAt",
          label: "Created",
          date: true
        }
      ]}
      actions={[
        {
          href: (project) => `/dashboard/admin/projects/${project.id}`,
          text: "Edit",
          variant: "outline",
          size: "sm"
        }
      ]}
      emptyMessage="No projects found"
    />
  </Card>
</AdminLayout>