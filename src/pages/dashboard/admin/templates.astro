---
/**
 * Template Management Page
 * Admin interface for managing templates
 */
import AdminLayout from '../../layouts/AdminLayout.astro';
import Section from '../../components/ui/Section.astro';
import Card from '../../components/ui/Card.astro';
import Button from '../../components/ui/Button.astro';
import Badge from '../../components/ui/Badge.astro';
import Form from '../../components/ui/Form.astro';
import FormGroup from '../../components/ui/FormGroup.astro';
import FormInput from '../../components/ui/FormInput.astro';
---
<AdminLayout title="Template Management" currentPath="/dashboard/admin/templates">
  <Section spacing="md">
    <div class="admin-header">
      <h1>Template <span class="gradient-text">Management</span></h1>
      <p>Kelola template website untuk layanan JasaWeb</p>
      <div class="header-actions">
        <Button 
          href="#add-template" 
          variant="primary" 
          id="addTemplateBtn"
          onclick="document.getElementById('add-modal').classList.add('active')"
        >
          + Tambah Template
        </Button>
      </div>
    </div>

    <!-- Filters -->
    <div class="filters-section">
      <FormGroup>
        <FormInput 
          type="text" 
          placeholder="Cari template..." 
          id="searchInput"
          name="search"
        />
      </FormGroup>
      <FormGroup>
        <select id="categoryFilter" class="form-select">
          <option value="">Semua Kategori</option>
          <option value="sekolah">Web Sekolah</option>
          <option value="berita">Portal Berita</option>
          <option value="company">Company Profile</option>
        </select>
      </FormGroup>
    </div>
  </Section>

  <Section spacing="lg">
    <div class="templates-table-container">
      <div class="table-responsive">
        <table class="admin-table" id="templatesTable">
          <thead>
            <tr>
              <th>Nama Template</th>
              <th>Kategori</th>
              <th>Demo URL</th>
              <th>Dibuat</th>
              <th>Aksi</th>
            </tr>
          </thead>
          <tbody id="templatesTableBody">
            <tr>
              <td colspan="5" class="loading-row">Loading templates...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </Section>

  <!-- Add/Edit Template Modal -->
  <div class="modal" id="templateModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="modalTitle">Tambah Template Baru</h3>
        <button class="modal-close" onclick="closeModal()">&times;</button>
      </div>
      <div class="modal-body">
        <Form id="templateForm">
          <FormGroup>
            <label for="templateName">Nama Template</label>
            <FormInput 
              type="text" 
              id="templateName" 
              name="name"
              required
            />
          </FormGroup>
          
          <FormGroup>
            <label for="templateCategory">Kategori</label>
            <select id="templateCategory" name="category" class="form-select" required>
              <option value="">Pilih Kategori</option>
              <option value="sekolah">Web Sekolah</option>
              <option value="berita">Portal Berita</option>
              <option value="company">Company Profile</option>
            </select>
          </FormGroup>
          
          <FormGroup>
            <label for="templateImageUrl">Image URL</label>
            <FormInput 
              type="url" 
              id="templateImageUrl" 
              name="imageUrl"
              placeholder="https://example.com/image.jpg"
              required
            />
          </FormGroup>
          
          <FormGroup>
            <label for="templateDemoUrl">Demo URL</label>
            <FormInput 
              type="url" 
              id="templateDemoUrl" 
              name="demoUrl"
              placeholder="https://example.com/demo"
              required
            />
          </FormGroup>
          
          <div class="form-actions">
            <Button type="button" variant="secondary" onclick="closeModal()">
              Batal
            </Button>
            <Button type="submit" variant="primary" id="submitBtn">
              Simpan Template
            </Button>
          </div>
        </Form>
      </div>
    </div>
  </div>

  <!-- Delete Confirmation Modal -->
  <div class="modal" id="deleteModal">
    <div class="modal-content modal-sm">
      <div class="modal-header">
        <h3>Konfirmasi Hapus</h3>
        <button class="modal-close" onclick="closeDeleteModal()">&times;</button>
      </div>
      <div class="modal-body">
        <p>Apakah Anda yakin ingin menghapus template "<span id="deleteTemplateName"></span>"?</p>
        <p class="warning">Tindakan ini tidak dapat dibatalkan.</p>
        <div class="form-actions">
          <Button type="button" variant="secondary" onclick="closeDeleteModal()">
            Batal
          </Button>
          <Button type="button" variant="error" onclick="confirmDelete()">
            Hapus
          </Button>
        </div>
      </div>
    </div>
  </div>
</AdminLayout>

<style>
  .admin-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    flex-wrap: wrap;
    gap: 1rem;
  }
  
  .header-actions {
    display: flex;
    gap: 0.75rem;
  }

  .filters-section {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
    align-items: flex-end;
    margin-bottom: 2rem;
  }

  .filters-section .form-group {
    flex: 1;
    min-width: 200px;
  }

  .templates-table-container {
    background: var(--color-bg-secondary);
    border-radius: var(--radius-lg);
    padding: 1.5rem;
    border: 1px solid var(--color-border);
  }

  .table-responsive {
    overflow-x: auto;
  }

  .admin-table {
    width: 100%;
    border-collapse: collapse;
  }

  .admin-table th {
    background: var(--color-bg-tertiary);
    padding: 1rem;
    text-align: left;
    font-weight: 600;
    border-bottom: 1px solid var(--color-border);
    white-space: nowrap;
  }

  .admin-table td {
    padding: 1rem;
    border-bottom: 1px solid var(--color-border);
  }

  .admin-table tr:hover {
    background: var(--color-bg-tertiary);
  }

  .loading-row {
    text-align: center;
    color: var(--color-text-muted);
  }

  .form-select {
    width: 100%;
    padding: 0.75rem;
    background: var(--color-bg-secondary);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    color: var(--color-text);
    font-size: 0.875rem;
  }

  .form-select:focus {
    outline: none;
    border-color: var(--color-primary);
    box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
  }

  .modal {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.5);
    align-items: center;
    justify-content: center;
    z-index: 1000;
    backdrop-filter: blur(4px);
  }

  .modal.active {
    display: flex;
  }

  .modal-content {
    background: var(--color-bg-secondary);
    border-radius: var(--radius-lg);
    width: 90%;
    max-width: 500px;
    max-height: 90vh;
    overflow-y: auto;
    border: 1px solid var(--color-border);
  }

  .modal-content.modal-sm {
    max-width: 400px;
  }

  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1.5rem;
    border-bottom: 1px solid var(--color-border);
  }

  .modal-header h3 {
    margin: 0;
    font-size: 1.25rem;
  }

  .modal-close {
    background: none;
    border: none;
    color: var(--color-text-secondary);
    font-size: 1.5rem;
    cursor: pointer;
    padding: 0.25rem;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: var(--radius-sm);
    transition: all var(--transition-fast);
  }

  .modal-close:hover {
    background: var(--color-bg-tertiary);
    color: var(--color-text);
  }

  .modal-body {
    padding: 1.5rem;
  }

  .form-actions {
    display: flex;
    gap: 0.75rem;
    justify-content: flex-end;
    margin-top: 1.5rem;
  }

  .warning {
    color: var(--color-error);
    margin: 1rem 0;
    font-size: 0.875rem;
  }

  .action-buttons {
    display: flex;
    gap: 0.5rem;
  }

  @media (max-width: 768px) {
    .admin-header {
      flex-direction: column;
      align-items: stretch;
    }

    .header-actions {
      justify-content: stretch;
    }

    .filters-section {
      flex-direction: column;
    }

    .filters-section .form-group {
      min-width: auto;
    }

    .modal-content {
      width: 95%;
      margin: 1rem;
    }

    .admin-table {
      font-size: 0.875rem;
    }

    .admin-table th,
    .admin-table td {
      padding: 0.5rem;
    }
  }
</style>

<script>
  let templates = [];
  let editingTemplateId = null;

  // Load templates on page load
  document.addEventListener('DOMContentLoaded', async () => {
    await loadTemplates();
    setupEventListeners();
  });

  function setupEventListeners() {
    // Search input
    document.getElementById('searchInput').addEventListener('input', filterTemplates);
    
    // Category filter
    document.getElementById('categoryFilter').addEventListener('change', filterTemplates);
    
    // Form submission
    document.getElementById('templateForm').addEventListener('submit', handleFormSubmit);
  }

  async function loadTemplates() {
    try {
      const response = await fetch('/api/admin/templates');
      const data = await response.json();
      
      if (response.ok) {
        templates = data.templates;
        renderTemplates();
      } else {
        showError('Gagal memuat templates: ' + data.error);
      }
    } catch (error) {
      showError('Error memuat templates: ' + error.message);
    }
  }

  function renderTemplates(filteredTemplates = null) {
    const tbody = document.getElementById('templatesTableBody');
    const templatesToRender = filteredTemplates || templates;
    
    if (templatesToRender.length === 0) {
      tbody.innerHTML = `
        <tr>
          <td colspan="5" class="loading-row">
            ${templates.length === 0 ? 'Tidak ada template tersedia' : 'Tidak ada template yang cocok dengan filter'}
          </td>
        </tr>
      `;
      return;
    }

    tbody.innerHTML = templatesToRender.map(template => `
      <tr>
        <td>
          <div>
            <strong>${template.name}</strong><br>
            <small style="color: var(--color-text-muted)">
              <img src="${template.imageUrl}" alt="${template.name}" style="width: 60px; height: 40px; object-fit: cover; border-radius: var(--radius-sm);">
            </small>
          </div>
        </td>
        <td>
          <Badge variant="info">${getCategoryLabel(template.category)}</Badge>
        </td>
        <td>
          <a href="${template.demoUrl}" target="_blank" style="color: var(--color-primary);">
            Lihat Demo
          </a>
        </td>
        <td>${new Date(template.createdAt).toLocaleDateString('id-ID')}</td>
        <td>
          <div class="action-buttons">
            <Button href="#" variant="secondary" size="sm" onclick="editTemplate('${template.id}')">
              Edit
            </Button>
            <Button href="#" variant="error" size="sm" onclick="deleteTemplate('${template.id}', '${template.name}')">
              Hapus
            </Button>
          </div>
        </td>
      </tr>
    `).join('');
  }

  function filterTemplates() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const categoryFilter = document.getElementById('categoryFilter').value;
    
    const filtered = templates.filter(template => {
      const matchesSearch = template.name.toLowerCase().includes(searchTerm);
      const matchesCategory = !categoryFilter || template.category === categoryFilter;
      return matchesSearch && matchesCategory;
    });
    
    renderTemplates(filtered);
  }

  function getCategoryLabel(category) {
    const labels = {
      sekolah: 'ðŸ« Web Sekolah',
      berita: 'ðŸ“° Portal Berita',
      company: 'ðŸ¢ Company Profile'
    };
    return labels[category] || category;
  }

  function openModal() {
    document.getElementById('templateModal').classList.add('active');
  }

  function closeModal() {
    document.getElementById('templateModal').classList.remove('active');
    document.getElementById('templateForm').reset();
    editingTemplateId = null;
  }

  function editTemplate(id) {
    const template = templates.find(t => t.id === id);
    if (!template) return;

    editingTemplateId = id;
    document.getElementById('modalTitle').textContent = 'Edit Template';
    document.getElementById('templateName').value = template.name;
    document.getElementById('templateCategory').value = template.category;
    document.getElementById('templateImageUrl').value = template.imageUrl;
    document.getElementById('templateDemoUrl').value = template.demoUrl;
    
    openModal();
  }

  function deleteTemplate(id, name) {
    document.getElementById('deleteTemplateName').textContent = name;
    document.getElementById('deleteModal').classList.add('active');
    
    // Store id for confirmation
    window.templateToDelete = id;
  }

  function closeDeleteModal() {
    document.getElementById('deleteModal').classList.remove('active');
    window.templateToDelete = null;
  }

  async function confirmDelete() {
    const id = window.templateToDelete;
    if (!id) return;

    try {
      const response = await fetch(`/api/admin/templates/${id}`, {
        method: 'DELETE',
        headers: {
          'Content-Type': 'application/json',
          'x-csrf-token': getCsrfToken()
        }
      });

      if (response.ok) {
        showSuccess('Template berhasil dihapus');
        await loadTemplates();
      } else {
        const data = await response.json();
        showError('Gagal menghapus template: ' + data.error);
      }
    } catch (error) {
      showError('Error menghapus template: ' + error.message);
    } finally {
      closeDeleteModal();
    }
  }

  async function handleFormSubmit(e) {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    const data = {
      name: formData.get('name'),
      category: formData.get('category'),
      imageUrl: formData.get('imageUrl'),
      demoUrl: formData.get('demoUrl')
    };

    const url = editingTemplateId 
      ? `/api/admin/templates/${editingTemplateId}`
      : '/api/admin/templates';
    
    const method = editingTemplateId ? 'PUT' : 'POST';

    try {
      const response = await fetch(url, {
        method,
        headers: {
          'Content-Type': 'application/json',
          'x-csrf-token': getCsrfToken()
        },
        body: JSON.stringify(data)
      });

      if (response.ok) {
        showSuccess(editingTemplateId ? 'Template berhasil diupdate' : 'Template berhasil dibuat');
        closeModal();
        await loadTemplates();
      } else {
        const result = await response.json();
        showError('Gagal menyimpan template: ' + result.error);
      }
    } catch (error) {
      showError('Error menyimpan template: ' + error.message);
    }
  }

  function getCsrfToken() {
    const meta = document.querySelector('meta[name="csrf-token"]');
    return meta ? meta.getAttribute('content') : '';
  }

  function showSuccess(message) {
    // Implement success notification
    console.log('Success:', message);
  }

  function showError(message) {
    // Implement error notification
    console.error('Error:', message);
  }
</script>