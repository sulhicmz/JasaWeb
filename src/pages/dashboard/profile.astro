---
/**
 * Profile Page (Akun Saya)
 * Edit profile and change password
 */
import PortalLayout from '../../layouts/PortalLayout.astro';
import Card from '../../components/ui/Card.astro';
import Button from '../../components/ui/Button.astro';
import Form from '../../components/ui/Form.astro';
import FormGroup from '../../components/ui/FormGroup.astro';
import FormInput from '../../components/ui/FormInput.astro';

const user = Astro.locals.user;
---

<PortalLayout title="Akun Saya" currentPath="/dashboard/profile">
  <div class="profile-grid">
    <Card padding="lg">
      <h2>Informasi Profil</h2>
      <Form id="profileForm" class="form">
            <FormGroup label="Nama Lengkap" labelFor="name" required>
              <FormInput
                type="text"
                id="name"
                name="name"
                value={user?.name || ''}
                required
              />
            </FormGroup>

            <FormGroup 
              label="Email" 
              labelFor="email"
              hint="Email tidak dapat diubah"
              disabled
            >
              <FormInput
                type="email"
                id="email"
                name="email"
                value={user?.email || ''}
                disabled
              />
            </FormGroup>

            <FormGroup label="No. WhatsApp" labelFor="phone">
              <FormInput
                type="tel"
                id="phone"
                name="phone"
                placeholder="08123456789"
              />
            </FormGroup>

            <Button type="submit" variant="primary">Simpan Perubahan</Button>
            <div id="profileMessageContainer"></div>
          </Form>
    </Card>

    <Card padding="lg">
      <h2>Ubah Password</h2>
      <Form id="passwordForm" class="form">
            <FormGroup label="Password Saat Ini" labelFor="currentPassword" required>
              <FormInput
                type="password"
                id="currentPassword"
                name="currentPassword"
                required
              />
            </FormGroup>

            <FormGroup label="Password Baru" labelFor="newPassword" required>
              <FormInput
                type="password"
                id="newPassword"
                name="newPassword"
                minlength={8}
                required
              />
            </FormGroup>

            <FormGroup label="Konfirmasi Password" labelFor="confirmPassword" required>
              <FormInput
                type="password"
                id="confirmPassword"
                name="confirmPassword"
                required
              />
            </FormGroup>

            <Button type="submit" variant="secondary">Ubah Password</Button>
            <div id="passwordMessageContainer"></div>
          </Form>
    </Card>
  </div>
</PortalLayout>

<style>
  .profile-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 2rem;
  }

  h2 {
    font-size: 1.25rem;
    margin-bottom: 1.5rem;
  }

  .form {
    display: flex;
    flex-direction: column;
    gap: 1.25rem;
  }

  

  @media (max-width: 768px) {
    .profile-grid {
      grid-template-columns: 1fr;
    }
  }
</style>

<script>
  // Profile form
  const profileForm = document.getElementById('profileForm') as HTMLFormElement;
  const profileMsgContainer = document.getElementById('profileMessageContainer');

  profileForm?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData(profileForm);
    
    try {
      const res = await fetch('/api/client/profile', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          name: formData.get('name'),
          phone: formData.get('phone'),
        }),
      });

      const data = await res.json();
      
      if (profileMsgContainer) {
        const message = (data as any).message || (data as any).error || 'Berhasil disimpan';
        const type = res.ok ? 'success' : 'error';
        profileMsgContainer.innerHTML = `<div class="form-message ${type}" style="display: block;">${message}</div>`;
      }
    } catch {
      if (profileMsgContainer) {
        profileMsgContainer.innerHTML = '<div class="form-message error" style="display: block;">Terjadi kesalahan</div>';
      }
    }
  });

  // Password form
  const passwordForm = document.getElementById('passwordForm') as HTMLFormElement;
  const passwordMsgContainer = document.getElementById('passwordMessageContainer');

  passwordForm?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData(passwordForm);
    
    if (formData.get('newPassword') !== formData.get('confirmPassword')) {
      if (passwordMsgContainer) {
        passwordMsgContainer.innerHTML = '<div class="form-message error" style="display: block;">Password tidak cocok</div>';
      }
      return;
    }

    try {
      const res = await fetch('/api/client/password', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          currentPassword: formData.get('currentPassword'),
          newPassword: formData.get('newPassword'),
        }),
      });

      const data = await res.json();
      
      if (passwordMsgContainer) {
        const message = (data as any).message || (data as any).error || 'Password diubah';
        const type = res.ok ? 'success' : 'error';
        passwordMsgContainer.innerHTML = `<div class="form-message ${type}" style="display: block;">${message}</div>`;
      }

      if (res.ok) {
        passwordForm.reset();
      }
    } catch {
      if (passwordMsgContainer) {
        passwordMsgContainer.innerHTML = '<div class="form-message error" style="display: block;">Terjadi kesalahan</div>';
      }
    }
  });
</script>
