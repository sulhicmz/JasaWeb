---
/**
 * Profile Page (Akun Saya)
 * Edit profile and change password
 */
import PortalLayout from '../../layouts/PortalLayout.astro';
import Card from '../../components/ui/Card.astro';
import Button from '../../components/ui/Button.astro';

const user = Astro.locals.user;
---

<PortalLayout title="Akun Saya" currentPath="/dashboard/profile">
  <div class="profile-grid">
    <Card padding="lg">
      <h2>Informasi Profil</h2>
      <form id="profileForm" class="form">
        <div class="form-group">
          <label for="name">Nama Lengkap</label>
          <input type="text" id="name" name="name" value={user?.name || ''} required />
        </div>

        <div class="form-group">
          <label for="email">Email</label>
          <input type="email" id="email" name="email" value={user?.email || ''} disabled />
          <span class="form-hint">Email tidak dapat diubah</span>
        </div>

        <div class="form-group">
          <label for="phone">No. WhatsApp</label>
          <input type="tel" id="phone" name="phone" placeholder="08123456789" />
        </div>

        <Button type="submit" variant="primary">Simpan Perubahan</Button>
        <div id="profileMessage" class="form-message"></div>
      </form>
    </Card>

    <Card padding="lg">
      <h2>Ubah Password</h2>
      <form id="passwordForm" class="form">
        <div class="form-group">
          <label for="currentPassword">Password Saat Ini</label>
          <input type="password" id="currentPassword" name="currentPassword" required />
        </div>

        <div class="form-group">
          <label for="newPassword">Password Baru</label>
          <input type="password" id="newPassword" name="newPassword" minlength="8" required />
        </div>

        <div class="form-group">
          <label for="confirmPassword">Konfirmasi Password</label>
          <input type="password" id="confirmPassword" name="confirmPassword" required />
        </div>

        <Button type="submit" variant="secondary">Ubah Password</Button>
        <div id="passwordMessage" class="form-message"></div>
      </form>
    </Card>
  </div>
</PortalLayout>

<style>
  .profile-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 2rem;
  }

  h2 {
    font-size: 1.25rem;
    margin-bottom: 1.5rem;
  }

  .form {
    display: flex;
    flex-direction: column;
    gap: 1.25rem;
  }

  .form-group {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .form-group label {
    font-size: 0.875rem;
    font-weight: 500;
  }

  .form-group input {
    padding: 0.75rem 1rem;
    background: var(--color-bg);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    color: var(--color-text);
    font-size: 0.875rem;
  }

  .form-group input:focus {
    outline: none;
    border-color: var(--color-primary);
  }

  .form-group input:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  .form-hint {
    font-size: 0.75rem;
    color: var(--color-text-muted);
  }

  .form-message {
    font-size: 0.875rem;
    text-align: center;
    display: none;
  }

  .form-message.success {
    display: block;
    color: var(--color-success);
  }

  .form-message.error {
    display: block;
    color: var(--color-error);
  }

  @media (max-width: 768px) {
    .profile-grid {
      grid-template-columns: 1fr;
    }
  }
</style>

<script>
  // Profile form
  const profileForm = document.getElementById('profileForm') as HTMLFormElement;
  const profileMsg = document.getElementById('profileMessage');

  profileForm?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData(profileForm);
    
    try {
      const res = await fetch('/api/client/profile', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          name: formData.get('name'),
          phone: formData.get('phone'),
        }),
      });

      const data = await res.json();
      
      if (profileMsg) {
        profileMsg.textContent = (data as any).message || (data as any).error || 'Berhasil disimpan';
        profileMsg.className = `form-message ${res.ok ? 'success' : 'error'}`;
      }
    } catch {
      if (profileMsg) {
        profileMsg.textContent = 'Terjadi kesalahan';
        profileMsg.className = 'form-message error';
      }
    }
  });

  // Password form
  const passwordForm = document.getElementById('passwordForm') as HTMLFormElement;
  const passwordMsg = document.getElementById('passwordMessage');

  passwordForm?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData(passwordForm);
    
    if (formData.get('newPassword') !== formData.get('confirmPassword')) {
      if (passwordMsg) {
        passwordMsg.textContent = 'Password tidak cocok';
        passwordMsg.className = 'form-message error';
      }
      return;
    }

    try {
      const res = await fetch('/api/client/password', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          currentPassword: formData.get('currentPassword'),
          newPassword: formData.get('newPassword'),
        }),
      });

      const data = await res.json();
      
      if (passwordMsg) {
        passwordMsg.textContent = (data as any).message || (data as any).error || 'Password diubah';
        passwordMsg.className = `form-message ${res.ok ? 'success' : 'error'}`;
      }

      if (res.ok) {
        passwordForm.reset();
      }
    } catch {
      if (passwordMsg) {
        passwordMsg.textContent = 'Terjadi kesalahan';
        passwordMsg.className = 'form-message error';
      }
    }
  });
</script>
