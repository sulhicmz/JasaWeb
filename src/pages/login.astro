---
/**
 * Login Page
 * REFACTORED: Uses PageLayout per AGENTS.md (BUG-005 fix)
 */
import PageLayout from '../layouts/PageLayout.astro';
import Section from '../components/ui/Section.astro';
import Card from '../components/ui/Card.astro';
import Button from '../components/ui/Button.astro';
import Form from '../components/ui/Form.astro';
import FormGroup from '../components/ui/FormGroup.astro';
import FormInput from '../components/ui/FormInput.astro';
---

<PageLayout title="Masuk" description="Masuk ke akun JasaWeb Anda" currentPath="/login">
  <Section spacing="lg" class="auth-section">
    <div class="auth-wrapper">
      <Card padding="lg">
        <div class="auth-header">
          <h1>Selamat Datang</h1>
          <p>Masuk ke akun Anda untuk melanjutkan</p>
        </div>

        <Form id="loginForm" class="auth-form">
            <FormGroup label="Email" labelFor="email" required>
              <FormInput
                type="email"
                id="email"
                name="email"
                placeholder="nama@email.com"
                required
              />
            </FormGroup>

            <FormGroup label="Password" labelFor="password" required>
              <FormInput
                type="password"
                id="password"
                name="password"
                placeholder="••••••••"
                required
              />
            </FormGroup>

            <div class="form-actions">
              <a href="/forgot-password" class="forgot-link">Lupa password?</a>
            </div>

            <Button type="submit" variant="primary" fullWidth>Masuk</Button>

            <div id="errorMessage" class="error-message"></div>
          </Form>

        <div class="auth-footer">
          <p>Belum punya akun? <a href="/register">Daftar sekarang</a></p>
        </div>
      </Card>
    </div>
  </Section>
</PageLayout>

<style>
  .auth-section {
    min-height: calc(100vh - 80px);
    display: flex;
    align-items: center;
  }

  .auth-wrapper {
    max-width: 400px;
    margin: 0 auto;
    width: 100%;
  }

  .auth-header {
    text-align: center;
    margin-bottom: 2rem;
  }

  .auth-header h1 {
    font-size: 1.75rem;
    margin-bottom: 0.5rem;
  }

  .auth-header p {
    color: var(--color-text-secondary);
    font-size: 0.875rem;
  }

  .auth-form {
    display: flex;
    flex-direction: column;
    gap: 1.25rem;
  }

  .form-actions {
    display: flex;
    justify-content: flex-end;
  }

  .forgot-link {
    font-size: 0.75rem;
    color: var(--color-primary);
  }

  .form-actions {
    display: flex;
    justify-content: flex-end;
  }

  .forgot-link {
    font-size: 0.75rem;
    color: var(--color-primary);
  }

  .error-message {
    color: var(--color-error);
    font-size: 0.875rem;
    text-align: center;
    display: none;
  }

  .error-message.show {
    display: block;
  }

  .auth-footer {
    margin-top: 2rem;
    padding-top: 1.5rem;
    border-top: 1px solid var(--color-border);
    text-align: center;
  }

  .auth-footer p {
    font-size: 0.875rem;
    color: var(--color-text-secondary);
  }

  .auth-footer a {
    color: var(--color-primary);
    font-weight: 500;
  }
</style>

<script>
  try {
    const form = document.getElementById('loginForm') as HTMLFormElement;
    const errorMsg = document.getElementById('errorMessage');

    if (!form || !errorMsg) throw new Error('Required elements not found');

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const formData = new FormData(form);
      const data = {
        email: formData.get('email'),
        password: formData.get('password'),
      };

      try {
        const res = await fetch('/api/auth/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data),
        });

        const result = await res.json();

        if (!res.ok) {
          errorMsg.textContent = (result as any).error || 'Login gagal';
          errorMsg.classList.add('show');
          return;
        }

        window.location.href = '/dashboard';
      } catch (err) {
        console.error('Login error:', err);
        errorMsg.textContent = 'Terjadi kesalahan. Silakan coba lagi.';
        errorMsg.classList.add('show');
      }
    });
  } catch (err) {
    console.error('Form initialization error:', err);
    // Fallback: Show basic error message
    document.body.insertAdjacentHTML('beforeend', 
      '<div style="color: var(--color-error); text-align: center; padding: 1rem;">Form login tidak dapat dimuat</div>'
    );
  }
</script>
