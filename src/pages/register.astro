---
/**
 * Register Page
 * REFACTORED: Uses PageLayout per AGENTS.md (BUG-006 fix)
 */
import PageLayout from '../layouts/PageLayout.astro';
import Section from '../components/ui/Section.astro';
import Card from '../components/ui/Card.astro';
import Button from '../components/ui/Button.astro';
import Form from '../components/ui/Form.astro';
import FormGroup from '../components/ui/FormGroup.astro';
import FormInput from '../components/ui/FormInput.astro';
---

<PageLayout title="Daftar" description="Daftar akun JasaWeb untuk mulai membuat website" currentPath="/register">
  <Section spacing="lg" class="auth-section">
    <div class="auth-wrapper">
      <Card padding="lg">
        <div class="auth-header">
          <h1>Daftar Akun</h1>
          <p>Buat akun untuk mulai membuat website impian Anda</p>
        </div>

        <Form id="registerForm" class="auth-form">
            <FormGroup label="Nama Lengkap" labelFor="name" required>
              <FormInput
                type="text"
                id="name"
                name="name"
                placeholder="John Doe"
                required
              />
            </FormGroup>

            <FormGroup label="Email" labelFor="email" required>
              <FormInput
                type="email"
                id="email"
                name="email"
                placeholder="nama@email.com"
                required
              />
            </FormGroup>

            <FormGroup label="No. WhatsApp" labelFor="phone">
              <FormInput
                type="tel"
                id="phone"
                name="phone"
                placeholder="08123456789"
              />
            </FormGroup>

            <FormGroup label="Password" labelFor="password" required>
              <FormInput
                type="password"
                id="password"
                name="password"
                placeholder="Minimal 8 karakter"
                minlength={8}
                required
              />
            </FormGroup>

            <FormGroup label="Konfirmasi Password" labelFor="confirmPassword" required>
              <FormInput
                type="password"
                id="confirmPassword"
                name="confirmPassword"
                placeholder="Ulangi password"
                required
              />
            </FormGroup>

            <Button type="submit" variant="primary" fullWidth>Daftar Sekarang</Button>

            <div id="errorMessage" class="error-message"></div>
            <div id="successMessage" class="success-message"></div>
          </Form>

        <div class="auth-footer">
          <p>Sudah punya akun? <a href="/login">Masuk di sini</a></p>
        </div>
      </Card>
    </div>
  </Section>
</PageLayout>

<style>
  .auth-section {
    min-height: calc(100vh - 80px);
    display: flex;
    align-items: center;
  }

  .auth-wrapper {
    max-width: 400px;
    margin: 0 auto;
    width: 100%;
  }

  .auth-header {
    text-align: center;
    margin-bottom: 2rem;
  }

  .auth-header h1 {
    font-size: 1.75rem;
    margin-bottom: 0.5rem;
  }

  .auth-header p {
    color: var(--color-text-secondary);
    font-size: 0.875rem;
  }

  .auth-form {
    display: flex;
    flex-direction: column;
    gap: 1.25rem;
  }

  .error-message {
    color: var(--color-error);
    font-size: 0.875rem;
    text-align: center;
    display: none;
  }

  .error-message.show {
    display: block;
  }

  .success-message {
    color: var(--color-success);
    font-size: 0.875rem;
    text-align: center;
    display: none;
  }

  .success-message.show {
    display: block;
  }

  .auth-footer {
    margin-top: 2rem;
    padding-top: 1.5rem;
    border-top: 1px solid var(--color-border);
    text-align: center;
  }

  .auth-footer p {
    font-size: 0.875rem;
    color: var(--color-text-secondary);
  }

  .auth-footer a {
    color: var(--color-primary);
    font-weight: 500;
  }
</style>

<script>
  import { AuthFormHandler } from '../services/auth/AuthFormHandler.js';
  import { AuthValidator } from '../services/auth/AuthValidator.js';

  try {
    // Initialize form handler
    const initialized = AuthFormHandler.initialize('errorMessage', 'successMessage');
    if (!initialized) {
      throw new Error('Failed to initialize form handler');
    }

    // Attach handler to register form with configuration
    const success = AuthFormHandler.attachToForm('registerForm', {
      endpoint: '/api/auth/register',
      successRedirect: '/login',
      successMessage: 'Registrasi berhasil! Mengalihkan...',
      errorMessage: 'Registrasi gagal',
      validation: AuthValidator.createValidator('register')
    });

    if (!success) {
      throw new Error('Failed to attach form handler');
    }
  } catch (err) {
    console.error('Form initialization error:', err);
    AuthFormHandler.showFallbackError('Form registrasi tidak dapat dimuat');
  }
</script>
