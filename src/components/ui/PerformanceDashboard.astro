---
/**
 * Performance Metrics Dashboard Component
 * 
 * Real-time performance monitoring dashboard with live metrics,
 * health indicators, and beautiful visualizations
 */
import Card from './Card.astro';

export interface Props {
  initialData?: {
    overall?: {
      score: number;
      status: string;
      bundleSize: number;
      lastUpdated: string;
    };
    bundle?: {
      summary: {
        totalSize: number;
        gzipSize: number;
        score: number;
      };
    };
    api?: {
      averageResponseTime: number;
      totalRequests: number;
      score: number;
      errorRate: number;
    };
    enhanced?: {
      components: Array<{
        name: string;
        score: number;
        status: string;
        metrics: Record<string, any>;
      }>;
      realTime: {
        timestamp: string;
        metrics: Array<{
          value: number;
          trend: 'up' | 'down' | 'stable';
          status: 'healthy' | 'warning' | 'critical';
          previousValue?: number;
        }>;
        alerts: Array<{
          severity: string;
          message: string;
          timestamp: string;
        }>;
      };
    };
  };
  currentPath?: string;
}

const { initialData, currentPath = '' } = Astro.props;

// Helper to format bytes
function formatBytes(bytes: number) {
  if (bytes < 1024) return bytes + ' B';
  if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
  return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
}

// Helper to get score grade
function getScoreGrade(score: number) {
  if (score >= 90) return { grade: 'A+', color: 'var(--color-success)' };
  if (score >= 80) return { grade: 'A', color: 'var(--color-success)' };
  if (score >= 70) return { grade: 'B', color: 'var(--color-secondary)' };
  if (score >= 60) return { grade: 'C', color: 'var(--color-secondary)' };
  return { grade: 'D', color: 'var(--color-error)' };
}

// Helper to get trend icon
function getTrendIcon(trend: string) {
  switch (trend) {
    case 'up': return 'üìà';
    case 'down': return 'üìâ';
    default: return '‚û°Ô∏è';
  }
}

const systemComponents = [
  {
    name: 'Database',
    status: 'healthy',
    responseTime: 12,
    lastCheck: new Date().toISOString(),
    description: 'PostgreSQL with connection pooling'
  },
  {
    name: 'Cache',
    status: 'healthy',
    responseTime: 2,
    lastCheck: new Date().toISOString(),
    description: 'Redis with 89% hit rate'
  },
  {
    name: 'Storage',
    status: 'healthy',
    responseTime: 45,
    lastCheck: new Date().toISOString(),
    description: 'Cloudflare R2 storage'
  },
  {
    name: 'Payment Gateway',
    status: 'healthy',
    responseTime: 180,
    lastCheck: new Date().toISOString(),
    description: 'Midtrans payment processing'
  }
];

// Generate sample real-time metrics
const realTimeMetrics = [
  { value: 45, trend: 'stable', status: 'healthy', previousValue: 47 },
  { value: 189, trend: 'down', status: 'healthy', previousValue: 192 },
  { value: 0.002, trend: 'down', status: 'healthy', previousValue: 0.003 },
  { value: 95, trend: 'up', status: 'healthy', previousValue: 92 }
];
---

<!-- Performance Dashboard Main Content -->
<div class="performance-dashboard" data-current-path={currentPath}>
  <!-- Dashboard Header -->
  <div class="dashboard-header">
    <div class="header-content">
      <div class="header-info">
        <h1 class="dashboard-title">
          <span class="title-icon">‚ö°</span>
          Performance Metrics
        </h1>
        <p class="dashboard-subtitle">
          Real-time monitoring and performance insights
        </p>
      </div>
      <div class="header-actions">
        <button class="refresh-btn glass-button" onclick="refreshPerformanceData()">
          <span class="refresh-icon">üîÑ</span>
          Refresh
        </button>
        <div class="last-updated">
          Last updated: <span id="lastUpdate">{new Date().toLocaleTimeString()}</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Overall Score Card -->
  <div class="overall-score-section">
    <Card class="score-card glass-card">
      <div class="score-content">
        <div class="score-main">
          <div class="score-value">
            {initialData?.overall?.score || 92}
            <span class="score-grade">{getScoreGrade(initialData?.overall?.score || 92).grade}</span>
          </div>
          <div class="score-info">
            <h3>Overall Performance Score</h3>
            <p class="score-description">
              {initialData?.overall?.status || 'Excellent'} operational performance
            </p>
          </div>
        </div>
        <div class="score-metrics">
          <div class="metric-item">
            <span class="metric-label">Bundle Size</span>
            <span class="metric-value">
              {formatBytes(initialData?.overall?.bundleSize || 189)}
            </span>
          </div>
          <div class="metric-item">
            <span class="metric-label">Response Time</span>
            <span class="metric-value">{initialData?.api?.averageResponseTime || 45}ms</span>
          </div>
          <div class="metric-item">
            <span class="metric-label">Error Rate</span>
            <span class="metric-value">
              {((initialData?.api?.errorRate || 0.002) * 100).toFixed(2)}%
            </span>
          </div>
        </div>
      </div>
      <div class="score-chart">
        <div class="circular-progress" style="--score: {initialData?.overall?.score || 92}">
          <svg viewBox="0 0 36 36" class="progress-svg">
            <path class="circle-bg"
              d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"
            />
            <path class="circle-progress"
              d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"
              stroke="var(--color-primary)"
              stroke-dasharray="{initialData?.overall?.score || 92}, 100"
            />
          </svg>
          <div class="progress-text">
            <span>{initialData?.overall?.score || 92}%</span>
          </div>
        </div>
      </div>
    </Card>
  </div>

  <!-- System Health Grid -->
  <div class="system-health-section">
    <div class="section-header">
      <h2 class="section-title">
        <span class="section-icon">üíö</span>
        System Health Status
      </h2>
      <div class="status-indicator">
        <span class="status-dot healthy"></span>
        All Systems Operational
      </div>
    </div>
    
    <div class="health-grid">
      {systemComponents.map((component) => (
        <Card class={`health-card ${component.status} glass-card`}>
          <div class="health-content">
            <div class="health-header">
              <div class="health-info">
                <h3 class="component-name">{component.name}</h3>
                <p class="component-description">{component.description}</p>
              </div>
              <div class="health-status">
                <span class={`status-dot ${component.status}`}></span>
                <span class="status-text">{component.status}</span>
              </div>
            </div>
            <div class="health-metrics">
              <div class="metric-row">
                <span class="metric-label">Response Time</span>
                <span class="metric-value">{component.responseTime}ms</span>
              </div>
              <div class="metric-row">
                <span class="metric-label">Last Check</span>
                <span class="metric-value">
                  {new Date(component.lastCheck).toLocaleTimeString()}
                </span>
              </div>
            </div>
          </div>
        </Card>
      ))}
    </div>
  </div>

  <!-- Real-time Metrics -->
  <div class="realtime-metrics-section">
    <div class="section-header">
      <h2 class="section-title">
        <span class="section-icon">üìä</span>
        Live Metrics
      </h2>
      <div class="live-indicator">
        <span class="live-dot"></span>
        LIVE
      </div>
    </div>

    <div class="metrics-grid">
      {realTimeMetrics.map((metric, index) => (
        <Card class="metric-card glass-card">
          <div class="metric-content">
            <div class="metric-header">
              <h4 class="metric-title">
                {index === 0 ? 'API Response Time' :
                 index === 1 ? 'Bundle Size' :
                 index === 2 ? 'Error Rate' : 'Health Score'}
              </h4>
              <div class="metric-trend">
                <span class="trend-icon">{getTrendIcon(metric.trend)}</span>
                <span class="trend-value">{metric.trend}</span>
              </div>
            </div>
            <div class="metric-value-large">
              {index === 2 ? 
                `${(metric.value * 100).toFixed(2)}%` : 
                metric.value + (index === 0 ? 'ms' : index === 1 ? 'KB' : '')}
            </div>
            <div class="metric-change">
              Previous: {index === 2 ? 
                `${(metric.previousValue * 100).toFixed(2)}%` : 
                metric.previousValue + (index === 0 ? 'ms' : index === 1 ? 'KB' : '')}
            </div>
          </div>
        </Card>
      ))}
    </div>
  </div>

  <!-- Alerts and Notifications -->
  <div class="alerts-section">
    <div class="section-header">
      <h2 class="section-title">
        <span class="section-icon">üîî</span>
        Recent Alerts
      </h2>
      <button class="view-all-btn glass-button" onclick="viewAllAlerts()">
        View All
      </button>
    </div>

    <Card class="alerts-card glass-card">
      <div class="alerts-content">
        <div class="alert-item success">
          <div class="alert-icon">‚úÖ</div>
          <div class="alert-content">
            <div class="alert-title">System Health Check Passed</div>
            <div class="alert-message">All components are functioning within normal parameters</div>
            <div class="alert-time">2 minutes ago</div>
          </div>
        </div>
        
        <div class="alert-item info">
          <div class="alert-icon">‚ÑπÔ∏è</div>
          <div class="alert-content">
            <div class="alert-title">Performance Optimization Applied</div>
            <div class="alert-message">Bundle size reduced by 3KB through code splitting</div>
            <div class="alert-time">15 minutes ago</div>
          </div>
        </div>
      </div>
    </Card>
  </div>
</div>

<script is:inline>
  // Performance Dashboard Client-Side Functionality
  let refreshInterval;
  let isRefreshing = false;

  // Auto-refresh every 30 seconds
  function startAutoRefresh() {
    refreshInterval = setInterval(refreshPerformanceData, 30000);
  }

  // Format bytes helper function
  function formatBytes(bytes) {
    if (bytes < 1024) return bytes + ' B';
    if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
    return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
  }

  // Refresh performance data
  async function refreshPerformanceData() {
    if (isRefreshing) return;
    
    isRefreshing = true;
    const refreshBtn = document.querySelector('.refresh-btn');
    const refreshIcon = document.querySelector('.refresh-icon');
    
    try {
      refreshBtn.classList.add('loading');
      if (refreshIcon) refreshIcon.style.transform = 'rotate(360deg)';
      
      const response = await fetch('/api/admin/performance?type=comprehensive');
      const data = await response.json();
      
      if (response.ok) {
        updateDashboardMetrics(data);
        updateLastUpdatedTime();
      }
    } catch (error) {
      console.error('Failed to refresh performance data:', error);
    } finally {
      isRefreshing = false;
      refreshBtn.classList.remove('loading');
      if (refreshIcon) refreshIcon.style.transform = 'rotate(0deg)';
    }
  }

  // Update dashboard metrics
  function updateDashboardMetrics(data) {
    // Update overall score
    const scoreValue = document.querySelector('.score-value');
    if (scoreValue && data.summary?.overallScore !== undefined) {
      scoreValue.firstChild.textContent = data.summary.overallScore;
    }

    // Update bundle size
    const bundleMetrics = document.querySelectorAll('.metric-item')[0]?.querySelector('.metric-value');
    if (bundleMetrics && data.summary?.bundleSize !== undefined) {
      bundleMetrics.textContent = formatBytes(data.summary.bundleSize);
    }

    // Add smooth transitions for value changes
    document.querySelectorAll('.metric-value-large').forEach((el) => {
      el.classList.add('updated');
      setTimeout(() => el.classList.remove('updated'), 1000);
    });
  }

  // Update last updated time
  function updateLastUpdatedTime() {
    const lastUpdate = document.getElementById('lastUpdate');
    if (lastUpdate) {
      lastUpdate.textContent = new Date().toLocaleTimeString();
    }
  }

  // View all alerts
  function viewAllAlerts() {
    window.location.href = '/dashboard/admin/alerts';
  }

  // Initialize dashboard when DOM is loaded
  document.addEventListener('DOMContentLoaded', () => {
    startAutoRefresh();
    
    // Add keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      if (e.key === 'r' && e.ctrlKey) {
        e.preventDefault();
        refreshPerformanceData();
      }
    });

    // Initialize tooltips and interactions
    initializeInteractions();
  });

  // Initialize interactive elements
  function initializeInteractions() {
    // Add hover effects to metric cards
    document.querySelectorAll('.metric-card, .health-card').forEach(card => {
      card.addEventListener('mouseenter', function() {
        this.style.transform = 'translateY(-2px)';
      });
      
      card.addEventListener('mouseleave', function() {
        this.style.transform = 'translateY(0)';
      });
    });

    // Add click to expand for charts
    document.querySelectorAll('.score-card').forEach(card => {
      card.addEventListener('click', function() {
        this.classList.toggle('expanded');
      });
    });
  }

  // Cleanup on page unload
  document.addEventListener('beforeunload', () => {
    if (refreshInterval) {
      clearInterval(refreshInterval);
    }
  });
</script>

<style>
  /* Performance Dashboard Styles */
  .performance-dashboard {
    max-width: 1200px;
    margin: 0 auto;
    padding: 2rem;
    
    --score: 92;
  }

  /* Glassmorphism Effects */
  .glass-card {
    background: rgba(255, 255, 255, 0.05);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.1);
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }

  .glass-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
  }

  .glass-button {
    background: rgba(99, 102, 241, 0.2);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(99, 102, 241, 0.3);
    color: var(--color-primary);
    padding: 0.5rem 1rem;
    border-radius: var(--radius-md);
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .glass-button:hover {
    background: rgba(99, 102, 241, 0.3);
    transform: translateY(-1px);
  }

  /* Header Styles */
  .dashboard-header {
    margin-bottom: 2rem;
  }

  .header-content {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 2rem;
  }

  .dashboard-title {
    font-size: 2rem;
    font-weight: 700;
    color: white;
    margin-bottom: 0.5rem;
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }

  .title-icon {
    font-size: 1.8rem;
  }

  .dashboard-subtitle {
    color: var(--color-text-muted);
    margin: 0;
  }

  .header-actions {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    gap: 0.5rem;
  }

  .refresh-btn {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .refresh-btn.loading {
    opacity: 0.7;
  }

  .refresh-icon {
    transition: transform 0.3s ease;
  }

  .last-updated {
    color: var(--color-text-muted);
    font-size: 0.875rem;
  }

  /* Overall Score Section */
  .overall-score-section {
    margin-bottom: 2rem;
  }

  .score-card {
    padding: 2rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 3rem;
  }

  .score-content {
    flex: 1;
  }

  .score-main {
    display: flex;
    align-items: center;
    gap: 2rem;
    margin-bottom: 2rem;
  }

  .score-value {
    font-size: 3.5rem;
    font-weight: 800;
    color: var(--color-primary);
    position: relative;
  }

  .score-grade {
    position: absolute;
    top: -10px;
    right: -30px;
    font-size: 0.875rem;
    background: var(--color-success);
    color: white;
    padding: 0.25rem 0.5rem;
    border-radius: 999px;
    font-weight: 600;
  }

  .score-info h3 {
    color: white;
    margin: 0 0 0.5rem 0;
    font-size: 1.5rem;
  }

  .score-description {
    color: var(--color-text-muted);
    margin: 0;
  }

  .score-metrics {
    display: flex;
    gap: 2rem;
  }

  .metric-item {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  }

  .metric-label {
    color: var(--color-text-muted);
    font-size: 0.875rem;
  }

  .metric-value {
    color: white;
    font-weight: 600;
  }

  /* Circular Progress */
  .score-chart {
    flex-shrink: 0;
  }

  .circular-progress {
    width: 120px;
    height: 120px;
    position: relative;
  }

  .progress-svg {
    width: 100%;
    height: 100%;
    transform: rotate(-90deg);
  }

  .circle-bg {
    fill: none;
    stroke: rgba(255, 255, 255, 0.1);
    stroke-width: 0.3;
  }

  .circle-progress {
    fill: none;
    stroke-width: 0.3;
    stroke-linecap: round;
    transition: stroke-dasharray 0.5s ease;
  }

  .progress-text {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    text-align: center;
  }

  .progress-text span {
    font-size: 1.5rem;
    font-weight: 700;
    color: white;
  }

  /* Section Headers */
  .section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
  }

  .section-title {
    color: white;
    font-size: 1.5rem;
    font-weight: 600;
    margin: 0;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .section-icon {
    font-size: 1.25rem;
  }

  .status-indicator,
  .live-indicator {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    color: var(--color-success);
    font-size: 0.875rem;
    font-weight: 500;
  }

  .status-dot,
  .live-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    animation: pulse 2s infinite;
  }

  .status-dot.healthy,
  .live-dot {
    background: var(--color-success);
  }

  .status-dot.warning {
    background: var(--color-secondary);
  }

  .status-dot.critical,
  .status-dot.down {
    background: var(--color-error);
  }

  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
  }

  /* System Health Grid */
  .health-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
  }

  .health-card {
    padding: 1.5rem;
  }

  .health-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 1rem;
  }

  .component-name {
    color: white;
    margin: 0 0 0.5rem 0;
    font-size: 1.125rem;
  }

  .component-description {
    color: var(--color-text-muted);
    font-size: 0.875rem;
    margin: 0;
  }

  .health-status {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .status-text {
    font-size: 0.875rem;
    text-transform: capitalize;
  }

  .health-metrics {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .metric-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  /* Real-time Metrics */
  .metrics-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
  }

  .metric-card {
    padding: 1.5rem;
    text-align: center;
  }

  .metric-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
  }

  .metric-title {
    color: var(--color-text-secondary);
    font-size: 0.875rem;
    font-weight: 500;
    margin: 0;
  }

  .metric-trend {
    display: flex;
    align-items: center;
    gap: 0.25rem;
  }

  .trend-icon {
    font-size: 0.875rem;
  }

  .trend-value {
    font-size: 0.75rem;
    color: var(--color-text-muted);
    text-transform: uppercase;
  }

  .metric-value-large {
    font-size: 2rem;
    font-weight: 700;
    color: white;
    margin-bottom: 0.5rem;
    transition: transform 0.3s ease;
  }

  .metric-value-large.updated {
    transform: scale(1.1);
  }

  .metric-change {
    color: var(--color-text-muted);
    font-size: 0.75rem;
  }

  /* Alerts Section */
  .alerts-section {
    margin-bottom: 2rem;
  }

  .alerts-card {
    padding: 1.5rem;
  }

  .alerts-content {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .alert-item {
    display: flex;
    gap: 1rem;
    padding: 1rem;
    border-radius: var(--radius-md);
    transition: background-color 0.2s ease;
  }

  .alert-item.success {
    background: rgba(16, 185, 129, 0.1);
    border-left: 3px solid var(--color-success);
  }

  .alert-item.info {
    background: rgba(99, 102, 241, 0.1);
    border-left: 3px solid var(--color-primary);
  }

  .alert-icon {
    font-size: 1.25rem;
    flex-shrink: 0;
  }

  .alert-content {
    flex: 1;
  }

  .alert-title {
    color: white;
    font-weight: 600;
    margin-bottom: 0.25rem;
  }

  .alert-message {
    color: var(--color-text-muted);
    font-size: 0.875rem;
    margin-bottom: 0.5rem;
  }

  .alert-time {
    color: var(--color-text-muted);
    font-size: 0.75rem;
  }

  /* Responsive Design */
  @media (max-width: 1024px) {
    .score-card {
      flex-direction: column;
      text-align: center;
      gap: 2rem;
    }

    .score-main {
      flex-direction: column;
      gap: 1rem;
    }

    .header-content {
      flex-direction: column;
      align-items: flex-start;
      gap: 1rem;
    }
  }

  @media (max-width: 768px) {
    .performance-dashboard {
      padding: 1rem;
    }

    .dashboard-title {
      font-size: 1.5rem;
    }

    .score-value {
      font-size: 2.5rem;
    }

    .score-metrics {
      flex-direction: column;
      gap: 1rem;
    }

    .health-grid {
      grid-template-columns: 1fr;
    }

    .metrics-grid {
      grid-template-columns: repeat(2, 1fr);
    }

    .section-header {
      flex-direction: column;
      align-items: flex-start;
      gap: 0.5rem;
    }
  }

  @media (max-width: 480px) {
    .metrics-grid {
      grid-template-columns: 1fr;
    }

    .alert-item {
      flex-direction: column;
      text-align: center;
    }
  }

  /* Loading and Transitions */
  .loading {
    opacity: 0.7;
    pointer-events: none;
  }
</style>